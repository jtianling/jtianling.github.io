---
layout: post
title: "通过全局变量和自擦除代码来防Dump"
categories:
- "未分类"
tags:
- "防Dump"
status: publish
type: post
published: true
meta:
  ratings_users: '0'
  ratings_score: '0'
  ratings_average: '0'
  views: '7'
author:
  login: jtianling
  email: jtianling@gmail.com
  display_name: jtianling
  first_name: ''
  last_name: ''
---
<br />
<h1 style="margin: 24pt 0cm 0pt;"><span style="color: #365f91;"><span style="font-family: 宋体; mso-ascii-font-family: Cambria; mso-ascii-theme-font: major-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: major-fareast; mso-hansi-font-family: Cambria; mso-hansi-theme-font: major-latin;">通过全局变量和自擦除代码来防</span><span lang="EN-US"><span style="font-family: Cambria;">Dump </span></span></span></h1>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt; text-align: right;" align="right"><span lang="EN-US"><a href="http://www.jtianling.com"><span style="font-size: small;"><span style="color: #800080;"><strong><span style="letter-spacing: 0.25pt; font-variant: small-caps;"><span style="font-family: Calibri;">write by </span></span></strong><strong><span style="font-family: 宋体; letter-spacing: 0.25pt; font-variant: small-caps;">九天雁翎</span><span style="letter-spacing: 0.25pt; font-variant: small-caps;"><span style="font-family: Calibri;">(JTianLing) -- www.jtianling.com</span></span></strong></span></span></a></span><strong><span style="text-decoration: underline;"><span style="color: #c0504d; letter-spacing: 0.25pt; font-variant: small-caps; mso-themecolor: accent2; mso-fareast-language: ZH-CN;" lang="EN-US"></span></span></strong></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt; text-align: right;" align="right"><span lang="EN-US"><a href="ttp://groups.google.com/group/jiutianfile/"><strong><span style="font-family: 宋体; letter-spacing: 0.25pt; font-variant: small-caps; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin; mso-fareast-language: ZH-CN;" lang="EN-US"><span lang="EN-US"><span style="font-size: small;">讨论新闻组及文件</span></span></span></strong></a></span><span style="mso-fareast-language: ZH-CN;" lang="EN-US"></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt;"><span style="font-size: small;"><span style="font-family: 宋体; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA;">一般而言，你的程序一旦运行起来就没有办法防止</span><span style="mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA;" lang="EN-US"><span style="font-family: Calibri;">Dump</span></span><span style="font-family: 宋体; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA;">了，因为所有的数据都在内存中了，而且，为了更好的</span><span style="mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA;" lang="EN-US"><span style="font-family: Calibri;">Dump</span></span><span style="font-family: 宋体; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA;">完整程序，程序将要启动，还未启动时的</span><span style="mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA;" lang="EN-US"><span style="font-family: Calibri;">Dump</span></span><span style="font-family: 宋体; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA;">，任你程序中有多少防</span><span style="mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA;" lang="EN-US"><span style="font-family: Calibri;">Dump</span></span><span style="font-family: 宋体; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA;">的方法都没有用。这里只能结合两种方式来实现反</span><span style="mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA;" lang="EN-US"><span style="font-family: Calibri;">Dump</span></span><span style="font-family: 宋体; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA;">，其一，程序运行的时候其本身数据并不是完整的，以前我已经讲过方法了，</span><span style="mso-fareast-language: ZH-CN; mso-font-kerning: 18.0pt;" lang="EN-US"><span style="font-family: Calibri;">&nbsp;</span></span><span style="font-family: 宋体; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin; mso-fareast-language: ZH-CN; mso-font-kerning: 18.0pt;">《</span><span style="mso-font-kerning: 18.0pt;" lang="EN-US"><a href="http://www.jtianling.com/archive/2009/02/06/3866949.aspx"><span style="color: #770000; font-family: 宋体; text-decoration: none; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin; mso-fareast-language: ZH-CN; text-underline: none;" lang="EN-US"><span lang="EN-US">让</span></span><span style="color: #770000; text-decoration: none; mso-fareast-language: ZH-CN; text-underline: none;"><span style="font-family: Calibri;">EXE</span></span><span style="color: #770000; font-family: 宋体; text-decoration: none; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin; mso-fareast-language: ZH-CN; text-underline: none;" lang="EN-US"><span lang="EN-US">文件不能直接启动的方法以防止直接调试的方法</span></span></a></span><span style="font-family: 宋体; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin; mso-fareast-language: ZH-CN; mso-font-kerning: 18.0pt;">》，只要多用几次这样的方法，比如启动代码无效，中间某段代码也无效，然后通过与启动程序的交互来完成中间代码的修改，只在启动程序通知后才继续运行，以防止错误。这样就没有办法通过在文中介绍的启动时</span><span style="mso-fareast-language: ZH-CN; mso-font-kerning: 18.0pt;" lang="EN-US"><span style="font-family: Calibri;">Dump</span></span><span style="font-family: 宋体; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin; mso-fareast-language: ZH-CN; mso-font-kerning: 18.0pt;">来</span><span style="mso-fareast-language: ZH-CN; mso-font-kerning: 18.0pt;" lang="EN-US"><span style="font-family: Calibri;">Dump</span></span><span style="font-family: 宋体; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin; mso-fareast-language: ZH-CN; mso-font-kerning: 18.0pt;">数据了。对于</span><span style="mso-fareast-language: ZH-CN; mso-font-kerning: 18.0pt;" lang="EN-US"><span style="font-family: Calibri;">Dump</span></span><span style="font-family: 宋体; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin; mso-fareast-language: ZH-CN; mso-font-kerning: 18.0pt;">的作用还不理解的，可以去使用一下</span><span style="mso-fareast-language: ZH-CN; mso-font-kerning: 18.0pt;" lang="EN-US"><span style="font-family: Calibri;">LordPE</span></span><span style="font-family: 宋体; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin; mso-fareast-language: ZH-CN; mso-font-kerning: 18.0pt;">的</span><span style="mso-fareast-language: ZH-CN; mso-font-kerning: 18.0pt;" lang="EN-US"><span style="font-family: Calibri;">Dump</span></span><span style="font-family: 宋体; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin; mso-fareast-language: ZH-CN; mso-font-kerning: 18.0pt;">功能，保证你能够见识到工具的作用性如此之大，并认识到自己程序多么的脆弱。</span><span style="mso-fareast-language: ZH-CN; mso-font-kerning: 18.0pt;" lang="EN-US"></span></span></p>
<h2 style="margin: 13pt 0cm;"><span style="font-size: large;"><span style="font-family: 宋体; mso-ascii-font-family: Cambria; mso-ascii-theme-font: major-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: major-fareast; mso-hansi-font-family: Cambria; mso-hansi-theme-font: major-latin; mso-fareast-language: ZH-CN;">通过全局变量防</span><span style="font-family: Cambria;"><span style="mso-fareast-language: ZH-CN;" lang="EN-US">Dump</span><span style="mso-fareast-language: ZH-CN; mso-font-kerning: 18.0pt;" lang="EN-US"></span></span></span></h2>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt;"><span style="font-size: small;"><span style="font-family: 宋体; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin; mso-fareast-language: ZH-CN; mso-font-kerning: 18.0pt;">但是这种方法有个缺陷是，程序一旦运行起来，所有代码段的数据都是正确的了，还是可以</span><span style="mso-fareast-language: ZH-CN; mso-font-kerning: 18.0pt;" lang="EN-US"><span style="font-family: Calibri;">Dump</span></span><span style="font-family: 宋体; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin; mso-fareast-language: ZH-CN; mso-font-kerning: 18.0pt;">出来，有种方式是用某个全局变量来指示是否是</span><span style="mso-fareast-language: ZH-CN; mso-font-kerning: 18.0pt;" lang="EN-US"><span style="font-family: Calibri;">Dump</span></span><span style="font-family: 宋体; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin; mso-fareast-language: ZH-CN; mso-font-kerning: 18.0pt;">出来的数据或者是正常运行的数据。</span><span style="mso-fareast-language: ZH-CN; mso-font-kerning: 18.0pt;" lang="EN-US"></span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt;"><span style="font-size: small;"><span style="font-family: 宋体; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin; mso-fareast-language: ZH-CN; mso-font-kerning: 18.0pt;">这里介绍一下：</span><span style="mso-fareast-language: ZH-CN;" lang="EN-US"></span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt;"><span style='color: #804040; font-family: "Courier New";' lang="EN-US"><span style="font-size: small;">&nbsp;1 </span></span><span style='font-family: "Courier New";' lang="EN-US"><br /><span style="font-size: small;"><span style="color: #804040;">&nbsp;2 </span><span style="color: blue;">#include "stdafx.h"</span><br /><span style="color: #804040;">&nbsp;3 </span><span style="color: blue;">#include "windows.h"</span><br /><span style="color: #804040;">&nbsp;4 </span><span style="color: blue;">#include "tchar.h"</span><br /><span style="color: #804040;">&nbsp;5 </span><br /><span style="color: #804040;">&nbsp;6 </span>bool gbDumped = false;<br /><span style="color: #804040;">&nbsp;7 </span><br /><span style="color: #804040;">&nbsp;8 </span>int main(int argc, char* argv[])<br /><span style="color: #804040;">&nbsp;9 </span>{<br /><span style="color: #804040;">10 </span>&nbsp;&nbsp;&nbsp;&nbsp;if(!gbDumped)<br /><span style="color: #804040;">11 </span>&nbsp;&nbsp;&nbsp;&nbsp;{<br /><span style="color: #804040;">12 </span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gbDumped = true;<br /><span style="color: #804040;">13 </span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageBox(NULL, _T(<span style="color: fuchsia;">"Right"</span>), _T(<span style="color: fuchsia;">"Hello World"</span>), MB_OK);<br /><span style="color: #804040;">14 </span>&nbsp;&nbsp;&nbsp;&nbsp;}<br /><span style="color: #804040;">15 </span>&nbsp;&nbsp;&nbsp;&nbsp;else<br /><span style="color: #804040;">16 </span>&nbsp;&nbsp;&nbsp;&nbsp;{<br /><span style="color: #804040;">17 </span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageBox(NULL, _T(<span style="color: fuchsia;">"Dumped me?!"</span>), _T(<span style="color: fuchsia;">"Find you Dumped me!!"</span>), MB_OK);<br /><span style="color: #804040;">18 </span>&nbsp;&nbsp;&nbsp;&nbsp;}<br /><span style="color: #804040;">19 </span>&nbsp;&nbsp;&nbsp;&nbsp;return 0;<br /><span style="color: #804040;">20 </span>}<br /><span style="color: #804040;">21</span></span></span><span style='color: #a020f0; font-family: "Courier New"; mso-fareast-language: ZH-CN;' lang="EN-US"></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt;"><span style='color: #a020f0; font-family: "Courier New"; mso-fareast-language: ZH-CN;' lang="EN-US"><span style="font-size: small;">&nbsp;</span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt;"><span style="font-size: small;"><span style="font-family: 宋体; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin; mso-fareast-language: ZH-CN;">这样只要实在你弹出了对话框后</span><span style="mso-fareast-language: ZH-CN;" lang="EN-US"><span style="font-family: Calibri;">Dump</span></span><span style="font-family: 宋体; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin; mso-fareast-language: ZH-CN;">出来的程序其实就是不对的程序，虽然逻辑上将，应该会弹出另外一个对话框，但是实际上对于这样正常流程根本不会走到的地方甚至有可能被编译器所优化，然后导致</span><span style="mso-fareast-language: ZH-CN;" lang="EN-US"><span style="font-family: Calibri;">Dump</span></span><span style="font-family: 宋体; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin; mso-fareast-language: ZH-CN;">出来的程序直接崩溃</span><span style="color: #a020f0; font-family: 宋体; mso-ascii-font-family: 'Courier New'; mso-fareast-font-family: 宋体; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: 'Courier New'; mso-fareast-language: ZH-CN; mso-bidi-font-family: 'Courier New';">。</span><span style="font-family: 宋体; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin;" lang="EN-US">但是这样的程序可以被跟踪调试，通过找到全局变量并修改实在不是什么很难的问题。</span><span style="mso-fareast-language: ZH-CN;" lang="EN-US"></span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt;"><span style="font-size: small;"><span style="font-family: 宋体; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin; mso-fareast-language: ZH-CN;">下面再将一个稍微复杂一点的办法，让代码一旦运行起来，程序代码段就被破坏，那么这样运行时的</span><span style="mso-fareast-language: ZH-CN;" lang="EN-US"><span style="font-family: Calibri;">Dump</span></span><span style="font-family: 宋体; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin; mso-fareast-language: ZH-CN;">也就更加无效了，并且此种方法还可以防止调试。因为完整的程序已经不存在了。</span><span style="mso-fareast-language: ZH-CN;" lang="EN-US"></span></span></p>
<h2 style="margin: 13pt 0cm;"><span style="font-size: large;"><span style="font-family: 宋体; mso-ascii-font-family: Cambria; mso-ascii-theme-font: major-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: major-fareast; mso-hansi-font-family: Cambria; mso-hansi-theme-font: major-latin; mso-fareast-language: ZH-CN;">通过自擦除代码来防</span><span style="mso-fareast-language: ZH-CN;" lang="EN-US"><span style="font-family: Cambria;">Dump</span></span></span></h2>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt;"><span style="font-size: small;"><span style="font-family: 宋体; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin; mso-fareast-language: ZH-CN;">原理上也很简单，对于那些只会运行一次的代码，直接在运行后将自己在代码段的内容擦除，可以写入任意值来迷惑调试者，效果更佳。</span><span style="mso-fareast-language: ZH-CN;" lang="EN-US"></span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt;"><span style="font-size: small;"><span style="font-family: 宋体; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin; mso-fareast-language: ZH-CN;">源代码：</span><span style="mso-fareast-language: ZH-CN;" lang="EN-US"></span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt;"><span style="font-size: small;"><span style='color: #804040; font-family: "Courier New";' lang="EN-US">&nbsp;1 </span><span style='color: #a020f0; font-family: "Courier New";' lang="EN-US">#include </span><span style='color: fuchsia; font-family: "Courier New";' lang="EN-US">"windows.h"</span></span><span style='font-family: "Courier New";' lang="EN-US"><br /><span style="font-size: small;"><span style="color: #804040;">&nbsp;2 </span><span style="color: #a020f0;">#include </span><span style="color: fuchsia;">"tchar.h"</span><br /><span style="color: #804040;">&nbsp;3 </span><br /><span style="color: #804040;">&nbsp;4 </span><strong><span style="color: seagreen;">void</span></strong>&nbsp;Run()<br /><span style="color: #804040;">&nbsp;5 </span>{<br /><span style="color: #804040;">&nbsp;6 </span>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: blue;">// begin of the func</span><br /><span style="color: #804040;">&nbsp;7 </span>&nbsp;&nbsp;&nbsp;&nbsp;DWORD ldwBegin = <span style="color: fuchsia;">0</span>;<br /><span style="color: #804040;">&nbsp;8 </span>&nbsp;&nbsp;&nbsp;&nbsp;__asm<br /><span style="color: #804040;">&nbsp;9 </span>&nbsp;&nbsp;&nbsp;&nbsp;{<br /><span style="color: #804040;">10 </span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;call $+<span style="color: fuchsia;">5</span><br /><span style="color: #804040;">11 </span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pop eax<br /><span style="color: #804040;">12 </span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov ldwBegin, eax<br /><span style="color: #804040;">13 </span>&nbsp;&nbsp;&nbsp;&nbsp;}<br /><span style="color: #804040;">14 </span>&nbsp;&nbsp;&nbsp;&nbsp;DWORD ldwOldPro = <span style="color: fuchsia;">0</span>;<br /><span style="color: #804040;">15 </span>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: blue;">// Must have this step</span><br /><span style="color: #804040;">16 </span>&nbsp;&nbsp;&nbsp;&nbsp;<strong><span style="color: #804040;">if</span></strong>(!VirtualProtect((<strong><span style="color: seagreen;">void</span></strong>*)<span style="color: fuchsia;">0x401000</span>, <span style="color: fuchsia;">1000</span>, PAGE_EXECUTE_READWRITE, &amp;ldwOldPro))<br /><span style="color: #804040;">17 </span>&nbsp;&nbsp;&nbsp;&nbsp;{<br /><span style="color: #804040;">18 </span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf( <span style="color: fuchsia;">"VirtualProtectEx failed (</span><span style="color: slateblue;">%d</span><span style="color: fuchsia;">).</span><span style="color: slateblue;">/n</span><span style="color: fuchsia;">"</span>, GetLastError() );<br /><span style="color: #804040;">19 </span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong><span style="color: #804040;">return</span></strong>;<br /><span style="color: #804040;">20 </span>&nbsp;&nbsp;&nbsp;&nbsp;}<br /><span style="color: #804040;">21 </span><br /><span style="color: #804040;">22 </span>&nbsp;&nbsp;&nbsp;&nbsp;MessageBox(<span style="color: fuchsia;">NULL</span>, _T(<span style="color: fuchsia;">"Right"</span>), _T(<span style="color: fuchsia;">"Hello World"</span>), MB_OK);<br /><span style="color: #804040;">23 </span><br /><span style="color: #804040;">24 </span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: blue;">// begin of the func</span><br /><span style="color: #804040;">25 </span>&nbsp;&nbsp;&nbsp;&nbsp;DWORD ldwEnd = <span style="color: fuchsia;">0</span>;<br /><span style="color: #804040;">26 </span>&nbsp;&nbsp;&nbsp;&nbsp;__asm<br /><span style="color: #804040;">27 </span>&nbsp;&nbsp;&nbsp;&nbsp;{<br /><span style="color: #804040;">28 </span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;call $+<span style="color: fuchsia;">5</span><br /><span style="color: #804040;">29 </span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pop eax<br /><span style="color: #804040;">30 </span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov ldwEnd, eax<br /><span style="color: #804040;">31 </span>&nbsp;&nbsp;&nbsp;&nbsp;}<br /><span style="color: #804040;">32 </span><br /><span style="color: #804040;">33 </span>&nbsp;&nbsp;&nbsp;&nbsp;DWORD ldwFuncLen = ldwEnd - ldwBegin;<br /><span style="color: #804040;">34 </span>&nbsp;&nbsp;&nbsp;&nbsp;BYTE *lpbyRand = <strong><span style="color: #804040;">new</span></strong>&nbsp;BYTE[ldwFuncLen];<br /><span style="color: #804040;">35 </span><br /><span style="color: #804040;">36 </span>&nbsp;&nbsp;&nbsp;&nbsp;DWORD ldwWritten = <span style="color: fuchsia;">0</span>;<br /><span style="color: #804040;">37 </span>&nbsp;&nbsp;&nbsp;&nbsp;<strong><span style="color: #804040;">if</span></strong>(!WriteProcessMemory(GetCurrentProcess(), (<strong><span style="color: seagreen;">void</span></strong>*)ldwBegin, lpbyRand, ldwFuncLen, &amp;ldwWritten))<br /><span style="color: #804040;">38 </span>&nbsp;&nbsp;&nbsp;&nbsp;{<br /><span style="color: #804040;">39 </span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf( <span style="color: fuchsia;">"WriteProcessMemory failed (</span><span style="color: slateblue;">%d</span><span style="color: fuchsia;">).</span><span style="color: slateblue;">/n</span><span style="color: fuchsia;">"</span>, GetLastError() );<br /><span style="color: #804040;">40 </span>&nbsp;&nbsp;&nbsp;&nbsp;}<br /><span style="color: #804040;">41 </span>&nbsp;&nbsp;&nbsp;&nbsp;<strong><span style="color: #804040;">delete</span></strong>[] lpbyRand;<br /><span style="color: #804040;">42 </span>}<br /><span style="color: #804040;">43 </span><br /><span style="color: #804040;">44 </span><strong><span style="color: seagreen;">int</span></strong>&nbsp;main(<strong><span style="color: seagreen;">int</span></strong>&nbsp;argc, <strong><span style="color: seagreen;">char</span></strong>* argv[])<br /><span style="color: #804040;">45 </span>{<br /><span style="color: #804040;">46 </span>&nbsp;&nbsp;&nbsp;&nbsp;Run();<br /><span style="color: #804040;">47 </span>&nbsp;&nbsp;&nbsp;&nbsp;MessageBox(<span style="color: fuchsia;">NULL</span>, _T(<span style="color: fuchsia;">"OK"</span>), _T(<span style="color: fuchsia;">"OK"</span>), MB_OK);<br /><span style="color: #804040;">48 </span><br /><span style="color: #804040;">49 </span>&nbsp;&nbsp;&nbsp;&nbsp;<strong><span style="color: #804040;">return</span></strong>&nbsp;<span style="color: fuchsia;">0</span>;<br /><span style="color: #804040;">50 </span>}</span></span><span style="mso-fareast-language: ZH-CN;" lang="EN-US"></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt;"><span style="mso-fareast-language: ZH-CN;" lang="EN-US"><span style="font-size: small; font-family: Calibri;">&nbsp;</span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt;"><span style="font-size: small;"><span style="font-family: 宋体; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin; mso-fareast-language: ZH-CN;">以上代码，在弹出</span><span style="mso-fareast-language: ZH-CN;" lang="EN-US"><span style="font-family: Calibri;">OK</span></span><span style="font-family: 宋体; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin; mso-fareast-language: ZH-CN;">后再</span><span style="mso-fareast-language: ZH-CN;" lang="EN-US"><span style="font-family: Calibri;">Dump</span></span><span style="font-family: 宋体; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin; mso-fareast-language: ZH-CN;">，下次再进入</span><span style="mso-fareast-language: ZH-CN;" lang="EN-US"><span style="font-family: Calibri;">Run</span></span><span style="font-family: 宋体; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin; mso-fareast-language: ZH-CN;">函数会直接报错，因为后来添进去的其实是堆上的随机数值。</span><span style="mso-fareast-language: ZH-CN;" lang="EN-US"></span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt;"><span style="font-size: small;"><span style="font-family: 宋体; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin; mso-fareast-language: ZH-CN;">这里需要说明的是</span><span style="mso-fareast-language: ZH-CN;" lang="EN-US"></span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt;"><span style="font-size: small;"><span style='font-family: "Courier New";' lang="EN-US">call $+<span style="color: fuchsia;">5</span><br />pop eax</span><span style='font-family: "Courier New"; mso-fareast-language: ZH-CN;' lang="EN-US"></span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt;"><span style="font-size: small;"><span style="font-family: 宋体; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin; mso-fareast-language: ZH-CN;">两句内嵌代码的含义是获取当前的</span><span style="mso-fareast-language: ZH-CN;" lang="EN-US"><span style="font-family: Calibri;">EIP,</span></span><span style="font-family: 宋体; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin; mso-fareast-language: ZH-CN;">这在壳中用的非常多，我在这里套用了一下。这样</span><span style="mso-fareast-language: ZH-CN;" lang="EN-US"><span style="font-family: Calibri;">ldwBegin</span></span><span style="font-family: 宋体; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin; mso-fareast-language: ZH-CN;">就是</span><span style="mso-fareast-language: ZH-CN;" lang="EN-US"><span style="font-family: Calibri;">Run</span></span><span style="font-family: 宋体; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin; mso-fareast-language: ZH-CN;">函数的开始</span><span style="mso-fareast-language: ZH-CN;" lang="EN-US"><span style="font-family: Calibri;">EIP,ldwEnd</span></span><span style="font-family: 宋体; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin; mso-fareast-language: ZH-CN;">虽然不是函数结束的</span><span style="mso-fareast-language: ZH-CN;" lang="EN-US"><span style="font-family: Calibri;">EIP</span></span><span style="font-family: 宋体; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin; mso-fareast-language: ZH-CN;">，但是主体部分已经包括在内了，</span><span style="font-family: Calibri;"> </span><span style="font-family: 宋体; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin;" lang="EN-US">达到这样的效果就足够了。</span><span style="mso-fareast-language: ZH-CN;" lang="EN-US"></span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt;"><span style="font-size: small;"><span style="font-family: 宋体; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin; mso-fareast-language: ZH-CN;">通过上面的两种方式基本上可以预防住运行时的一次性</span><span style="mso-fareast-language: ZH-CN;" lang="EN-US"><span style="font-family: Calibri;">Dump</span></span><span style="font-family: 宋体; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin; mso-fareast-language: ZH-CN;">，而且可以将上述方式扩展，将多段擦除，结合以前讲的方式，将多段代码由启动程序来写入，这样无论是启动时的</span><span style="mso-fareast-language: ZH-CN;" lang="EN-US"><span style="font-family: Calibri;">Dump</span></span><span style="font-family: 宋体; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin; mso-fareast-language: ZH-CN;">，还是运行时的</span><span style="mso-fareast-language: ZH-CN;" lang="EN-US"><span style="font-family: Calibri;">Dump</span></span><span style="font-family: 宋体; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin; mso-fareast-language: ZH-CN;">都不能获取到正确的内容了。</span><span style="mso-fareast-language: ZH-CN;" lang="EN-US"></span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt;"><span style="font-size: small;"><span style="font-family: 宋体; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin; mso-fareast-language: ZH-CN;">但是破解方式还是有的，比如这种方式，只需要跟踪调试程序，绕过</span><span style="mso-fareast-language: ZH-CN;" lang="EN-US"><span style="font-family: Calibri;">WriteProcessMemroy</span></span><span style="font-family: 宋体; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin; mso-fareast-language: ZH-CN;">函数的调用就可以了，或者直接一点，直接将此</span><span style="mso-fareast-language: ZH-CN;" lang="EN-US"><span style="font-family: Calibri;">API</span></span><span style="font-family: 宋体; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin; mso-fareast-language: ZH-CN;">函数挂接上并使其无效，无论多少此的自擦除都会无效。</span><span style="mso-fareast-language: ZH-CN;" lang="EN-US"></span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt;"><span style="color: #a020f0; mso-fareast-language: ZH-CN;" lang="EN-US"><span style="font-size: small; font-family: Calibri;">&nbsp;</span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt;"><span style='color: #a020f0; font-family: "Courier New"; mso-fareast-language: ZH-CN;' lang="EN-US"><span style="font-size: small;">&nbsp;</span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt; text-align: right;" align="right"><span lang="EN-US"><a href="http://www.jtianling.com"><span style="font-size: small;"><span style="color: #800080;"><strong><span style="letter-spacing: 0.25pt; font-variant: small-caps; mso-fareast-language: ZH-CN;"><span style="font-family: Calibri;">write by </span></span></strong><strong><span style="font-family: 宋体; letter-spacing: 0.25pt; font-variant: small-caps; mso-fareast-language: ZH-CN;" lang="EN-US"><span lang="EN-US">九天雁翎</span></span></strong><strong><span style="letter-spacing: 0.25pt; font-variant: small-caps; mso-fareast-language: ZH-CN;"><span style="font-family: Calibri;">(JTianLing) -- www.jtianling.com</span></span></strong></span></span></a></span><span style="mso-fareast-language: ZH-CN;" lang="EN-US"></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt;"><span style="mso-fareast-language: ZH-CN;" lang="EN-US"><span style="font-size: small; font-family: Calibri;">&nbsp;</span></span></p>
