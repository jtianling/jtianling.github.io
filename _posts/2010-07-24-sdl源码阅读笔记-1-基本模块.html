---
layout: post
title: SDL源码阅读笔记（1） 基本模块
categories:
- "图形技术"
tags:
- SDL
status: publish
type: post
published: true
meta:
  ratings_users: '0'
  ratings_score: '0'
  ratings_average: '0'
  views: '18'
author:
  login: jtianling
  email: jtianling@gmail.com
  display_name: jtianling
  first_name: ''
  last_name: ''
---

<p style="margin:1em 0px 0.5em;text-align:right"><strong><a style="color:#006bad;text-decoration:none" href="http://www.jtianling.com">write by 九天雁翎(JTianLing) -- www.jtianling.com</a><br />
</strong></p>
<p style="margin:1em 0px 0.5em;text-align:right"><a style="color:#770000;text-decoration:none" href="http://groups.google.com/group/jiutianfile/"><strong>讨论新闻组及文件</strong><br />
</a></p>
<h2><span style="font-family: 宋体;">前言</span><br />
</h2>
<p>&nbsp;&nbsp; &nbsp;对于大牛来说，写关于阅读源码的文章都会叫源码剖析或者深入浅出啥的，对于我，自己阅读阅读源码，写一些自己的阅读笔记吧。</p>
<p>&nbsp;&nbsp; &nbsp;SDL<span style="font-family: 宋体;">我就不多介绍了，很多使用过的人都说很好，我自己实际使用的感觉</span><br />
SDL<span style="font-family: 宋体;">也是非常成熟易用，绝对对得起其</span><br />
simple<span style="font-family: 宋体;">两字。</span></p>
<p>&nbsp;</p>
<h2><span style="font-family: 宋体;">基本模块</span><br />
</h2>
<p>通过SDL.h中看到SDL作者对SDL进行的划分，可以看出SDL大概包含的内容：</p>
<p style="text-align:left" align="left"><span style="font-family: fixedsys;"><span style="color: #0000ff;"><span style="font-size: small;">#include</span><br />
</span><br />
</span><br />
<span style="font-family: fixedsys;"><span style="font-size: small;"> <span style="color: #a31515;">&quot;SDL_main.h&quot;</span><br />
</span><br />
</span></p>
<p style="text-align:left" align="left"><span style="font-family: fixedsys;"><span style="color: #0000ff;"><span style="font-size: small;">#include</span><br />
</span><br />
</span><br />
<span style="font-family: fixedsys;"><span style="font-size: small;"> <span style="color: #a31515;">&quot;SDL_stdinc.h&quot;</span><br />
</span><br />
</span></p>
<p style="text-align:left" align="left"><span style="font-family: fixedsys;"><span style="color: #0000ff;"><span style="font-size: small;">#include</span><br />
</span><br />
</span><br />
<span style="font-family: fixedsys;"><span style="font-size: small;"> <span style="color: #a31515;">&quot;SDL_audio.h&quot;&nbsp;&nbsp; // </span><br />
</span><br />
</span><br />
<span style="font-family: fixedsys;"><span style="color: #a31515;"><span style="font-size: small;">声音</span><br />
</span><br />
</span></p>
<p style="text-align:left" align="left"><span style="font-family: fixedsys;"><span style="color: #0000ff;"><span style="font-size: small;">#include</span><br />
</span><br />
</span><br />
<span style="font-family: fixedsys;"><span style="font-size: small;"> <span style="color: #a31515;">&quot;SDL_cdrom.h&quot;</span><br />
</span><br />
</span></p>
<p style="text-align:left" align="left"><span style="font-family: fixedsys;"><span style="color: #0000ff;"><span style="font-size: small;">#include</span><br />
</span><br />
</span><br />
<span style="font-family: fixedsys;"><span style="font-size: small;"> <span style="color: #a31515;">&quot;SDL_cpuinfo.h&quot;</span><br />
</span><br />
</span></p>
<p style="text-align:left" align="left"><span style="font-family: fixedsys;"><span style="color: #0000ff;"><span style="font-size: small;">#include</span><br />
</span><br />
</span><br />
<span style="font-family: fixedsys;"><span style="font-size: small;"> <span style="color: #a31515;">&quot;SDL_endian.h&quot;</span><br />
</span><br />
</span></p>
<p style="text-align:left" align="left"><span style="font-family: fixedsys;"><span style="color: #0000ff;"><span style="font-size: small;">#include</span><br />
</span><br />
</span><br />
<span style="font-family: fixedsys;"><span style="font-size: small;"> <span style="color: #a31515;">&quot;SDL_error.h&quot;</span><br />
</span><br />
</span></p>
<p style="text-align:left" align="left"><span style="font-family: fixedsys;"><span style="color: #0000ff;"><span style="font-size: small;">#include</span><br />
</span><br />
</span><br />
<span style="font-family: fixedsys;"><span style="font-size: small;"> <span style="color: #a31515;">&quot;SDL_events.h&quot;</span><br />
</span><br />
</span></p>
<p style="text-align:left" align="left"><span style="font-family: fixedsys;"><span style="color: #0000ff;"><span style="font-size: small;">#include</span><br />
</span><br />
</span><br />
<span style="font-family: fixedsys;"><span style="font-size: small;"> <span style="color: #a31515;">&quot;SDL_loadso.h&quot;&nbsp; // Unix/Linux </span><br />
</span><br />
</span><br />
<span style="font-family: fixedsys;"><span style="color: #a31515;"><span style="font-size: small;">动态库</span><br />
</span><br />
</span></p>
<p style="text-align:left" align="left"><span style="font-family: fixedsys;"><span style="color: #0000ff;"><span style="font-size: small;">#include</span><br />
</span><br />
</span><br />
<span style="font-family: fixedsys;"><span style="font-size: small;"> <span style="color: #a31515;">&quot;SDL_mutex.h&quot;&nbsp;&nbsp; // </span><br />
</span><br />
</span><br />
<span style="font-family: fixedsys;"><span style="color: #a31515;"><span style="font-size: small;">多线程互斥量</span><br />
</span><br />
</span></p>
<p style="text-align:left" align="left"><span style="font-family: fixedsys;"><span style="color: #0000ff;"><span style="font-size: small;">#include</span><br />
</span><br />
</span><br />
<span style="font-family: fixedsys;"><span style="font-size: small;"> <span style="color: #a31515;">&quot;SDL_rwops.h&quot;</span><br />
</span><br />
</span></p>
<p style="text-align:left" align="left"><span style="font-family: fixedsys;"><span style="color: #0000ff;"><span style="font-size: small;">#include</span><br />
</span><br />
</span><br />
<span style="font-family: fixedsys;"><span style="font-size: small;"> <span style="color: #a31515;">&quot;SDL_thread.h&quot;&nbsp; // </span><br />
</span><br />
</span><br />
<span style="font-family: fixedsys;"><span style="color: #a31515;"><span style="font-size: small;">多线程</span><br />
</span><br />
</span></p>
<p style="text-align:left" align="left"><span style="font-family: fixedsys;"><span style="color: #0000ff;"><span style="font-size: small;">#include</span><br />
</span><br />
</span><br />
<span style="font-family: fixedsys;"><span style="font-size: small;"> <span style="color: #a31515;">&quot;SDL_timer.h&quot;&nbsp;&nbsp; // </span><br />
</span><br />
</span><br />
<span style="font-family: fixedsys;"><span style="color: #a31515;"><span style="font-size: small;">计时器</span><br />
</span><br />
</span></p>
<p style="text-align:left" align="left"><span style="font-family: fixedsys;"><span style="color: #0000ff;"><span style="font-size: small;">#include</span><br />
</span><br />
</span><br />
<span style="font-family: fixedsys;"><span style="font-size: small;"> <span style="color: #a31515;">&quot;SDL_video.h&quot;&nbsp;&nbsp; // video</span><br />
</span><br />
</span><br />
<span style="font-family: fixedsys;"><span style="color: #a31515;"><span style="font-size: small;">模块 </span><br />
</span><br />
</span></p>
<p><span style="font-family: fixedsys;"><span style="color: #0000ff;"><span style="font-size: small;">#include</span><br />
</span><br />
</span><br />
<span style="font-family: fixedsys;"><span style="font-size: small;"> <span style="color: #a31515;">&quot;SDL_version.h&quot;</span><br />
</span><br />
</span></p>
<p>&nbsp;</p>
<p>
有声音模块，cdrom模块，有事件模块，多线程模块，计时器模块，video模块等6大模块。</p>
<p>&nbsp;</p>
<p>SDL_InitSubSystem的参数，可以看出SDL的作者将SDL划分为下列可选子系统：</p>
<p style="text-align:left" align="left"><span style="font-family: fixedsys;"><span style="color: #0000ff;"><span style="font-size: small;">#define</span><br />
</span><br />
</span><br />
<span style="font-family: fixedsys;"><span style="font-size: small;"> <span style="color: #010001;">SDL_INIT_TIMER</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0x00000001</span><br />
</span></p>
<p style="text-align:left" align="left"><span style="font-family: fixedsys;"><span style="color: #0000ff;"><span style="font-size: small;">#define</span><br />
</span><br />
</span><br />
<span style="font-family: fixedsys;"><span style="font-size: small;"> <span style="color: #010001;">SDL_INIT_AUDIO</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0x00000010</span><br />
</span></p>
<p style="text-align:left" align="left"><span style="font-family: fixedsys;"><span style="color: #0000ff;"><span style="font-size: small;">#define</span><br />
</span><br />
</span><br />
<span style="font-family: fixedsys;"><span style="font-size: small;"> <span style="color: #010001;">SDL_INIT_VIDEO</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0x00000020</span><br />
</span></p>
<p style="text-align:left" align="left"><span style="font-family: fixedsys;"><span style="color: #0000ff;"><span style="font-size: small;">#define</span><br />
</span><br />
</span><br />
<span style="font-family: fixedsys;"><span style="font-size: small;"> <span style="color: #010001;">SDL_INIT_CDROM</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0x00000100</span><br />
</span></p>
<p style="text-align:left" align="left"><span style="font-family: fixedsys;"><span style="color: #0000ff;"><span style="font-size: small;">#define</span><br />
</span><br />
</span><br />
<span style="font-family: fixedsys;"><span style="font-size: small;"> <span style="color: #010001;">SDL_INIT_JOYSTICK</span><br />
&nbsp;&nbsp; 0x00000200</span><br />
</span></p>
<p style="text-align:left" align="left"><span style="font-family: fixedsys;"><span style="color: #0000ff;"><span style="font-size: small;">#define</span><br />
</span><br />
</span><br />
<span style="font-family: fixedsys;"><span style="font-size: small;"> <span style="color: #010001;">SDL_INIT_NOPARACHUTE</span><br />
&nbsp;&nbsp;&nbsp; 0x00100000 <span style="color: #008000;">/**&lt; Don't catch fatal signals */</span><br />
</span><br />
</span></p>
<p style="text-align:left" align="left"><span style="font-family: fixedsys;"><span style="color: #0000ff;"><span style="font-size: small;">#define</span><br />
</span><br />
</span><br />
<span style="font-family: fixedsys;"><span style="font-size: small;"> <span style="color: #010001;">SDL_INIT_EVENTTHREAD</span><br />
&nbsp;&nbsp;&nbsp; 0x01000000 <span style="color: #008000;">/**&lt; Not supported on all OS's */</span><br />
</span><br />
</span></p>
<p><span style="font-family: fixedsys;"><span style="color: #0000ff;"><span style="font-size: small;">#define</span><br />
</span><br />
</span><br />
<span style="font-family: fixedsys;"><span style="font-size: small;"> <span style="color: #010001;">SDL_INIT_EVERYTHING</span><br />
 0x0000FFFF</span><br />
</span></p>
<p>&nbsp;</p>
<p>
这里的可选模块与包含的头文件并不是太一致。</p>
<p>&nbsp;</p>
<p>除了声音我的确不是很了解以外，其他模块会在这里逐一来看看，因为个人爱好，将以video模块为主，当然，事实上这也应该是SDL中最重要的模块，虽然video模块的字面意义上是显示模块，但是实际上SDL主要的平台相关函数几乎都集中在了video模块中了。其中，对源码的最主要分析在于SDL是怎么使用C语言对各类接口进行抽象并实现跨平台的，并不会逐句逐句的理解，那样非常没有必要。当然，我不能理解所有SDL支持的平台，这里仅以我熟悉的3大平台为例，Win32,Unix/Linux,Macos，事实上这也是目前最为流行的平台，应该也算是最具代表性了。</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<h2><span style="font-family: 宋体;">计时器</span><br />
 (timer)</h2>
<p>计时器和时间相关的东西是几乎每个有意义的游戏都会用到的，将其接口抽象出来并实现跨平台几乎是每个跨平台库的必要工作，相对来说还比较简单，这里以此作为第一篇，也算是热热身。</p>
<p>
以下是SDL的timer.h头文件中有的计时器API：</p>
<p style="text-align:left" align="left"><span style="font-family: fixedsys;"><span style="color: #0000ff;"><span style="font-size: small;">extern</span><br />
</span><br />
</span><br />
<span style="font-family: fixedsys;"><span style="font-size: small;"> <span style="color: #010001;">DECLSPEC</span><br />
<span style="color: #010001;">Uint32</span><br />
<span style="color: #010001;">SDLCALL</span><br />
<span style="color: #010001;">SDL_GetTicks</span><br />
(<span style="color: #0000ff;">void</span><br />
);</span><br />
</span></p>
<p style="text-align:left" align="left"><span style="font-family: fixedsys;"><span style="color: #0000ff;"><span style="font-size: small;">extern</span><br />
</span><br />
</span><br />
<span style="font-family: fixedsys;"><span style="font-size: small;"> <span style="color: #010001;">DECLSPEC</span><br />
<span style="color: #0000ff;">void</span><br />
<span style="color: #010001;">SDLCALL</span><br />
<span style="color: #010001;">SDL_Delay</span><br />
(<span style="color: #010001;">Uint32</span><br />
<span style="color: #010001;">ms</span><br />
);</span><br />
</span></p>
<p style="text-align:left" align="left"><span style="font-family: fixedsys;"><span style="color: #0000ff;"><span style="font-size: small;">typedef</span><br />
</span><br />
</span><br />
<span style="font-family: fixedsys;"><span style="font-size: small;"> <span style="color: #010001;">Uint32</span><br />
 (<span style="color: #010001;">SDLCALL</span><br />
 *<span style="color: #010001;">SDL_TimerCallback</span><br />
)(<span style="color: #010001;">Uint32</span><br />
<span style="color: #010001;">interval</span><br />
);</span><br />
</span></p>
<p style="text-align:left" align="left">&nbsp;</p>
<p style="text-align:left" align="left"><span style="font-family: fixedsys;"><span style="color: #0000ff;"><span style="font-size: small;">extern</span><br />
</span><br />
</span><br />
<span style="font-family: fixedsys;"><span style="font-size: small;"> <span style="color: #010001;">DECLSPEC</span><br />
<span style="color: #0000ff;">int</span><br />
<span style="color: #010001;">SDLCALL</span><br />
<span style="color: #010001;">SDL_SetTimer</span><br />
(<span style="color: #010001;">Uint32</span><br />
<span style="color: #010001;">interval</span><br />
, <span style="color: #010001;">SDL_TimerCallback</span><br />
<span style="color: #010001;">callback</span><br />
);</span><br />
</span></p>
<p style="text-align:left" align="left"><span style="font-family: fixedsys;"><span style="color: #0000ff;"><span style="font-size: small;">typedef</span><br />
</span><br />
</span><br />
<span style="font-family: fixedsys;"><span style="font-size: small;"> <span style="color: #010001;">Uint32</span><br />
 (<span style="color: #010001;">SDLCALL</span><br />
 *<span style="color: #010001;">SDL_NewTimerCallback</span><br />
)(<span style="color: #010001;">Uint32</span><br />
<span style="color: #010001;">interval</span><br />
, <span style="color: #0000ff;">void</span><br />
 *<span style="color: #010001;">param</span><br />
);</span><br />
</span></p>
<p style="text-align:left" align="left"><span style="font-family: fixedsys;"><span style="color: #0000ff;"><span style="font-size: small;">typedef</span><br />
</span><br />
</span><br />
<span style="font-family: fixedsys;"><span style="font-size: small;"> <span style="color: #0000ff;">struct</span><br />
<span style="color: #010001;">_SDL_TimerID</span><br />
 *<span style="color: #010001;">SDL_TimerID</span><br />
;</span><br />
</span></p>
<p style="text-align:left" align="left"><span style="font-family: fixedsys;"><span style="color: #0000ff;"><span style="font-size: small;">extern</span><br />
</span><br />
</span><br />
<span style="font-family: fixedsys;"><span style="font-size: small;"> <span style="color: #010001;">DECLSPEC</span><br />
<span style="color: #010001;">SDL_TimerID</span><br />
<span style="color: #010001;">SDLCALL</span><br />
<span style="color: #010001;">SDL_AddTimer</span><br />
(<span style="color: #010001;">Uint32</span><br />
<span style="color: #010001;">interval</span><br />
, <span style="color: #010001;">SDL_NewTimerCallback</span><br />
<span style="color: #010001;">callback</span><br />
, <span style="color: #0000ff;">void</span><br />
 *<span style="color: #010001;">param</span><br />
);</span><br />
</span></p>
<p style="text-align:left" align="left"><span style="font-family: fixedsys;"><span style="color: #0000ff;"><span style="font-size: small;">extern</span><br />
</span><br />
</span><br />
<span style="font-family: fixedsys;"><span style="font-size: small;"> <span style="color: #010001;">DECLSPEC</span><br />
<span style="color: #010001;">SDL_bool</span><br />
<span style="color: #010001;">SDLCALL</span><br />
<span style="color: #010001;">SDL_RemoveTimer</span><br />
(<span style="color: #010001;">SDL_TimerID</span><br />
<span style="color: #010001;">t</span><br />
);</span><br />
</span></p>
<p>&nbsp;</p>
<p>个人感觉是没有什么值得学习的，叫100个人来设计计时器接口，基本99个与这个类似。无论是用过Unix/Linux还是用过Windows 计时器的人都可以对SDL的计时器API与相应平台的计时器接口对号入座。接口是简单，但是实现并不算简单，各个平台之间的计时器和时间函数还是有些差异。当然，作为C语言的跨平台库，首先要习惯的就是满篇满篇的宏了，这是C语言库跨平台的必要装备。</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<h3><span class="3Char"><span style="font-size: large;">SDL_GetTicks</span><br />
</span><br />
<span class="3Char"><span style="font-family: 宋体;"><span style="font-size: large;">：</span><br />
</span><br />
</span><br />
</h3>
<p>Win32主要由QueryPerformanceCounter或者timeGetTime实现。</p>
<p>Unix主要由clock_gettime或者更常见的gettimeofday实现。</p>
<p>MacOS下首先实现了一套FastTimer的函数，然后再调用这些函数实现，虽然我没有完全明白作者为什么不直接使用MacOS freeBSD相关的系统调用来实现，但是看了源代码感觉主要的问题在于现在MacOS都是64位的，所以作者需要进行一些处理。另外，还有PowerPC的MacOS部分，作者甚至使用了汇编来完成。</p>
<p>总的来说，很明显支持MacOS是最不容易的。。。。。假如作者原意在MacOS部分使用Objective C的代码的话，可能会好很多，但是估计作者是想尽量保持SDL简单的C库特征。</p>
<p>另外，此函数返回的并不是一般的从开机开始的计时，而是SDL自己计算的从SDL_StartTicks开始的计时。此函数在SDL的计时模块初始化的时候调用。</p>
<p>&nbsp;</p>
<h3>SDL_Delay<span style="font-family: 宋体;">：</span><br />
</h3>
<p>
Win32下是最清晰简单的函数，sleep而已。</p>
<p>Unix下有nano sleep的话调用nanosleep自然是最简单的，没有的话调用select来进行等待。当年看《Unix网络编程》的时候，作者用select实现了一个定时器，想不到还真有这样用的。</p>
<p>Macos下完全自己计时进行循环。。。。。。。这个应该是效率最低的了，不明白为啥这样做。</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<h3>SDL_SetTimer<span style="font-family: 宋体;">，</span><br />
SDL_AddTimer<span style="font-family: 宋体;">，</span><br />
SDL_RemoveTimer<span style="font-family: 宋体;">：</span><br />
</h3>
<p>
我原以为每个平台都会有的函数</p>
<p>Win32完全靠计时线程加一个SDL自己的timerID列表来完成，不明白为什么不用Win32自己的Timer来完成。</p>
<p>Unix下用setitimer开始，也用setitimer结束。</p>
<p>MacOS下用InsXTime，PrimeTime开始，然后用RmvTime停止。</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<h2><span style="font-family: 宋体;">多线程模块</span><br />
</h2>
<p style="text-align:left" align="left"><span style="font-family: fixedsys;"><span style="color: #0000ff;"><span style="font-size: small;">extern</span><br />
</span><br />
</span><br />
<span style="font-family: fixedsys;"><span style="font-size: small;"> <span style="color: #010001;">DECLSPEC</span><br />
<span style="color: #010001;">SDL_Thread</span><br />
 * <span style="color: #010001;">SDLCALL</span><br />
<span style="color: #010001;">SDL_CreateThread</span><br />
(<span style="color: #0000ff;">int</span><br />
 (<span style="color: #010001;">SDLCALL</span><br />
 *<span style="color: #010001;">fn</span><br />
)(<span style="color: #0000ff;">void</span><br />
 *), <span style="color: #0000ff;">void</span><br />
 *<span style="color: #010001;">data</span><br />
);</span><br />
</span></p>
<p style="text-align:left" align="left"><span style="font-family: fixedsys;"><span style="color: #0000ff;"><span style="font-size: small;">#endif</span><br />
</span><br />
</span></p>
<p style="text-align:left" align="left"><span style="font-family: fixedsys;"><span style="color: #0000ff;"><span style="font-size: small;">extern</span><br />
</span><br />
</span><br />
<span style="font-family: fixedsys;"><span style="font-size: small;"> <span style="color: #010001;">DECLSPEC</span><br />
<span style="color: #010001;">Uint32</span><br />
<span style="color: #010001;">SDLCALL</span><br />
<span style="color: #010001;">SDL_ThreadID</span><br />
(<span style="color: #0000ff;">void</span><br />
);</span><br />
</span></p>
<p style="text-align:left" align="left"><span style="font-family: fixedsys;"><span style="color: #0000ff;"><span style="font-size: small;">extern</span><br />
</span><br />
</span><br />
<span style="font-family: fixedsys;"><span style="font-size: small;"> <span style="color: #010001;">DECLSPEC</span><br />
<span style="color: #010001;">Uint32</span><br />
<span style="color: #010001;">SDLCALL</span><br />
<span style="color: #010001;">SDL_GetThreadID</span><br />
(<span style="color: #010001;">SDL_Thread</span><br />
 *<span style="color: #010001;">thread</span><br />
);</span><br />
</span></p>
<p style="text-align:left" align="left">&nbsp;</p>
<p style="text-align:left" align="left"><span style="font-family: fixedsys;"><span style="color: #0000ff;"><span style="font-size: small;">extern</span><br />
</span><br />
</span><br />
<span style="font-family: fixedsys;"><span style="font-size: small;"> <span style="color: #010001;">DECLSPEC</span><br />
<span style="color: #0000ff;">void</span><br />
<span style="color: #010001;">SDLCALL</span><br />
<span style="color: #010001;">SDL_WaitThread</span><br />
(<span style="color: #010001;">SDL_Thread</span><br />
 *<span style="color: #010001;">thread</span><br />
, <span style="color: #0000ff;">int</span><br />
 *<span style="color: #010001;">status</span><br />
);</span><br />
</span></p>
<p><span style="font-family: fixedsys;"><span style="color: #0000ff;"><span style="font-size: small;">extern</span><br />
</span><br />
</span><br />
<span style="font-family: fixedsys;"><span style="font-size: small;"> <span style="color: #010001;">DECLSPEC</span><br />
<span style="color: #0000ff;">void</span><br />
<span style="color: #010001;">SDLCALL</span><br />
<span style="color: #010001;">SDL_KillThread</span><br />
(<span style="color: #010001;">SDL_Thread</span><br />
 *<span style="color: #010001;">thread</span><br />
);</span><br />
</span></p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>多线程模块应该是最一致的模块了，Win32下分别上述接口在的一一对应的接口。</p>
<p>Unix,MacOS下使用pthread，接口也几乎一一对应，只是命名上有些差异，没有什么好说的。</p>
<p>这应该是最最简单的模块了。</p>
<p>&nbsp;</p>
<h2><span style="font-family: 宋体;">事件模块</span><br />
</h2>
<p>
在事件模块中，SDL统一了所有的输入，将所有的输入最大的与上层逻辑解耦。</p>
<p><span style="font-family: fixedsys;"><span style="color: #008000;"><span style="font-size: small;">/** Event enumerations */</span><br />
</span><br />
</span></p>
<p><span style="font-family: fixedsys;"><span style="color: #0000ff;"><span style="font-size: small;">typedef</span><br />
</span><br />
</span><br />
<span style="font-family: fixedsys;"><span style="font-size: small;"> <span style="color: #0000ff;">enum</span><br />
 {</span><br />
</span></p>
<p><span style="font-family: fixedsys;"><span style="font-size: small;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #010001;">SDL_NOEVENT</span><br />
 = 0,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #008000;">/**&lt; Unused (do not remove) */</span><br />
</span><br />
</span></p>
<p><span style="font-family: fixedsys;"><span style="font-size: small;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #010001;">SDL_ACTIVEEVENT</span><br />
,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #008000;">/**&lt; Application loses/gains visibility */</span><br />
</span><br />
</span></p>
<p><span style="font-family: fixedsys;"><span style="font-size: small;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #010001;">SDL_KEYDOWN</span><br />
,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #008000;">/**&lt; Keys pressed */</span><br />
</span><br />
</span></p>
<p><span style="font-family: fixedsys;"><span style="font-size: small;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #010001;">SDL_KEYUP</span><br />
,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #008000;">/**&lt; Keys released */</span><br />
</span><br />
</span></p>
<p><span style="font-family: fixedsys;"><span style="font-size: small;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #010001;">SDL_MOUSEMOTION</span><br />
,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #008000;">/**&lt; Mouse moved */</span><br />
</span><br />
</span></p>
<p><span style="font-family: fixedsys;"><span style="font-size: small;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #010001;">SDL_MOUSEBUTTONDOWN</span><br />
,&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #008000;">/**&lt; Mouse button pressed */</span><br />
</span><br />
</span></p>
<p><span style="font-family: fixedsys;"><span style="font-size: small;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #010001;">SDL_MOUSEBUTTONUP</span><br />
,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #008000;">/**&lt; Mouse button released */</span><br />
</span><br />
</span></p>
<p><span style="font-family: fixedsys;"><span style="font-size: small;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #010001;">SDL_JOYAXISMOTION</span><br />
,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #008000;">/**&lt; Joystick axis motion */</span><br />
</span><br />
</span></p>
<p><span style="font-family: fixedsys;"><span style="font-size: small;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #010001;">SDL_JOYBALLMOTION</span><br />
,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #008000;">/**&lt; Joystick trackball motion */</span><br />
</span><br />
</span></p>
<p><span style="font-family: fixedsys;"><span style="font-size: small;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #010001;">SDL_JOYHATMOTION</span><br />
,&nbsp;&nbsp;&nbsp; <span style="color: #008000;">/**&lt; Joystick hat position change */</span><br />
</span><br />
</span></p>
<p><span style="font-family: fixedsys;"><span style="font-size: small;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #010001;">SDL_JOYBUTTONDOWN</span><br />
,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #008000;">/**&lt; Joystick button pressed */</span><br />
</span><br />
</span></p>
<p><span style="font-family: fixedsys;"><span style="font-size: small;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #010001;">SDL_JOYBUTTONUP</span><br />
,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #008000;">/**&lt; Joystick button released */</span><br />
</span><br />
</span></p>
<p><span style="font-family: fixedsys;"><span style="font-size: small;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #010001;">SDL_QUIT</span><br />
,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #008000;">/**&lt; User-requested quit */</span><br />
</span><br />
</span></p>
<p><span style="font-family: fixedsys;"><span style="font-size: small;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #010001;">SDL_SYSWMEVENT</span><br />
,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #008000;">/**&lt; System specific event */</span><br />
</span><br />
</span></p>
<p><span style="font-family: fixedsys;"><span style="font-size: small;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #010001;">SDL_EVENT_RESERVEDA</span><br />
,&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #008000;">/**&lt; Reserved for future use.. */</span><br />
</span><br />
</span></p>
<p><span style="font-family: fixedsys;"><span style="font-size: small;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #010001;">SDL_EVENT_RESERVEDB</span><br />
,&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #008000;">/**&lt; Reserved for future use.. */</span><br />
</span><br />
</span></p>
<p><span style="font-family: fixedsys;"><span style="font-size: small;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #010001;">SDL_VIDEORESIZE</span><br />
,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #008000;">/**&lt; User resized video mode */</span><br />
</span><br />
</span></p>
<p><span style="font-family: fixedsys;"><span style="font-size: small;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #010001;">SDL_VIDEOEXPOSE</span><br />
,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #008000;">/**&lt; Screen needs to be redrawn */</span><br />
</span><br />
</span></p>
<p><span style="font-family: fixedsys;"><span style="font-size: small;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #010001;">SDL_EVENT_RESERVED2</span><br />
,&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #008000;">/**&lt; Reserved for future use.. */</span><br />
</span><br />
</span></p>
<p><span style="font-family: fixedsys;"><span style="font-size: small;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #010001;">SDL_EVENT_RESERVED3</span><br />
,&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #008000;">/**&lt; Reserved for future use.. */</span><br />
</span><br />
</span></p>
<p><span style="font-family: fixedsys;"><span style="font-size: small;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;<span style="color: #010001;">SDL_EVENT_RESERVED4</span><br />
,&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #008000;">/**&lt; Reserved for future use.. */</span><br />
</span><br />
</span></p>
<p><span style="font-family: fixedsys;"><span style="font-size: small;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #010001;">SDL_EVENT_RESERVED5</span><br />
,&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #008000;">/**&lt; Reserved for future use.. */</span><br />
</span><br />
</span></p>
<p><span style="font-family: fixedsys;"><span style="font-size: small;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #010001;">SDL_EVENT_RESERVED6</span><br />
,&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #008000;">/**&lt; Reserved for future use.. */</span><br />
</span><br />
</span></p>
<p><span style="font-family: fixedsys;"><span style="font-size: small;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #010001;">SDL_EVENT_RESERVED7</span><br />
,&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #008000;">/**&lt; Reserved for future use.. */</span><br />
</span><br />
</span></p>
<p><span style="font-family: fixedsys;"><span style="font-size: small;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #008000;">/** Events SDL_USEREVENT through SDL_MAXEVENTS-1 are for your use */</span><br />
</span><br />
</span></p>
<p><span style="font-family: fixedsys;"><span style="font-size: small;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #010001;">SDL_USEREVENT</span><br />
 = 24,</span><br />
</span></p>
<p><span style="font-family: fixedsys;"><span style="font-size: small;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #008000;">/** This last event is only for bounding internal arrays</span><br />
</span><br />
</span></p>
<p><span style="font-family: fixedsys;"><span style="color: #008000;"><span style="font-size: small;">&nbsp;&nbsp;&nbsp; *&nbsp; It is the number of bits in the event mask datatype -- Uint32</span><br />
</span><br />
</span></p>
<p><span style="font-family: fixedsys;"><span style="color: #008000;"><span style="font-size: small;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; */</span><br />
</span><br />
</span></p>
<p><span style="font-family: fixedsys;"><span style="font-size: small;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #010001;">SDL_NUMEVENTS</span><br />
 = 32</span><br />
</span></p>
<p><span style="font-family: fixedsys;"><span style="font-size: small;">} <span style="color: #010001;">SDL_EventType</span><br />
;</span><br />
</span></p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>
通过这个枚举，可以看到，除了输入，还包括一些系统事件，比如SDL_VIDEORESIZE和SDL_QUIT。</p>
<p>虽然说大部分以C语言实现的事件系统都实现不了类型安全以及订阅-发布的模式，所以都避免不了需要通过事件类型来决定事件的输入，并且进行强转的操作，然后形成一个很长的switch case，</p>
<p>但是SDL中的事件系统还算实现的不错了。</p>
<p>事件的参数是一个这样的联合结构：</p>
<p><span style="font-family: fixedsys;"><span style="color: #008000;"><span style="font-size: small;">/** General event structure */</span><br />
</span><br />
</span></p>
<p><span style="font-family: fixedsys;"><span style="color: #0000ff;"><span style="font-size: small;">typedef</span><br />
</span><br />
</span><br />
<span style="font-family: fixedsys;"><span style="font-size: small;"> <span style="color: #0000ff;">union</span><br />
<span style="color: #010001;">SDL_Event</span><br />
 {</span><br />
</span></p>
<p><span style="font-family: fixedsys;"><span style="font-size: small;">&nbsp;&nbsp;&nbsp; <span style="color: #010001;">Uint8</span><br />
<span style="color: #010001;">type</span><br />
;</span><br />
</span></p>
<p><span style="font-family: fixedsys;"><span style="font-size: small;">&nbsp;&nbsp;&nbsp; <span style="color: #010001;">SDL_ActiveEvent</span><br />
<span style="color: #010001;">active</span><br />
;</span><br />
</span></p>
<p><span style="font-family: fixedsys;"><span style="font-size: small;">&nbsp;&nbsp;&nbsp; <span style="color: #010001;">SDL_KeyboardEvent</span><br />
<span style="color: #010001;">key</span><br />
;</span><br />
</span></p>
<p><span style="font-family: fixedsys;"><span style="font-size: small;">&nbsp;&nbsp;&nbsp; <span style="color: #010001;">SDL_MouseMotionEvent</span><br />
<span style="color: #010001;">motion</span><br />
;</span><br />
</span></p>
<p><span style="font-family: fixedsys;"><span style="font-size: small;">&nbsp;&nbsp;&nbsp; <span style="color: #010001;">SDL_MouseButtonEvent</span><br />
<span style="color: #010001;">button</span><br />
;</span><br />
</span></p>
<p><span style="font-family: fixedsys;"><span style="font-size: small;">&nbsp;&nbsp;&nbsp; <span style="color: #010001;">SDL_JoyAxisEvent</span><br />
<span style="color: #010001;">jaxis</span><br />
;</span><br />
</span></p>
<p><span style="font-family: fixedsys;"><span style="font-size: small;">&nbsp;&nbsp;&nbsp; <span style="color: #010001;">SDL_JoyBallEvent</span><br />
<span style="color: #010001;">jball</span><br />
;</span><br />
</span></p>
<p><span style="font-family: fixedsys;"><span style="font-size: small;">&nbsp;&nbsp;&nbsp; <span style="color: #010001;">SDL_JoyHatEvent</span><br />
<span style="color: #010001;">jhat</span><br />
;</span><br />
</span></p>
<p><span style="font-family: fixedsys;"><span style="font-size: small;">&nbsp;&nbsp;&nbsp; <span style="color: #010001;">SDL_JoyButtonEvent</span><br />
<span style="color: #010001;">jbutton</span><br />
;</span><br />
</span></p>
<p><span style="font-family: fixedsys;"><span style="font-size: small;">&nbsp;&nbsp;&nbsp; <span style="color: #010001;">SDL_ResizeEvent</span><br />
<span style="color: #010001;">resize</span><br />
;</span><br />
</span></p>
<p><span style="font-family: fixedsys;"><span style="font-size: small;">&nbsp;&nbsp;&nbsp; <span style="color: #010001;">SDL_ExposeEvent</span><br />
<span style="color: #010001;">expose</span><br />
;</span><br />
</span></p>
<p><span style="font-family: fixedsys;"><span style="font-size: small;">&nbsp;&nbsp;&nbsp; <span style="color: #010001;">SDL_QuitEvent</span><br />
<span style="color: #010001;">quit</span><br />
;</span><br />
</span></p>
<p><span style="font-family: fixedsys;"><span style="font-size: small;">&nbsp;&nbsp;&nbsp; <span style="color: #010001;">SDL_UserEvent</span><br />
<span style="color: #010001;">user</span><br />
;</span><br />
</span></p>
<p><span style="font-family: fixedsys;"><span style="font-size: small;">&nbsp;&nbsp;&nbsp; <span style="color: #010001;">SDL_SysWMEvent</span><br />
<span style="color: #010001;">syswm</span><br />
;</span><br />
</span></p>
<p><span style="font-family: fixedsys;"><span style="font-size: small;">} <span style="color: #010001;">SDL_Event</span><br />
;</span><br />
</span></p>
<p>&nbsp;</p>
<p>所以可以不进行强转，在相应的事件中，直接通过指定对应的成员变量来获取信息。虽然并不是完全类型安全，但是起码减少了强转的步骤。</p>
<p>事件模块有的API如下：</p>
<p>&nbsp;</p>
<p><span style="font-family: fixedsys;"><span style="color: #0000ff;"><span style="font-size: small;">extern</span><br />
</span><br />
</span><br />
<span style="font-family: fixedsys;"><span style="font-size: small;"> <span style="color: #010001;">DECLSPEC</span><br />
<span style="color: #0000ff;">void</span><br />
<span style="color: #010001;">SDLCALL</span><br />
<span style="color: #010001;">SDL_PumpEvents</span><br />
(<span style="color: #0000ff;">void</span><br />
);</span><br />
</span></p>
<p><span style="font-family: fixedsys;"><span style="color: #0000ff;"><span style="font-size: small;">typedef</span><br />
</span><br />
</span><br />
<span style="font-family: fixedsys;"><span style="font-size: small;"> <span style="color: #0000ff;">enum</span><br />
 {</span><br />
</span></p>
<p><span style="font-family: fixedsys;"><span style="font-size: small;">&nbsp;&nbsp;&nbsp; <span style="color: #010001;">SDL_ADDEVENT</span><br />
,</span><br />
</span></p>
<p><span style="font-family: fixedsys;"><span style="font-size: small;">&nbsp;&nbsp;&nbsp; <span style="color: #010001;">SDL_PEEKEVENT</span><br />
,</span><br />
</span></p>
<p><span style="font-family: fixedsys;"><span style="font-size: small;">&nbsp;&nbsp;&nbsp; <span style="color: #010001;">SDL_GETEVENT</span><br />
</span><br />
</span></p>
<p><span style="font-family: fixedsys;"><span style="font-size: small;">} <span style="color: #010001;">SDL_eventaction</span><br />
;</span><br />
</span></p>
<p><span style="font-family: fixedsys;"><span style="color: #0000ff;"><span style="font-size: small;">extern</span><br />
</span><br />
</span><br />
<span style="font-family: fixedsys;"><span style="font-size: small;"> <span style="color: #010001;">DECLSPEC</span><br />
<span style="color: #0000ff;">int</span><br />
<span style="color: #010001;">SDLCALL</span><br />
<span style="color: #010001;">SDL_PeepEvents</span><br />
(<span style="color: #010001;">SDL_Event</span><br />
 *<span style="color: #010001;">events</span><br />
, <span style="color: #0000ff;">int</span><br />
<span style="color: #010001;">numevents</span><br />
,</span><br />
</span></p>
<p><span style="font-family: fixedsys;"><span style="font-size: small;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #010001;">SDL_eventaction</span><br />
<span style="color: #010001;">action</span><br />
, <span style="color: #010001;">Uint32</span><br />
<span style="color: #010001;">mask</span><br />
);</span><br />
</span></p>
<p><span style="font-family: fixedsys;"><span style="color: #0000ff;"><span style="font-size: small;">extern</span><br />
</span><br />
</span><br />
<span style="font-family: fixedsys;"><span style="font-size: small;"> <span style="color: #010001;">DECLSPEC</span><br />
<span style="color: #0000ff;">int</span><br />
<span style="color: #010001;">SDLCALL</span><br />
<span style="color: #010001;">SDL_PollEvent</span><br />
(<span style="color: #010001;">SDL_Event</span><br />
 *<span style="color: #0000ff;">event</span><br />
);</span><br />
</span></p>
<p><span style="font-family: fixedsys;"><span style="color: #0000ff;"><span style="font-size: small;">extern</span><br />
</span><br />
</span><br />
<span style="font-family: fixedsys;"><span style="font-size: small;"> <span style="color: #010001;">DECLSPEC</span><br />
<span style="color: #0000ff;">int</span><br />
<span style="color: #010001;">SDLCALL</span><br />
<span style="color: #010001;">SDL_WaitEvent</span><br />
(<span style="color: #010001;">SDL_Event</span><br />
 *<span style="color: #0000ff;">event</span><br />
);</span><br />
</span></p>
<p><span style="font-family: fixedsys;"><span style="color: #0000ff;"><span style="font-size: small;">extern</span><br />
</span><br />
</span><br />
<span style="font-family: fixedsys;"><span style="font-size: small;"> <span style="color: #010001;">DECLSPEC</span><br />
<span style="color: #0000ff;">int</span><br />
<span style="color: #010001;">SDLCALL</span><br />
<span style="color: #010001;">SDL_PushEvent</span><br />
(<span style="color: #010001;">SDL_Event</span><br />
 *<span style="color: #0000ff;">event</span><br />
);</span><br />
</span></p>
<p><span style="font-family: fixedsys;"><span style="color: #0000ff;"><span style="font-size: small;">typedef</span><br />
</span><br />
</span><br />
<span style="font-family: fixedsys;"><span style="font-size: small;"> <span style="color: #0000ff;">int</span><br />
 (<span style="color: #010001;">SDLCALL</span><br />
 *<span style="color: #010001;">SDL_EventFilter</span><br />
)(<span style="color: #0000ff;">const</span><br />
<span style="color: #010001;">SDL_Event</span><br />
 *<span style="color: #0000ff;">event</span><br />
);</span><br />
</span></p>
<p><span style="font-family: fixedsys;"><span style="color: #0000ff;"><span style="font-size: small;">extern</span><br />
</span><br />
</span><br />
<span style="font-family: fixedsys;"><span style="font-size: small;"> <span style="color: #010001;">DECLSPEC</span><br />
<span style="color: #0000ff;">void</span><br />
<span style="color: #010001;">SDLCALL</span><br />
<span style="color: #010001;">SDL_SetEventFilter</span><br />
(<span style="color: #010001;">SDL_EventFilter</span><br />
<span style="color: #010001;">filter</span><br />
);</span><br />
</span></p>
<p><span style="font-family: fixedsys;"><span style="color: #0000ff;"><span style="font-size: small;">extern</span><br />
</span><br />
</span><br />
<span style="font-family: fixedsys;"><span style="font-size: small;"> <span style="color: #010001;">DECLSPEC</span><br />
<span style="color: #010001;">SDL_EventFilter</span><br />
<span style="color: #010001;">SDLCALL</span><br />
<span style="color: #010001;">SDL_GetEventFilter</span><br />
(<span style="color: #0000ff;">void</span><br />
);</span><br />
</span></p>
<p><span style="font-family: fixedsys;"><span style="color: #0000ff;"><span style="font-size: small;">#define</span><br />
</span><br />
</span><br />
<span style="font-family: fixedsys;"><span style="font-size: small;"> <span style="color: #010001;">SDL_QUERY</span><br />
 -1</span><br />
</span></p>
<p><span style="font-family: fixedsys;"><span style="color: #0000ff;"><span style="font-size: small;">#define</span><br />
</span><br />
</span><br />
<span style="font-family: fixedsys;"><span style="font-size: small;"> <span style="color: #010001;">SDL_IGNORE</span><br />
&nbsp;&nbsp; 0</span><br />
</span></p>
<p><span style="font-family: fixedsys;"><span style="color: #0000ff;"><span style="font-size: small;">#define</span><br />
</span><br />
</span><br />
<span style="font-family: fixedsys;"><span style="font-size: small;"> <span style="color: #010001;">SDL_DISABLE</span><br />
&nbsp; 0</span><br />
</span></p>
<p><span style="font-family: fixedsys;"><span style="color: #0000ff;"><span style="font-size: small;">#define</span><br />
</span><br />
</span><br />
<span style="font-family: fixedsys;"><span style="font-size: small;"> <span style="color: #010001;">SDL_ENABLE</span><br />
&nbsp;&nbsp; 1</span><br />
</span></p>
<p><span style="font-family: fixedsys;"><span style="color: #0000ff;"><span style="font-size: small;">extern</span><br />
</span><br />
</span><br />
<span style="font-family: fixedsys;"><span style="font-size: small;"> <span style="color: #010001;">DECLSPEC</span><br />
<span style="color: #010001;">Uint8</span><br />
<span style="color: #010001;">SDLCALL</span><br />
<span style="color: #010001;">SDL_EventState</span><br />
(<span style="color: #010001;">Uint8</span><br />
<span style="color: #010001;">type</span><br />
, <span style="color: #0000ff;">int</span><br />
<span style="color: #010001;">state</span><br />
);</span><br />
</span></p>
<p>&nbsp;</p>
<p>其中各个接口的含义还算比较好理解，与Win32的API中消息相关的接口类似，只是命名有差异而已。另外，事件模块本身的实现是与各个操作系统并不太相关的，属于依靠ANSI C跨平台的代码。</p>
<p>我用的最多的是SDL_PollEvent接口，比如在主循环中：</p>
<p>&nbsp;</p>
<p><span style="font-family: fixedsys;"><span style="font-size: small;">&nbsp; <span style="color: #0000ff;">while</span><br />
 (<span style="color: #010001;">running</span><br />
) {</span><br />
</span></p>
<p><span style="font-family: fixedsys;"><span style="font-size: small;">&nbsp;&nbsp;&nbsp; <span style="color: #008000;">//While there's an event to handle </span><br />
</span><br />
</span></p>
<p><span style="font-family: fixedsys;"><span style="font-size: small;">&nbsp;&nbsp;&nbsp; <span style="color: #010001;">SDL_Event</span><br />
<span style="color: #0000ff;">event</span><br />
; </span><br />
</span></p>
<p><span style="font-family: fixedsys;"><span style="font-size: small;">&nbsp;&nbsp;&nbsp; <span style="color: #0000ff;">while</span><br />
( <span style="color: #010001;">SDL_PollEvent</span><br />
( &amp;<span style="color: #0000ff;">event</span><br />
 ) ) { </span><br />
</span></p>
<p><span style="font-family: fixedsys;"><span style="font-size: small;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #0000ff;">if</span><br />
 (<span style="color: #0000ff;">event</span><br />
.<span style="color: #010001;">type</span><br />
 == <span style="color: #010001;">SDL_QUIT</span><br />
) {</span><br />
</span></p>
<p><span style="font-family: fixedsys;"><span style="font-size: small;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #010001;">running</span><br />
 = <span style="color: #0000ff;">false</span><br />
;</span><br />
</span></p>
<p><span style="font-family: fixedsys;"><span style="font-size: small;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span><br />
</span></p>
<p><span style="font-family: fixedsys;"><span style="font-size: small;">}</span><br />
</span></p>
<p><span style="font-family: fixedsys;"><span style="font-size: small;">}</span><br />
</span></p>
<p><span style="font-size: small;"><br />
</span></p>
<p>这样来轮询事件。</p>
<p>&nbsp;</p>
<p>这个最常用的API是由其他API实现的：</p>
<p>&nbsp;</p>
<p><span style="font-family: fixedsys;"><span style="color: #0000ff;"><span style="font-size: small;">int</span><br />
</span><br />
</span><br />
<span style="font-family: fixedsys;"><span style="font-size: small;"> <span style="color: #010001;">SDL_PollEvent</span><br />
 (<span style="color: #010001;">SDL_Event</span><br />
 *<span style="color: #0000ff;">event</span><br />
)</span><br />
</span></p>
<p><span style="font-family: fixedsys;"><span style="font-size: small;">{</span><br />
</span></p>
<p><span style="font-family: fixedsys;"><span style="font-size: small;">&nbsp;&nbsp;&nbsp; <span style="color: #010001;">SDL_PumpEvents</span><br />
();</span><br />
</span></p>
<p>&nbsp;</p>
<p><span style="font-family: fixedsys;"><span style="font-size: small;">&nbsp;&nbsp;&nbsp; <span style="color: #008000;">/* We can't return -1, just return 0 (no event) on error */</span><br />
</span><br />
</span></p>
<p><span style="font-family: fixedsys;"><span style="font-size: small;">&nbsp;&nbsp;&nbsp; <span style="color: #0000ff;">if</span><br />
 ( <span style="color: #010001;">SDL_PeepEvents</span><br />
(<span style="color: #0000ff;">event</span><br />
, 1, <span style="color: #010001;">SDL_GETEVENT</span><br />
, <span style="color: #010001;">SDL_ALLEVENTS</span><br />
) &lt;= 0 )</span><br />
</span></p>
<p><span style="font-family: fixedsys;"><span style="font-size: small;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #0000ff;">return</span><br />
 0;</span><br />
</span></p>
<p><span style="font-family: fixedsys;"><span style="font-size: small;">&nbsp;&nbsp;&nbsp; <span style="color: #0000ff;">return</span><br />
 1;</span><br />
</span></p>
<p><span style="font-family: fixedsys;"><span style="font-size: small;">}</span><br />
</span></p>
<p>
所以这里再看看SDL_PumpEvents()和SDL_PeepEvents：</p>
<p>SDL_PumpEvents主要就是调用显示模块的PumpEvent函数以获取上面那些与显示相关的事件，然后就是检测按键和摇杆了，其实很简单。</p>
<p>SDL_PeepEvents是事件模块中较为关键的函数，通过SDL_eventaction参数类型区别并完成</p>
<p>&nbsp;</p>
<p><span style="font-family: fixedsys;"><span style="color: #0000ff;"><span style="font-size: small;">typedef</span><br />
</span><br />
</span><br />
<span style="font-family: fixedsys;"><span style="font-size: small;"> <span style="color: #0000ff;">enum</span><br />
 {</span><br />
</span></p>
<p><span style="font-family: fixedsys;"><span style="font-size: small;">&nbsp;&nbsp;&nbsp; <span style="color: #010001;">SDL_ADDEVENT</span><br />
,</span><br />
</span></p>
<p><span style="font-family: fixedsys;"><span style="font-size: small;">&nbsp;&nbsp;&nbsp; <span style="color: #010001;">SDL_PEEKEVENT</span><br />
,</span><br />
</span></p>
<p><span style="font-family: fixedsys;"><span style="font-size: small;">&nbsp;&nbsp;&nbsp; <span style="color: #010001;">SDL_GETEVENT</span><br />
</span><br />
</span></p>
<p><span style="font-family: fixedsys;"><span style="font-size: small;">} <span style="color: #010001;">SDL_eventaction</span><br />
;</span><br />
</span></p>
<p><span style="font-size: small;"><br />
</span></p>
<p>
这三类操作。添加事件，查看事件和获取事件。</p>
<p> 看完API，来看看事件模块的内部：在内部，通过上述函数，其实都是操作同一个全局的事件列表：</p>
<p>&nbsp;</p>
<p><span style="font-family: fixedsys;"><span style="color: #0000ff;"><span style="font-size: small;">static</span><br />
</span><br />
</span><br />
<span style="font-family: fixedsys;"><span style="font-size: small;"> <span style="color: #0000ff;">struct</span><br />
 {</span><br />
</span></p>
<p><span style="font-family: fixedsys;"><span style="font-size: small;">&nbsp;&nbsp;&nbsp; <span style="color: #010001;">SDL_mutex</span><br />
 *<span style="color: #010001;">lock</span><br />
;</span><br />
</span></p>
<p><span style="font-family: fixedsys;"><span style="font-size: small;">&nbsp;&nbsp;&nbsp; <span style="color: #0000ff;">int</span><br />
<span style="color: #010001;">active</span><br />
;</span><br />
</span></p>
<p><span style="font-family: fixedsys;"><span style="font-size: small;">&nbsp;&nbsp;&nbsp; <span style="color: #0000ff;">int</span><br />
<span style="color: #010001;">head</span><br />
;</span><br />
</span></p>
<p><span style="font-family: fixedsys;"><span style="font-size: small;">&nbsp;&nbsp;&nbsp; <span style="color: #0000ff;">int</span><br />
<span style="color: #010001;">tail</span><br />
;</span><br />
</span></p>
<p><span style="font-family: fixedsys;"><span style="font-size: small;">&nbsp;&nbsp;&nbsp; <span style="color: #010001;">SDL_Event</span><br />
<span style="color: #0000ff;">event</span><br />
[<span style="color: #010001;">MAXEVENTS</span><br />
];</span><br />
</span></p>
<p><span style="font-family: fixedsys;"><span style="font-size: small;">&nbsp;&nbsp;&nbsp; <span style="color: #0000ff;">int</span><br />
<span style="color: #010001;">wmmsg_next</span><br />
;</span><br />
</span></p>
<p><span style="font-family: fixedsys;"><span style="font-size: small;">&nbsp;&nbsp;&nbsp; <span style="color: #0000ff;">struct</span><br />
<span style="color: #010001;">SDL_SysWMmsg</span><br />
<span style="color: #010001;">wmmsg</span><br />
[<span style="color: #010001;">MAXEVENTS</span><br />
];</span><br />
</span></p>
<p><span style="font-family: fixedsys;"><span style="font-size: small;">} <span style="color: #010001;">SDL_EventQ</span><br />
;</span><br />
</span></p>
<p>
并且，SDL通过自己的事件线程来维护事件系统的运作，在SDL_StartEventThread函数中启动了一个函数为SDL_GobbleEvents的事件线程。</p>
<p>此函数中是一个死循环（只要事件模块还是激活状态）以下是有删节的主要内容：</p>
<p><span style="font-size: small;"><br />
</span></p>
<p><span style="font-family: fixedsys;"><span style="font-size: small;">&nbsp;&nbsp;&nbsp; <span style="color: #0000ff;">while</span><br />
 ( <span style="color: #010001;">SDL_EventQ</span><br />
.<span style="color: #010001;">active</span><br />
 ) {</span><br />
</span></p>
<p><span style="font-family: fixedsys;"><span style="font-size: small;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #010001;">SDL_VideoDevice</span><br />
 *<span style="color: #010001;">video</span><br />
 = <span style="color: #010001;">current_video</span><br />
;</span><br />
</span></p>
<p><span style="font-family: fixedsys;"><span style="font-size: small;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #010001;">SDL_VideoDevice</span><br />
 *<span style="color: #0000ff;">this</span><br />
&nbsp; = <span style="color: #010001;">current_video</span><br />
;</span><br />
</span></p>
<p>&nbsp;</p>
<p><span style="font-family: fixedsys;"><span style="font-size: small;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #008000;">/* Get events from the video subsystem */</span><br />
</span><br />
</span></p>
<p><span style="font-family: fixedsys;"><span style="font-size: small;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #0000ff;">if</span><br />
 ( <span style="color: #010001;">video</span><br />
 ) {</span><br />
</span></p>
<p><span style="font-family: fixedsys;"><span style="font-size: small;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #010001;">video</span><br />
-&gt;<span style="color: #010001;">PumpEvents</span><br />
(<span style="color: #0000ff;">this</span><br />
);</span><br />
</span></p>
<p><span style="font-family: fixedsys;"><span style="font-size: small;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span><br />
</span></p>
<p>&nbsp;</p>
<p><span style="font-family: fixedsys;"><span style="font-size: small;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #008000;">/* Queue pending key-repeat events */</span><br />
</span><br />
</span></p>
<p><span style="font-family: fixedsys;"><span style="font-size: small;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #010001;">SDL_CheckKeyRepeat</span><br />
();</span><br />
</span></p>
<p>&nbsp;</p>
<p><span style="font-family: fixedsys;"><span style="color: #0000ff;"><span style="font-size: small;">#if</span><br />
</span><br />
</span><br />
<span style="font-family: fixedsys;"><span style="font-size: small;"> !<span style="color: #010001;">SDL_JOYSTICK_DISABLED</span><br />
</span><br />
</span></p>
<p><span style="font-family: fixedsys;"><span style="font-size: small;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #008000;">/* Check for joystick state change */</span><br />
</span><br />
</span></p>
<p><span style="font-family: fixedsys;"><span style="font-size: small;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #0000ff;">if</span><br />
 ( <span style="color: #010001;">SDL_numjoysticks</span><br />
 &amp;&amp; (<span style="color: #010001;">SDL_eventstate</span><br />
 &amp; <span style="color: #010001;">SDL_JOYEVENTMASK</span><br />
) ) {</span><br />
</span></p>
<p><span style="font-family: fixedsys;"><span style="font-size: small;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #010001;">SDL_JoystickUpdate</span><br />
();</span><br />
</span></p>
<p><span style="font-family: fixedsys;"><span style="font-size: small;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span><br />
</span></p>
<p><span style="font-family: fixedsys;"><span style="color: #0000ff;"><span style="font-size: small;">#endif</span><br />
</span><br />
</span></p>
<p><span style="font-family: fixedsys;"><span style="font-size: small;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #0000ff;">if</span><br />
 ( <span style="color: #010001;">SDL_timer_running</span><br />
 ) {</span><br />
</span></p>
<p><span style="font-family: fixedsys;"><span style="font-size: small;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #010001;">SDL_ThreadedTimerCheck</span><br />
();</span><br />
</span></p>
<p><span style="font-family: fixedsys;"><span style="font-size: small;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span><br />
</span></p>
<p><span style="font-family: fixedsys;"><span style="font-size: small;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #010001;">SDL_Delay</span><br />
(1);</span><br />
</span></p>
<p><span style="font-family: fixedsys;"><span style="font-size: small;">&nbsp;&nbsp;&nbsp; }</p>
<p></span><br />
</span></p>
<p>&nbsp;</p>
<p>
可以看到主要是调用显示模块的PumpEvents来获取显示系统相关的事件，其次就是重复按键的事件检测和摇杆了。另外，可以看到前面那个全局事件列表是带互斥量的，事实上，整个SDL的事件系统的实现都是线程安全的。<br />
SDL_SetEventFilter等事件过滤的函数，实现非常简单，就是根据设置的回调函数的结果来决定事件是否添加到事件列表，就不多说了。</p>
<p>事实上，虽然各类输入最后都统一归结到SDL的事件模块中，然后提供给用户或者SDL本身进行处理，但是在SDL中将这些输入检测本身都放在了video模块中。所以这里暂时不讲它们的实现了。</p>
<p>&nbsp;</p>
<h2><span style="font-family: 宋体;">小结：</span><br />
</h2>
<p>&nbsp;&nbsp; &nbsp; 以一般看源码一边记录下来的方式完成本文，基本上将SDL除Video以外的一些周边模块都看了一遍，除了事件模块，这些模块的编写都没有太多值得深入了解的东西，无非就是抽象出一个大概的API，然后在不同的平台上实现，相当于SDL将很多平台相关的dirty的工作都做了，剩下clean的跨平台接口供用户使用。事件模块本身就不是平台相关的，SDL的实现相对来说使用还是比较方便的。利用联合来减少强转虽然不是第一次见，但是还是比更常见的void*表示event data+强转更加方便。看得出SDL的用心设计。</p>
<p>&nbsp;&nbsp; &nbsp;因为这些周边模块主要抽象一些接口，然后实现，没有太多亮点，所以看的时候有的时候都不知道该写什么，所以按照自己看源码的流程记录了一些琐碎的东西，全文比较混乱。</p>
<p>&nbsp;&nbsp;&nbsp; 准备下篇文章中讲述SDL最关键的video模块，相对来说，就比这些周边模块有意思的多。</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p align="left">&nbsp;</p>
<p style="text-align:right">原创文章作者保留版权 转载请注明原作者 并给出链接</p>
<p style="text-align:right"><strong><a href="http://www.jtianling.com">write by 九天雁翎(JTianLing) -- www.jtianling.com</a><br />
</strong></p>
<p></p>
