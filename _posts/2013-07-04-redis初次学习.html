---
layout: post
title: Redis初次学习
categories:
- "数据库"
tags:
- nodejs
- Redis
status: publish
type: post
published: true
meta:
  views: '112'
  mkd_text: "NoSQL热了很久了, 很惭愧直到今天我才初次学习NoSQL的东西.  从一开始做C++的后端用了MySQL和SQL Server后, 一直在做游戏客户端,
    真是远离数据库相关的东西太久了, 有意思的是, 很久前, 对编程相关知识如饥似渴的时候, 工作中碰到任何相关的知识, 哪怕是一个新领域, 起码都要买一本大部头来学习的,
    当时只有数据库是真的点到为止, 没有深入学习, 直到今天我也说不上具体为什么......\n\n# [Redis](http://redis.io/)介绍\n就不比较各个用NoSQL统称的大量非关系型数据库了,
    相关的内容可以看看[*Cassandra vs MongoDB vs CouchDB vs Redis vs Riak vs HBase vs Couchbase
    vs Neo4j vs Hypertable vs ElasticSearch vs Accumulo vs VoltDB vs Scalaris comparison*](http://kkovacs.eu/cassandra-vs-mongodb-vs-couchdb-vs-redis)这篇文章,
    看看标题有多长, 就知道如今NoSQL的阵营其实有多庞大了.  \n就我的感觉, 用NoSQL的最大好处就是比SQL数据库要简单...... 也许还有类似处理超大规模数据的效率更高吧,
    但是我目前还体会不到, 但是简单却是很重要, 很重要的, 起码你不用预先设计好一堆的表, 和处理好各个表之间的各种关系.  \n\nRedis简单来说是以key-value方式来存储数据的数据库,
    类似一个大的hash表.  想想hash表有多么好用, 那么Redis就有多么好用.  \n\n# 安装\n## MacOS\n\n    $Brew install
    redis\n\n用Brew安装很方便, 然后通过\n\n    $redis-server /usr/local/etc/redis.conf\n \n运行.
    \ \n目前我的MacOS安装的是版本2.6.7.  \n\n## Ubuntu\n我的Ubuntu 12.04中apt不自带redis, 不过没有关系,
    [lanchpad](https://launchpad.net/~rwky/+archive/redis)上已经有人做好了包.  \n\n    #sudo
    add-apt-repository ppa:rwky/redis\n    #sudo apt-get update\n    #sudo apt-get
    install redis-server\n\n我安装的是最新的2.6.10版本.  \n\n# REPL\n我就借用一下REPL的称呼吧, 实际就是Redis的Shell,
    因为Redis的概念很简单, 所以Shell的使用会比MySQL要简单无数倍.  安装完Redis后, 可以通过以下命令开启Redis的REPL环境.  \n\n
    \   $redis-cli\n\n同时, 你还能在<try.redis.io>上先试试.  \n\n# [数据类型](http://redis.io/topics/data-types-intro)\nRedis本身是基于Key-value的,
    类似Hash表.  Hash表这个应该都知道吧, 而这个Hash表中可以存储的数据类型有如下几种:\n\n* string\n* list\n* sets\n*
    hashes\n* sorted sets\n\n其中字符串是基础类型, 并且在Redis中字符串是可以存储任意二进制序列的, 甚至可以直接存一个图片啥的.(文档中说明不能大于512MB-_-!)list,
    sets, sorted sets都是string的集合类型.  \n\n# [命令](http://redis.io/commands)\n## 基础命令\n基础的命令是`SET`,
    `GET`. 还有针对数值(意思就是把string按整数来解析)的`INCR`, `INCRBY`和`DECR`, `DECRBY`.  \n\n    redis>set
    counter 100\n    OK\n    redis>incr counter\n    (integer) 101\n    redis>incr
    counter\n    (integer) 102\n    redis>incrby counter 10\n    (integer) 112\n\n稍微特殊点的是`GETSET`,
    用途是设置key为一个值的时候同时返回当前值.  \n\n## [哈希表操作](http://redis.io/commands#hash)\n首先, 整个redis就是一个大的哈希表"
  _pingme: '1'
  _encloseme: '1'
  _edit_last: '1'
  _aioseop_title: Redis初次学习
author:
  login: jtianling
  email: jtianling@gmail.com
  display_name: jtianling
  first_name: ''
  last_name: ''
---
<div class="toc">
<ul>
<li><a href="#redis">Redis介绍</a></li>
<li><a href="#_1">安装</a>
<ul>
<li><a href="#macos">MacOS</a></li>
<li><a href="#ubuntu">Ubuntu</a></li>
</ul>
</li>
<li><a href="#repl">REPL</a></li>
<li><a href="#_2">数据类型</a></li>
<li><a href="#_3">命令</a></li>
<li><a href="#redis-with-nodejs">Redis With Nodejs</a>
<ul>
<li><a href="#_4">实际的例子</a></li>
</ul>
</li>
<li><a href="#_5">小结</a></li>
</ul>
</div>
<p>NoSQL热了很久了, 很惭愧直到今天我才初次学习NoSQL的东西.  从一开始做C++的后端用了MySQL和SQL Server后, 一直在做游戏客户端, 真是远离数据库相关的东西太久了, 有意思的是, 很久前, 对编程相关知识如饥似渴的时候, 工作中碰到任何相关的知识, 哪怕是一个新领域, 起码都要买一本大部头来学习的, 当时只有数据库是真的点到为止, 没有深入学习, 直到今天我也说不上具体为什么......</p>
<h1 id="redis">Redis介绍</h1>
<p>就不比较各个用NoSQL统称的大量非关系型数据库了, 相关的内容可以看看<a href="http://kkovacs.eu/cassandra-vs-mongodb-vs-couchdb-vs-redis"><em>Cassandra vs MongoDB vs CouchDB vs Redis vs Riak vs HBase vs Couchbase vs Neo4j vs Hypertable vs ElasticSearch vs Accumulo vs VoltDB vs Scalaris comparison</em></a>这篇文章, 看看标题有多长, 就知道如今NoSQL的阵营其实有多庞大了.<br />
<a href="http://redis.io/">Redis</a>只是其中的一个我感觉最简单的.<br />
就我的感觉, 用Redis的最大好处就是比SQL数据库要简单...... 也许还有类似处理超大规模数据的效率更高吧, 但是我目前还体会不到, 但是简单却是很重要, 很重要的, 起码你不用预先设计好一堆的表, 和处理好各个表之间的各种关系.<br />
Redis简单来说是以key-value方式来存储数据的数据库, 类似一个大的hash表.  想想hash表有多么好用, 那么Redis就有多么好用.  </p>
<h1 id="_1">安装</h1>
<h2 id="macos">MacOS</h2>
<div class="codehilite">
<pre><span class="nv">$Brew</span> install redis
</pre>
</div>
<p>用Brew安装很方便, 然后通过</p>
<div class="codehilite">
<pre><span class="nv">$redis</span>-server /usr/local/etc/redis.conf
</pre>
</div>
<p>运行.<br />
目前我的MacOS安装的是版本2.6.7.  </p>
<h2 id="ubuntu">Ubuntu</h2>
<p>我的Ubuntu 12.04中apt不自带redis, 不过没有关系, <a href="https://launchpad.net/~rwky/+archive/redis">lanchpad</a>上已经有人做好了包.  </p>
<div class="codehilite">
<pre><span class="nv">$sudo</span> add-apt-repository ppa:rwky/redis
<span class="nv">$sudo</span> apt-get update
<span class="nv">$sudo</span> apt-get install redis-server
</pre>
</div>
<p>我安装的是最新的2.6.10版本.  </p>
<h1 id="repl">REPL</h1>
<p>我就借用一下REPL的称呼吧, 实际就是Redis的Shell, 因为Redis的概念很简单, 所以Shell的使用会比MySQL要简单无数倍.  安装完Redis后, 可以通过以下命令开启Redis的REPL环境.  </p>
<div class="codehilite">
<pre><span class="nv">$redis</span>-cli
</pre>
</div>
<p>同时, 你还能在<br />
<try .redis.io>上先试试.  </try></p>
<h1 id="_2">数据类型</h1>
<p>Redis本身是基于Key-value的, 类似Hash表.  Hash表这个应该都知道吧, 而这个Hash表中可以存储的数据类型有如下几种:</p>
<ul>
<li>string</li>
<li>list</li>
<li>sets</li>
<li>hashes</li>
<li>sorted sets</li>
</ul>
<p>其中字符串是基础类型, 并且在Redis中字符串是可以存储任意二进制序列的, 甚至可以直接存一个图片啥的.(文档中说明不能大于512MB-_-!)list, sets, sorted sets都是string的集合类型.  官方的文档在<a href="http://redis.io/topics/data-types-intro">这里</a></p>
<h1 id="_3">命令</h1>
<p>所有的命令命名都很有规律.  比如, 对<em>hashes</em>的操作, 都用'H'开头, 而所有对<em>list</em>的操作都以'L'开头, 对<em>Sets</em>就是用'S'开头, 等等.<br />
首先, 我们需要对redis的基本数据类型有所了解, 然后, 查看Redis这个关于<a href="http://redis.io/commands">命令</a>的文档就能做所有的事情了, 因为, 对应的类型我们想要进行的操作也就那些.  在这里再一个一个的去演示(仅仅能说是演示, 而不能说是教学)简直就是侮辱大家的智商了.  </p>
<h1 id="redis-with-nodejs">Redis With Nodejs</h1>
<p>这个部分稍微有些介绍的必要, 因为相关的资料较少, 并且官方的文档还有限和不详细.<br />
Nodejs本身有一个Redis的npm包, 包的名字就叫redis, 并且开源放在github上: <a href="https://github.com/mranney/node_redis">https://github.com/mranney/node_redis</a>.<br />
假如你仅仅是自己做做实验和学习, 那么用npm的标准安装方式安装redis就可以了:  </p>
<div class="codehilite">
<pre><span class="nv">$npm</span> install redis
</pre>
</div>
<p>假如是真实的环境, 那么推荐安装hiredis, 这是一个C语言写的redis库, 速度更快.  其实安装也挺简单的:  </p>
<div class="codehilite">
<pre><span class="nv">$npm</span> install hiredis redis
</pre>
</div>
<p>使用上, 官方给的一个类似HelloWorld例子:  </p>
<div class="codehilite">
<pre><span class="kd">var</span> <span class="nx">redis</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;redis&quot;</span><span class="p">),</span>
<span class="nx">client</span> <span class="o">=</span> <span class="nx">redis</span><span class="p">.</span><span class="nx">createClient</span><span class="p">();</span>

<span class="c1">// if you&#39;d like to select database 3, instead of 0 (default), call</span>
<span class="c1">// client.select(3, function() { /* ... */ });</span>

<span class="nx">client</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Error &quot;</span> <span class="o">+</span> <span class="nx">err</span><span class="p">);</span>
<span class="p">});</span>

<span class="nx">client</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s2">&quot;string key&quot;</span><span class="p">,</span> <span class="s2">&quot;string val&quot;</span><span class="p">,</span> <span class="nx">redis</span><span class="p">.</span><span class="nx">print</span><span class="p">);</span>
<span class="nx">client</span><span class="p">.</span><span class="nx">hset</span><span class="p">(</span><span class="s2">&quot;hash key&quot;</span><span class="p">,</span> <span class="s2">&quot;hashtest 1&quot;</span><span class="p">,</span> <span class="s2">&quot;some value&quot;</span><span class="p">,</span> <span class="nx">redis</span><span class="p">.</span><span class="nx">print</span><span class="p">);</span>
<span class="nx">client</span><span class="p">.</span><span class="nx">hset</span><span class="p">([</span><span class="s2">&quot;hash key&quot;</span><span class="p">,</span> <span class="s2">&quot;hashtest 2&quot;</span><span class="p">,</span> <span class="s2">&quot;some other value&quot;</span><span class="p">],</span> <span class="nx">redis</span><span class="p">.</span><span class="nx">print</span><span class="p">);</span>
<span class="nx">client</span><span class="p">.</span><span class="nx">hkeys</span><span class="p">(</span><span class="s2">&quot;hash key&quot;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">replies</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">replies</span><span class="p">.</span><span class="nx">length</span> <span class="o">+</span> <span class="s2">&quot; replies:&quot;</span><span class="p">);</span>
  <span class="nx">replies</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">reply</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;    &quot;</span> <span class="o">+</span> <span class="nx">i</span> <span class="o">+</span> <span class="s2">&quot;: &quot;</span> <span class="o">+</span> <span class="nx">reply</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="nx">client</span><span class="p">.</span><span class="nx">quit</span><span class="p">();</span>
<span class="p">});</span>
</pre>
</div>
<p>不过, 仅仅这个例子想要的信息都有了. 用createClient获得redis的client, 然后, 每个操作都对应一个相应的js函数, 命名都一样.  假如不熟悉nodejs(或者js)的话, 需要接受的就是, 所有的操作都是异步的, 需要设置回调函数来获得结果.  如上面hset, hkeys调用所示.  然后, 用client.quit退出.  </p>
<p>另外, 这里还有更多的<a href="https://github.com/mranney/node_redis/tree/master/examples">例子</a>.  </p>
<h2 id="_4">实际的例子</h2>
<p>以前对汽车之家没有车型收藏功能很恼火, 所以自己写了个<a href="https://chrome.google.com/webstore/detail/autohome-boost/deohljpidkeahefhmndoogigfehddimb">Chrome的插件</a>来搞定这个事情, 当时的服务器就是用nodejs with redis写的, 这里贴一下主要代码, 作为一个实际的例子:  </p>
<div class="codehilite">
<pre><span class="kd">var</span> <span class="nx">redis</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;redis&#39;</span><span class="p">);</span>

<span class="nx">client</span> <span class="o">=</span> <span class="nx">redis</span><span class="p">.</span><span class="nx">createClient</span><span class="p">();</span>
<span class="nx">client</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{});</span>
<span class="nx">client</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Error: &#39;</span> <span class="o">+</span> <span class="nx">err</span><span class="p">);</span>
<span class="p">});</span>

<span class="kd">function</span> <span class="nx">isArgumentEnough</span><span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">query</span><span class="p">,</span> <span class="nx">queryNeeds</span><span class="p">)</span> <span class="p">{</span>

  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">queryNeeds</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span> <span class="nx">query</span><span class="p">[</span> <span class="nx">queryNeeds</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">]</span> <span class="o">==</span> <span class="kc">undefined</span> <span class="p">)</span> <span class="p">{</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;argumentMissing: &#39;</span> <span class="o">+</span> <span class="nx">queryNeeds</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
      <span class="nx">request</span><span class="p">.</span><span class="nx">writeHead</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;Content-Type&quot;</span> <span class="o">:</span> <span class="s2">&quot;application/json&quot;</span><span class="p">});</span>
      <span class="nx">request</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="s1">&#39; { &quot;argumentMissing&quot; : &quot;&#39;</span> <span class="o">+</span> <span class="nx">queryNeeds</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;&quot;}&#39;</span><span class="p">);</span>
      <span class="nx">request</span><span class="p">.</span><span class="nx">end</span><span class="p">();</span>
      <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">addFav</span><span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">query</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;addFav : &quot;</span> <span class="o">+</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">query</span><span class="p">));</span>

  <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">isArgumentEnough</span><span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">query</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="s1">&#39;code&#39;</span><span class="p">])</span> <span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nx">client</span><span class="p">.</span><span class="nx">sadd</span><span class="p">(</span><span class="nx">query</span><span class="p">.</span><span class="nx">name</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="nx">query</span><span class="p">.</span><span class="nx">type</span><span class="p">,</span> <span class="nx">query</span><span class="p">.</span><span class="nx">code</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">reply</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;sadd reply: &quot;</span> <span class="o">+</span> <span class="nx">reply</span><span class="p">);</span>

    <span class="kd">var</span> <span class="nx">fav_key</span> <span class="o">=</span> <span class="nx">query</span><span class="p">.</span><span class="nx">name</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="nx">query</span><span class="p">.</span><span class="nx">type</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="nx">query</span><span class="p">.</span><span class="nx">code</span><span class="p">;</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;fav_key: &quot;</span> <span class="o">+</span> <span class="nx">fav_key</span><span class="p">);</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">exists</span><span class="p">(</span><span class="nx">fav_key</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">reply</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;client exists reply: &quot;</span> <span class="o">+</span> <span class="nx">reply</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">reply</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">client</span><span class="p">.</span><span class="nx">hmset</span><span class="p">(</span><span class="nx">fav_key</span><span class="p">,</span> <span class="nx">query</span><span class="p">,</span> <span class="nx">redis</span><span class="p">.</span><span class="nx">print</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">});</span>

    <span class="nx">request</span><span class="p">.</span><span class="nx">writeHead</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;Content-Type&quot;</span> <span class="o">:</span> <span class="s2">&quot;application/json&quot;</span><span class="p">});</span>
    <span class="nx">request</span><span class="p">.</span><span class="nx">end</span><span class="p">();</span>
  <span class="p">});</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">delFav</span><span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">query</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;delFav :&#39;</span> <span class="o">+</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">query</span><span class="p">));</span>

  <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">isArgumentEnough</span><span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">query</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="s1">&#39;code&#39;</span><span class="p">])</span> <span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nx">client</span><span class="p">.</span><span class="nx">srem</span><span class="p">(</span><span class="nx">query</span><span class="p">.</span><span class="nx">name</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="nx">query</span><span class="p">.</span><span class="nx">type</span><span class="p">,</span> <span class="nx">query</span><span class="p">.</span><span class="nx">code</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">reply</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;srem result: &quot;</span> <span class="o">+</span> <span class="nx">reply</span><span class="p">);</span>

    <span class="nx">request</span><span class="p">.</span><span class="nx">writeHead</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;Content-Type&quot;</span> <span class="o">:</span> <span class="s2">&quot;application/json&quot;</span><span class="p">});</span>
    <span class="nx">request</span><span class="p">.</span><span class="nx">end</span><span class="p">();</span>
  <span class="p">});</span>

<span class="p">}</span>

<span class="kd">function</span> <span class="nx">isFav</span><span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">query</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;isFav :&quot;</span> <span class="o">+</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">query</span><span class="p">));</span>

  <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">isArgumentEnough</span><span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">query</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="s1">&#39;code&#39;</span><span class="p">])</span> <span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nx">client</span><span class="p">.</span><span class="nx">sismember</span><span class="p">(</span><span class="nx">query</span><span class="p">.</span><span class="nx">name</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="nx">query</span><span class="p">.</span><span class="nx">type</span><span class="p">,</span> <span class="nx">query</span><span class="p">.</span><span class="nx">code</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">reply</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;sismember result: &quot;</span> <span class="o">+</span> <span class="nx">reply</span><span class="p">);</span>

    <span class="nx">request</span><span class="p">.</span><span class="nx">writeHead</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;Content-Type&quot;</span> <span class="o">:</span> <span class="s2">&quot;application/json&quot;</span><span class="p">});</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">reply</span> <span class="o">===</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">request</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span> <span class="s2">&quot;result&quot;</span> <span class="o">:</span> <span class="kc">true</span> <span class="p">}));</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
      <span class="nx">request</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span> <span class="s2">&quot;result&quot;</span> <span class="o">:</span> <span class="kc">false</span> <span class="p">}));</span>
    <span class="p">}</span>

  <span class="nx">request</span><span class="p">.</span><span class="nx">end</span><span class="p">();</span>
  <span class="p">});</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">getFavs</span><span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">query</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;getFav :&quot;</span> <span class="o">+</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">query</span><span class="p">));</span>

  <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">isArgumentEnough</span><span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">query</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">])</span> <span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nx">client</span><span class="p">.</span><span class="nx">smembers</span><span class="p">(</span><span class="nx">query</span><span class="p">.</span><span class="nx">name</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="nx">query</span><span class="p">.</span><span class="nx">type</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">replies</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">replies</span><span class="p">.</span><span class="nx">length</span> <span class="o">+</span> <span class="s2">&quot; replies:&quot;</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">favs</span> <span class="o">=</span> <span class="p">[];</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">replies</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">request</span><span class="p">.</span><span class="nx">writeHead</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;Content-Type&quot;</span> <span class="o">:</span> <span class="s2">&quot;application/json&quot;</span><span class="p">});</span>
      <span class="nx">request</span><span class="p">.</span><span class="nx">end</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="nx">replies</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">reply</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">i</span> <span class="o">+</span> <span class="s2">&quot; reply: &quot;</span> <span class="o">+</span> <span class="nx">reply</span><span class="p">);</span>

      <span class="kd">var</span> <span class="nx">fav_key</span> <span class="o">=</span> <span class="nx">query</span><span class="p">.</span><span class="nx">name</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="nx">query</span><span class="p">.</span><span class="nx">type</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="nx">reply</span><span class="p">;</span>
      <span class="nx">client</span><span class="p">.</span><span class="nx">hgetall</span><span class="p">(</span><span class="nx">fav_key</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">favs</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">obj</span><span class="p">);</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">obj</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">i</span> <span class="o">===</span> <span class="nx">replies</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">query</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="s1">&#39;series&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">favs</span><span class="p">.</span><span class="nx">sort</span><span class="p">(</span> <span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span><span class="nx">b</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">a</span><span class="p">.</span><span class="nx">desc</span> <span class="o">&gt;</span> <span class="nx">a</span><span class="p">.</span><span class="nx">desc</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="p">);</span>
          <span class="p">}</span>

          <span class="nx">request</span><span class="p">.</span><span class="nx">writeHead</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;Content-Type&quot;</span> <span class="o">:</span> <span class="s2">&quot;application/json&quot;</span><span class="p">});</span>
          <span class="nx">request</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">favs</span><span class="p">));</span>
          <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">favs</span><span class="p">));</span>
          <span class="nx">request</span><span class="p">.</span><span class="nx">end</span><span class="p">();</span>
        <span class="p">}</span>
      <span class="p">});</span>
    <span class="p">});</span>
  <span class="p">});</span>
<span class="p">}</span>

<span class="nx">exports</span><span class="p">.</span><span class="nx">addFav</span> <span class="o">=</span> <span class="nx">addFav</span><span class="p">;</span>
<span class="nx">exports</span><span class="p">.</span><span class="nx">delFav</span> <span class="o">=</span> <span class="nx">delFav</span><span class="p">;</span>
<span class="nx">exports</span><span class="p">.</span><span class="nx">isFav</span> <span class="o">=</span> <span class="nx">isFav</span><span class="p">;</span>
<span class="nx">exports</span><span class="p">.</span><span class="nx">getFavs</span> <span class="o">=</span> <span class="nx">getFavs</span><span class="p">;</span>
</pre>
</div>
<h1 id="_5">小结</h1>
<p>这篇文章有些水了...... 因为很久前(2013-02-23日)刚学习Redis时起笔写的, 原计划是像本博客中很多文章一样, 一边学习一边写, 但是因为Redis太简单了, 随便看了看, 感觉就差不多可以用一用了, 就直接写了上面提到的插件的服务器, 等工作都完成了以后, 再回头来写这个文章的动力就小了, 所以一直拖到现在, 今天整理博客, 看了看, 简单的补充了一下, 还是把这个文章发了吧, 好歹有那么多有用的链接.  </p>
<div style="text-align:right">
  writen&nbsp;by <a href="http://www.jtianling.com" target="_blank">九天雁翎(JTianLing) -- www.jtianling.com</a>
</div>
