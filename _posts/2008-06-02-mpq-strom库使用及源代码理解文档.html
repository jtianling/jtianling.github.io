---
layout: post
title: MPQ Strom库使用及源代码理解文档
categories:
- "游戏开发"
tags:
- MPQ
status: publish
type: post
published: true
meta:
  ratings_users: '0'
  ratings_score: '0'
  ratings_average: '0'
  views: '41'
author:
  login: jtianling
  email: jtianling@gmail.com
  display_name: jtianling
  first_name: ''
  last_name: ''
---

<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt"><font size="3"><span lang="EN-US"><font face="Times New Roman">MPQ Strom</font></span><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">库使用及源代码理解文档</span></font></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt"><font size="3"><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">九天雁翎</span></font></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt"><font size="3"><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">读取文件流程</span><span lang="EN-US"><font face="Times New Roman">:</font></span></font></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt 18pt; TEXT-INDENT: -18pt; mso-list: l1 level1 lfo1; tab-stops: list 18.0pt"><span lang="EN-US" style="mso-fareast-font-family: 'Times New Roman'"><span style="mso-list: Ignore"><font face="Times New Roman"><font size="3">1.</font><span style='FONT: 7pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></font></span></span><font size="3"><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">用要打开文档的文件名调用</span><span lang="EN-US"><font face="Times New Roman">SFileOpenArchive()</font></span><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">函数打开文档</span><span lang="EN-US"><font face="Times New Roman">,</font></span><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">得到打开文档的句柄</span><span lang="EN-US"><font face="Times New Roman">.</font></span></font></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt 18pt; TEXT-INDENT: -18pt; mso-list: l1 level1 lfo1; tab-stops: list 18.0pt"><span lang="EN-US" style="mso-fareast-font-family: 'Times New Roman'"><span style="mso-list: Ignore"><font face="Times New Roman"><font size="3">2.</font><span style='FONT: 7pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></font></span></span><font size="3"><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">用上步得到的文档句柄</span><span lang="EN-US"><font face="Times New Roman">,</font></span><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">和要打开的文件名调用</span><span lang="EN-US"><font face="Times New Roman">SFileOpenFileEx()</font></span><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">函数</span><span lang="EN-US"><font face="Times New Roman">,</font></span><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">得到打开的文件句柄</span><span lang="EN-US"><font face="Times New Roman">.</font></span></font></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt 18pt; TEXT-INDENT: -18pt; mso-list: l1 level1 lfo1; tab-stops: list 18.0pt"><span lang="EN-US" style="mso-fareast-font-family: 'Times New Roman'"><span style="mso-list: Ignore"><font face="Times New Roman"><font size="3">3.</font><span style='FONT: 7pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></font></span></span><font size="3"><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">用上步得到的文件句柄</span><span lang="EN-US"><font face="Times New Roman">,</font></span><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">调用</span><span lang="EN-US"><font face="Times New Roman">SFileReadFile()</font></span><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">函数</span><span lang="EN-US"><font face="Times New Roman">,</font></span><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">读取数据</span><span lang="EN-US"><font face="Times New Roman">.</font></span></font></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt 18pt; TEXT-INDENT: -18pt; mso-list: l1 level1 lfo1; tab-stops: list 18.0pt"><span lang="EN-US" style="mso-fareast-font-family: 'Times New Roman'"><span style="mso-list: Ignore"><font face="Times New Roman"><font size="3">4.</font><span style='FONT: 7pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></font></span></span><font size="3"><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">关闭文件</span><span lang="EN-US"><font face="Times New Roman">,</font></span><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">文档句柄</span><span lang="EN-US"><font face="Times New Roman">.</font></span></font></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt"><span lang="EN-US"><o:p><font face="Times New Roman" size="3">&nbsp;</font></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt"><font size="3"><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">各函数调用方式及参数意义参看</span><span lang="EN-US"><a href="http://writeblog.csdn.net/Editor/FCKeditor/editor/MPQ内幕(二).mht"><font face="Times New Roman">MPQ</font><span lang="EN-US" style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'"><span lang="EN-US">内<span lang="EN-US">幕</span></span></span><font face="Times New Roman">(</font><span lang="EN-US" style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'"><span lang="EN-US">二</span></span><font face="Times New Roman">).</font></a></span></font></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt"><font size="3"><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">因为牵涉到太多原始的底层操作</span><span lang="EN-US"><font face="Times New Roman">,</font></span><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">和各样的加密解密</span><span lang="EN-US"><font face="Times New Roman">,</font></span><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">所以看的比较仔细</span><span lang="EN-US"><font face="Times New Roman">,</font></span><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">各函数的实现如下</span></font></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt"><span lang="EN-US"><font face="Times New Roman" size="3">SFileOpenArchive():</font></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt 18pt; TEXT-INDENT: -18pt; mso-list: l4 level1 lfo2; tab-stops: list 18.0pt"><span lang="EN-US" style="mso-fareast-font-family: 'Times New Roman'"><span style="mso-list: Ignore"><font face="Times New Roman"><font size="3">1.</font><span style='FONT: 7pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></font></span></span><font size="3"><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">首先调用</span><span lang="EN-US"><font face="Times New Roman">PrepareStormBuffer(),</font></span><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">确保以后调用各解密函数时此</span><span lang="EN-US"><font face="Times New Roman">Buffer</font></span><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">已经初始化</span><span lang="EN-US"><font face="Times New Roman">.</font></span></font></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt"><span lang="EN-US"><o:p><font face="Times New Roman" size="3">&nbsp;</font></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt 18pt; TEXT-INDENT: -18pt; mso-list: l4 level1 lfo2; tab-stops: list 18.0pt"><span lang="EN-US" style="mso-fareast-font-family: 'Times New Roman'"><span style="mso-list: Ignore"><font face="Times New Roman"><font size="3">2.</font><span style='FONT: 7pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></font></span></span><font size="3"><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">利用</span><span lang="EN-US"><font face="Times New Roman">CreateFile()</font></span><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">这个</span><span lang="EN-US"><font face="Times New Roman">windows API</font></span><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">打开需要打开的文档</span><span lang="EN-US"><font face="Times New Roman">.</font></span></font></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt"><span lang="EN-US"><o:p><font face="Times New Roman" size="3">&nbsp;</font></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt 18pt; TEXT-INDENT: -18pt; mso-list: l4 level1 lfo2; tab-stops: list 18.0pt"><span lang="EN-US" style="mso-fareast-font-family: 'Times New Roman'"><span style="mso-list: Ignore"><font face="Times New Roman"><font size="3">3.</font><span style='FONT: 7pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></font></span></span><font size="3"><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">动态创建一个</span><span lang="EN-US" style="FONT-SIZE: 12pt; COLOR: black; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">TMPQArchive</span></font><span style="FONT-SIZE: 12pt; COLOR: black; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">类型的变量<span lang="EN-US">,</span>保存在名叫<span lang="EN-US">ha</span>的指针当中<span lang="EN-US">,</span>以后都直接用<span lang="EN-US">ha,</span>代表这个变量<span lang="EN-US">.</span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt"><span lang="EN-US" style="FONT-SIZE: 12pt; COLOR: black; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">TMPQArchive</span><span style="FONT-SIZE: 12pt; COLOR: black; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">的原型如下<span lang="EN-US">:</span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; TEXT-ALIGN: left; mso-layout-grid-align: none" align="left"><span lang="EN-US" style="FONT-SIZE: 12pt; COLOR: blue; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">struct</span><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"> <span style="COLOR: black">TMPQArchive<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; TEXT-ALIGN: left; mso-layout-grid-align: none" align="left"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">{<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; TEXT-ALIGN: left; mso-layout-grid-align: none" align="left"><span lang="EN-US" style="FONT-SIZE: 12pt; COLOR: green; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">//<span style="mso-spacerun: yes">&nbsp; </span>TMPQArchive * pNext;<span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>// Next archive (used by Storm.dll only)<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; TEXT-ALIGN: left; mso-layout-grid-align: none" align="left"><span lang="EN-US" style="FONT-SIZE: 12pt; COLOR: green; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">//<span style="mso-spacerun: yes">&nbsp; </span>TMPQArchive * pPrev;<span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>// Previous archive (used by Storm.dll only)<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; TEXT-ALIGN: left; mso-layout-grid-align: none" align="left"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp; </span><span style="COLOR: blue">char</span><span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="COLOR: black">szFileName</span>[<span style="COLOR: black">MAX_PATH</span>]; <span style="COLOR: green">// Opened archive file name<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; TEXT-ALIGN: left; mso-layout-grid-align: none" align="left"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp; </span><span style="COLOR: black">HANDLE</span><span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="COLOR: black">hFile</span>;<span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="COLOR: green">// File handle<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; TEXT-ALIGN: left; mso-layout-grid-align: none" align="left"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><span style="mso-spacerun: yes">&nbsp; </span><span style="mso-spacerun: yes">&nbsp;&nbsp;</span><span style="COLOR: black">DWORD</span><span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="COLOR: black">dwPriority</span>;<span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="COLOR: green">// Priority of the archive<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; TEXT-ALIGN: left; mso-layout-grid-align: none" align="left"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp; </span><span style="COLOR: black">LARGE_INTEGER</span> <span style="COLOR: black">ShuntPos</span>;<span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="COLOR: green">// MPQShunt offset (only valid if a shunt is present)<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; TEXT-ALIGN: left; mso-layout-grid-align: none" align="left"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp; </span><span style="COLOR: black">LARGE_INTEGER</span> <span style="COLOR: black">MpqPos</span>;<span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="COLOR: green">// File header offset (relative to the begin of the file)<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; TEXT-ALIGN: left; mso-layout-grid-align: none" align="left"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp; </span><span style="COLOR: black">LARGE_INTEGER</span> <span style="COLOR: black">HashTablePos</span>;<span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="COLOR: green">// Hash table offset (relative to the begin of the file)<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; TEXT-ALIGN: left; mso-layout-grid-align: none" align="left"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp; </span><span style="COLOR: black">LARGE_INTEGER</span> <span style="COLOR: black">BlockTablePos</span>;<span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="COLOR: green">// Block table offset (relative to the begin of the file)<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; TEXT-ALIGN: left; mso-layout-grid-align: none" align="left"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp; </span><span style="COLOR: black">LARGE_INTEGER</span> <span style="COLOR: black">ExtBlockTablePos</span>;<span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="COLOR: green">// Ext. block table offset (relative to the begin of the file)<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; TEXT-ALIGN: left; mso-layout-grid-align: none" align="left"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp; </span><span style="COLOR: black">LARGE_INTEGER</span> <span style="COLOR: black">MpqSize</span>;<span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="COLOR: green">// Size of MPQ archive<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; TEXT-ALIGN: left; mso-layout-grid-align: none" align="left"><span lang="EN-US" style="FONT-SIZE: 12pt; COLOR: green; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><o:p>&nbsp;</o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; TEXT-ALIGN: left; mso-layout-grid-align: none" align="left"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp; </span><span style="COLOR: black">TMPQFile</span><span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp; </span>* <span style="COLOR: black">pLastFile</span>;<span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="COLOR: green">// Recently read file<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; TEXT-ALIGN: left; mso-layout-grid-align: none" align="left"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp; </span><span style="COLOR: black">DWORD</span><span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="COLOR: black">dwBlockPos</span>;<span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="COLOR: green">// Position of loaded block in the file<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; TEXT-ALIGN: left; mso-layout-grid-align: none" align="left"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp; </span><span style="COLOR: black">DWORD</span><span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="COLOR: black">dwBlockSize</span>;<span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="COLOR: green">// Size of file block<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; TEXT-ALIGN: left; mso-layout-grid-align: none" align="left"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp; </span><span style="COLOR: black">BYTE</span><span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>* <span style="COLOR: black">pbBlockBuffer</span>;<span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="COLOR: green">// Buffer (cache) for file block<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; TEXT-ALIGN: left; mso-layout-grid-align: none" align="left"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp; </span><span style="COLOR: black">DWORD</span><span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="COLOR: black">dwBuffPos</span>;<span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="COLOR: green">// Position in block buffer<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; TEXT-ALIGN: left; mso-layout-grid-align: none" align="left"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp; </span><span style="COLOR: black">TMPQShunt</span><span style="mso-spacerun: yes">&nbsp;&nbsp; </span>* <span style="COLOR: black">pShunt</span>;<span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="COLOR: green">// MPQ shunt (NULL if not present in the file)<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; TEXT-ALIGN: left; mso-layout-grid-align: none" align="left"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp; </span><span style="COLOR: black">TMPQHeader2</span> * <span style="COLOR: black">pHeader</span>;<span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="COLOR: green">// MPQ file header<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; TEXT-ALIGN: left; mso-layout-grid-align: none" align="left"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp; </span><span style="COLOR: black">TMPQHash</span><span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp; </span>* <span style="COLOR: black">pHashTable</span>;<span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="COLOR: green">// Hash table<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; TEXT-ALIGN: left; mso-layout-grid-align: none" align="left"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp; </span><span style="COLOR: black">TMPQBlock</span><span style="mso-spacerun: yes">&nbsp;&nbsp; </span>* <span style="COLOR: black">pBlockTable</span>;<span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="COLOR: green">// Block table<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; TEXT-ALIGN: left; mso-layout-grid-align: none" align="left"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp; </span><span style="COLOR: black">TMPQBlockEx</span> * <span style="COLOR: black">pExtBlockTable</span>;<span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="COLOR: green">// Extended block table<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; TEXT-ALIGN: left; mso-layout-grid-align: none" align="left"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp; </span><o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; TEXT-ALIGN: left; mso-layout-grid-align: none" align="left"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp; </span><span style="COLOR: black">TMPQShunt</span><span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="COLOR: black">Shunt</span>;<span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="COLOR: green">// MPQ shunt. Valid only when ID_MPQ_SHUNT has been found<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; TEXT-ALIGN: left; mso-layout-grid-align: none" align="left"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp; </span><span style="COLOR: black">TMPQHeader2</span><span style="mso-spacerun: yes">&nbsp;&nbsp; </span><span style="COLOR: black">Header</span>;<span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="COLOR: green">// MPQ header<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; TEXT-ALIGN: left; mso-layout-grid-align: none" align="left"><span lang="EN-US" style="FONT-SIZE: 12pt; COLOR: green; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><o:p>&nbsp;</o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; TEXT-ALIGN: left; mso-layout-grid-align: none" align="left"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp; </span><span style="COLOR: black">TMPQAttr</span><span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp; </span>* <span style="COLOR: black">pAttributes</span>;<span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="COLOR: green">// MPQ attributes from &quot;(attributes)&quot; file (NULL if none)<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; TEXT-ALIGN: left; mso-layout-grid-align: none" align="left"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp; </span><span style="COLOR: black">TFileNode</span><span style="mso-spacerun: yes">&nbsp; </span>** <span style="COLOR: black">pListFile</span>;<span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="COLOR: green">// File name array<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; TEXT-ALIGN: left; mso-layout-grid-align: none" align="left"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp; </span><span style="COLOR: black">DWORD</span><span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="COLOR: black">dwFlags</span>;<span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="COLOR: green">// See MPQ_FLAG_XXXXX<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; TEXT-ALIGN: left; mso-layout-grid-align: none" align="left"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">};<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; TEXT-ALIGN: left; mso-layout-grid-align: none" align="left"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><o:p>&nbsp;</o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt 18pt; TEXT-INDENT: -18pt; TEXT-ALIGN: left; mso-layout-grid-align: none; mso-list: l4 level1 lfo2; tab-stops: list 18.0pt" align="left"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes; mso-bidi-font-family: 新宋体"><span style="mso-list: Ignore">4.<span style='FONT: 7pt "Times New Roman"'>&nbsp;&nbsp;&nbsp; </span></span></span><span style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">找到<span lang="EN-US">MPQ</span>文档的开始<span lang="EN-US">,</span>意义参看<span lang="EN-US"><a href="http://writeblog.csdn.net/Editor/FCKeditor/editor/MPQ文档布局分析.doc">MPQ<span lang="EN-US"><span lang="EN-US">文档<span lang="EN-US">布<span lang="EN-US">局分析</span></span></span></span></a></span>中对文档头的描述部分<span lang="EN-US">.<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; TEXT-ALIGN: left; mso-layout-grid-align: none" align="left"><span style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">此步稍微复杂<span lang="EN-US">:<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; TEXT-ALIGN: left; mso-layout-grid-align: none" align="left"><span style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">首先看一个为<span lang="EN-US">TMPQHeader2</span>结构<span lang="EN-US">.</span>原型如下<span lang="EN-US">:<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; TEXT-ALIGN: left; mso-layout-grid-align: none" align="left"><span lang="EN-US" style="FONT-SIZE: 12pt; COLOR: blue; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">struct</span><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"> <span style="COLOR: black">TMPQHeader2</span> : <span style="COLOR: blue">public</span> <span style="COLOR: black">TMPQHeader<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; TEXT-ALIGN: left; mso-layout-grid-align: none" align="left"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">{<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; TEXT-ALIGN: left; mso-layout-grid-align: none" align="left"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp; </span><span style="COLOR: green">// Offset to the beginning of the extended block table, relative to the beginning of the archive.<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; TEXT-ALIGN: left; mso-layout-grid-align: none" align="left"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp; </span><span style="COLOR: black">LARGE_INTEGER</span> <span style="COLOR: black">ExtBlockTablePos</span>;<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; TEXT-ALIGN: left; mso-layout-grid-align: none" align="left"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><o:p>&nbsp;</o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; TEXT-ALIGN: left; mso-layout-grid-align: none" align="left"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp; </span><span style="COLOR: green">// High 16 bits of the hash table offset for large archives.<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; TEXT-ALIGN: left; mso-layout-grid-align: none" align="left"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp; </span><span style="COLOR: black">USHORT</span> <span style="COLOR: black">wHashTablePosHigh</span>;<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; TEXT-ALIGN: left; mso-layout-grid-align: none" align="left"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><o:p>&nbsp;</o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; TEXT-ALIGN: left; mso-layout-grid-align: none" align="left"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp; </span><span style="COLOR: green">// High 16 bits of the block table offset for large archives.<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; TEXT-ALIGN: left; mso-layout-grid-align: none" align="left"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp; </span><span style="COLOR: black">USHORT</span> <span style="COLOR: black">wBlockTablePosHigh</span>;<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; TEXT-ALIGN: left; mso-layout-grid-align: none" align="left"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">};<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; TEXT-ALIGN: left; mso-layout-grid-align: none" align="left"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><o:p>&nbsp;</o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; TEXT-ALIGN: left; mso-layout-grid-align: none" align="left"><span lang="EN-US" style="FONT-SIZE: 12pt; COLOR: blue; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">struct</span><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"> <span style="COLOR: black">TMPQHeader<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; TEXT-ALIGN: left; mso-layout-grid-align: none" align="left"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">{<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; TEXT-ALIGN: left; mso-layout-grid-align: none" align="left"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp; </span><span style="COLOR: green">// The ID_MPQ ('MPQ/x<st1:chmetcnv w:st="on" tcsc="0" numbertype="1" negative="False" hasspace="False" sourcevalue="1" unitname="a">1A</st1:chmetcnv>') signature<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; TEXT-ALIGN: left; mso-layout-grid-align: none" align="left"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp; </span><span style="COLOR: black">DWORD</span> <span style="COLOR: black">dwID</span>;<span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; TEXT-ALIGN: left; mso-layout-grid-align: none" align="left"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><o:p>&nbsp;</o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; TEXT-ALIGN: left; mso-layout-grid-align: none" align="left"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp; </span><span style="COLOR: green">// Size of the archive header<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; TEXT-ALIGN: left; mso-layout-grid-align: none" align="left"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp; </span><span style="COLOR: black">DWORD</span> <span style="COLOR: black">dwHeaderSize</span>;<span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; TEXT-ALIGN: left; mso-layout-grid-align: none" align="left"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><o:p>&nbsp;</o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; TEXT-ALIGN: left; mso-layout-grid-align: none" align="left"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp; </span><span style="COLOR: green">// Size of MPQ archive<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; TEXT-ALIGN: left; mso-layout-grid-align: none" align="left"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp; </span><span style="COLOR: green">// This field is deprecated in the Burning Crusade MoPaQ format, and the size of the archive<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; TEXT-ALIGN: left; mso-layout-grid-align: none" align="left"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp; </span><span style="COLOR: green">// is calculated as the size from the beginning of the archive to the end of the hash table,<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; TEXT-ALIGN: left; mso-layout-grid-align: none" align="left"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp; </span><span style="COLOR: green">// block table, or extended block table (whichever is largest).<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; TEXT-ALIGN: left; mso-layout-grid-align: none" align="left"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp; </span><span style="COLOR: black">DWORD</span> <span style="COLOR: black">dwArchiveSize</span>;<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; TEXT-ALIGN: left; mso-layout-grid-align: none" align="left"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><o:p>&nbsp;</o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; TEXT-ALIGN: left; mso-layout-grid-align: none" align="left"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp; </span><span style="COLOR: green">// 0 = Original format<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; TEXT-ALIGN: left; mso-layout-grid-align: none" align="left"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp; </span><span style="COLOR: green">// 1 = Extended format (The Burning Crusade and newer)<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; TEXT-ALIGN: left; mso-layout-grid-align: none" align="left"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp; </span><span style="COLOR: black">USHORT</span> <span style="COLOR: black">wFormatVersion</span>;<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; TEXT-ALIGN: left; mso-layout-grid-align: none" align="left"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><o:p>&nbsp;</o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; TEXT-ALIGN: left; mso-layout-grid-align: none" align="left"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp; </span><span style="COLOR: green">// Power of two exponent specifying the number of 512-byte disk sectors in each logical sector<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; TEXT-ALIGN: left; mso-layout-grid-align: none" align="left"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp; </span><span style="COLOR: green">// in the archive. The size of each logical sector in the archive is 512 * 2^SectorSizeShift.<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; TEXT-ALIGN: left; mso-layout-grid-align: none" align="left"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp; </span><span style="COLOR: green">// Bugs in the Storm library dictate that this should always be 3 (4096 byte sectors).<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; TEXT-ALIGN: left; mso-layout-grid-align: none" align="left"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp; </span><span style="COLOR: black">USHORT</span> <span style="COLOR: black">wBlockSize</span>;<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; TEXT-ALIGN: left; mso-layout-grid-align: none" align="left"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><o:p>&nbsp;</o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; TEXT-ALIGN: left; mso-layout-grid-align: none" align="left"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp; </span><span style="COLOR: green">// Offset to the beginning of the hash table, relative to the beginning of the archive.<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; TEXT-ALIGN: left; mso-layout-grid-align: none" align="left"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp; </span><span style="COLOR: black">DWORD</span> <span style="COLOR: black">dwHashTablePos</span>;<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; TEXT-ALIGN: left; mso-layout-grid-align: none" align="left"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp; </span><o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; TEXT-ALIGN: left; mso-layout-grid-align: none" align="left"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp; </span><span style="COLOR: green">// Offset to the beginning of the block table, relative to the beginning of the archive.<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; TEXT-ALIGN: left; mso-layout-grid-align: none" align="left"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp; </span><span style="COLOR: black">DWORD</span> <span style="COLOR: black">dwBlockTablePos</span>;<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; TEXT-ALIGN: left; mso-layout-grid-align: none" align="left"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp; </span><o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; TEXT-ALIGN: left; mso-layout-grid-align: none" align="left"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp; </span><span style="COLOR: green">// Number of entries in the hash table. Must be a power of two, and must be less than 2^16 for<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; TEXT-ALIGN: left; mso-layout-grid-align: none" align="left"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp; </span><span style="COLOR: green">// the original MoPaQ format, or less than 2^20 for the Burning Crusade format.<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; TEXT-ALIGN: left; mso-layout-grid-align: none" align="left"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp; </span><span style="COLOR: black">DWORD</span> <span style="COLOR: black">dwHashTableSize</span>;<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; TEXT-ALIGN: left; mso-layout-grid-align: none" align="left"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp; </span><o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; TEXT-ALIGN: left; mso-layout-grid-align: none" align="left"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp; </span><span style="COLOR: green">// Number of entries in the block table<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; TEXT-ALIGN: left; mso-layout-grid-align: none" align="left"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp; </span><span style="COLOR: black">DWORD</span> <span style="COLOR: black">dwBlockTableSize</span>;<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; TEXT-ALIGN: left; mso-layout-grid-align: none" align="left"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">};<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; TEXT-ALIGN: left; mso-layout-grid-align: none" align="left"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><o:p>&nbsp;</o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; TEXT-ALIGN: left; mso-layout-grid-align: none" align="left"><span style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">实际意义也可以参看看<span lang="EN-US"><a href="http://writeblog.csdn.net/Editor/FCKeditor/editor/MPQ文档布局分析.doc">MPQ<span lang="EN-US"><span lang="EN-US">文档布局分析</span></span></a>,</span>就是整个文档头的结构<span lang="EN-US">.</span>而<span lang="EN-US">TMPQHeader, TMPQHeader2,</span>就是<span lang="EN-US" style="COLOR: black">wFormatVersion</span><span style="COLOR: black">为<span lang="EN-US">0,</span>和为<span lang="EN-US">1</span>时的两个文档头版本<span lang="EN-US">.<o:p></o:p></span></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; TEXT-ALIGN: left; mso-layout-grid-align: none" align="left"><span style="FONT-SIZE: 12pt; COLOR: black; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">这里通过循环来寻找<span lang="EN-US">MPQ</span>文档的开头<span lang="EN-US">:<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; TEXT-ALIGN: left; mso-layout-grid-align: none" align="left"><span lang="EN-US" style="FONT-SIZE: 12pt; COLOR: black; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><o:p>&nbsp;</o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; TEXT-ALIGN: left; mso-layout-grid-align: none" align="left"><span lang="EN-US" style="FONT-SIZE: 12pt; COLOR: black; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">{</span><span lang="EN-US" style="FONT-SIZE: 12pt; COLOR: #003300; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; TEXT-ALIGN: left; mso-layout-grid-align: none" align="left"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">a.</span><span style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">这里首先读取了一个<span lang="EN-US">TMPQHeader2</span>的文档头<span lang="EN-US">.<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; TEXT-ALIGN: left; mso-layout-grid-align: none" align="left"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><o:p>&nbsp;</o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; TEXT-ALIGN: left; mso-layout-grid-align: none" align="left"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">b.</span><span style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">然后经过恰当的大头小头机数据转换<span lang="EN-US">(</span>因为<span lang="EN-US">intel</span>是小头机并且是函数实现的默认方式<span lang="EN-US">,</span>此步其实完全忽略了<span lang="EN-US">,</span>以后不再提及<span lang="EN-US">,</span>但实际都需要这一步<span lang="EN-US">).<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; TEXT-ALIGN: left; mso-layout-grid-align: none" align="left"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><o:p>&nbsp;</o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; TEXT-ALIGN: left; mso-layout-grid-align: none" align="left"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">c.</span><span style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">在第一次循环的时候通过<span lang="EN-US">IsAviFile()</span>函数判断了一下此<span lang="EN-US">MPQ</span>文件是否是<span lang="EN-US">AVI</span>文件<span lang="EN-US">,</span>因为据源代码中注释说明<span lang="EN-US">,</span>当<span lang="EN-US">MPQ</span>文件实际就是<span lang="EN-US">AVI</span>文件的时候<span lang="EN-US">,</span>它仅仅是改变了扩展名的<span lang="EN-US">AVI</span>文件<span lang="EN-US">.(IsAviFile()</span>函数利用<span lang="EN-US">AVI</span>文件开始的数据标志实现<span lang="EN-US">)<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; TEXT-ALIGN: left; mso-layout-grid-align: none" align="left"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><o:p>&nbsp;</o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; TEXT-ALIGN: left; mso-layout-grid-align: none" align="left"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">d.</span><span style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">当实际读入的数据不等于<span lang="EN-US">TMPQHeader2</span>的大小的时候<span lang="EN-US">,</span>说明此文件中根本没有<span lang="EN-US">MPQ</span>文档<span lang="EN-US">,</span>断开循环<span lang="EN-US">,</span>并报错<span lang="EN-US">ERROR_BAD_FORMAT.<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; TEXT-ALIGN: left; mso-layout-grid-align: none" align="left"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><o:p>&nbsp;</o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; TEXT-ALIGN: left; mso-layout-grid-align: none" align="left"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">e.</span><span style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">判断读入的文档头数据是否指示此文档为一个<span lang="EN-US">MPQ shunt</span>的文档<span lang="EN-US">.</span>是的话保存相关数据在<span lang="EN-US">TMPQShunt</span>结构中<span lang="EN-US">.</span>并从<span lang="EN-US"> TMPQShunt</span>的<span lang="EN-US">dwHeaderPos</span>指示的位置开始继续搜寻<span lang="EN-US">MPQ</span>文档<span lang="EN-US">.</span>并且从最后<span lang="EN-US">Stromlib</span>处理来看<span lang="EN-US">,</span>此位置应该是紧接着就是文档头<span lang="EN-US">,</span>而不用继续通过跳转<span lang="EN-US">512</span>个字节循环搜寻<span lang="EN-US">.<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; TEXT-ALIGN: left; mso-layout-grid-align: none" align="left"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><o:p>&nbsp;</o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; TEXT-ALIGN: left; mso-layout-grid-align: none" align="left"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">struct TMPQShunt<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; TEXT-ALIGN: left; mso-layout-grid-align: none" align="left"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">{<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; TEXT-ALIGN: left; mso-layout-grid-align: none" align="left"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp; </span>// The ID_MPQ_SHUNT ('MPQ/x1B') signature<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; TEXT-ALIGN: left; mso-layout-grid-align: none" align="left"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp; </span>DWORD dwID;<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; TEXT-ALIGN: left; mso-layout-grid-align: none" align="left"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><o:p>&nbsp;</o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; TEXT-ALIGN: left; mso-layout-grid-align: none" align="left"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp; </span>DWORD dwUnknown;<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; TEXT-ALIGN: left; mso-layout-grid-align: none" align="left"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><o:p>&nbsp;</o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; TEXT-ALIGN: left; mso-layout-grid-align: none" align="left"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp; </span>// Position of the MPQ header, relative to the begin of the shunt<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; TEXT-ALIGN: left; mso-layout-grid-align: none" align="left"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp; </span>DWORD dwHeaderPos;<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; TEXT-ALIGN: left; mso-layout-grid-align: none" align="left"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">};<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt"><span lang="EN-US"><o:p><font face="Times New Roman" size="3">&nbsp;</font></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt"><font size="3"><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">因为</span><span lang="EN-US"><font face="Times New Roman">Shunt</font></span><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">部分没有相关文档的说明</span><span lang="EN-US"><font face="Times New Roman">,</font></span><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">从源代码中处理</span><span lang="EN-US"><font face="Times New Roman">Shunt</font></span><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">的方式</span><span lang="EN-US"><font face="Times New Roman">,</font></span><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">命名</span><span lang="EN-US"><font face="Times New Roman">,TMPQShunt</font></span><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">的结构来看</span><span lang="EN-US"><font face="Times New Roman">,</font></span><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">可能这是暴雪为了隐藏真正的</span><span lang="EN-US"><font face="Times New Roman">MPQ</font></span><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">文档而使用的一种机制</span><span lang="EN-US"><font face="Times New Roman">.</font></span><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">首先</span><span lang="EN-US"><font face="Times New Roman">,</font></span><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">一般情况下</span><span lang="EN-US"><font face="Times New Roman">MPQ</font></span><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">文档都是在一个扇区的边界</span><span lang="EN-US"><font face="Times New Roman">,</font></span><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">即</span><span lang="EN-US"><font face="Times New Roman">512</font></span><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">个字节的整数倍处</span><span lang="EN-US"><font face="Times New Roman">,</font></span><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">所以搜寻</span><span lang="EN-US"><font face="Times New Roman">MPQ</font></span><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">文档开头时</span><span lang="EN-US"><font face="Times New Roman">,</font></span><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">都是一次搜寻</span><span lang="EN-US"><font face="Times New Roman">512</font></span><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">个字节</span><span lang="EN-US"><font face="Times New Roman">.</font></span><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">而</span><span lang="EN-US"><font face="Times New Roman">Shunt</font></span><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">结构中用三个字节</span><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">dwHeaderPos</span></font><span style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">来指定<span lang="EN-US">MPQ</span>文档的开始部分<span lang="EN-US">,</span>可以离开上述约束<span lang="EN-US">.</span>并且<span lang="EN-US">Shunt</span>结构的<span lang="EN-US">dwID</span>与<span lang="EN-US">MPQ</span>文档头的<span lang="EN-US">dwID</span>都有</span><span lang="EN-US" style="FONT-SIZE: 12pt; mso-font-kerning: 0pt; mso-no-proof: yes; mso-fareast-font-family: 新宋体; mso-ascii-font-family: 新宋体"><font face="Times New Roman">&rdquo;</font></span><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">MPQ</span><span lang="EN-US" style="FONT-SIZE: 12pt; mso-font-kerning: 0pt; mso-no-proof: yes; mso-fareast-font-family: 新宋体; mso-ascii-font-family: 新宋体"><font face="Times New Roman">&rdquo;</font></span><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">,</span><span style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">无论一般用户是总是通过<span lang="EN-US">512</span>字节的整数倍来搜寻<span lang="EN-US">MPQ</span>文档头<span lang="EN-US">,</span>或是直接碰到</span><span lang="EN-US" style="FONT-SIZE: 12pt; mso-font-kerning: 0pt; mso-no-proof: yes; mso-fareast-font-family: 新宋体; mso-ascii-font-family: 新宋体"><font face="Times New Roman">&rdquo;</font></span><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">MPQ</span><span lang="EN-US" style="FONT-SIZE: 12pt; mso-font-kerning: 0pt; mso-no-proof: yes; mso-fareast-font-family: 新宋体; mso-ascii-font-family: 新宋体"><font face="Times New Roman">&rdquo;</font></span><span style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">就直接开始<span lang="EN-US">MPQ</span>文档的读取<span lang="EN-US">,</span>还是不理解<span lang="EN-US">shunt</span>结构的<span lang="EN-US">dwHeaderPos</span>意义<span lang="EN-US">,</span>都会导致读取<span lang="EN-US">MPQ</span>文档的错误<span lang="EN-US">.dwHeaderPos</span>的意义从注释上看还比较特殊<span lang="EN-US">,</span>它指示的含义为从一个<span lang="EN-US">shunt</span>结构开始的偏转值<span lang="EN-US">,</span>而不是相对于整个文件的偏转值<span lang="EN-US">,</span>就更加深了理解难度<span lang="EN-US">.</span>当然<span lang="EN-US">,</span>现在已经有人告诉我们了<span lang="EN-US">.....</span>巨人的肩膀上<span lang="EN-US">.....<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><o:p>&nbsp;</o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">f.</span><span style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">此时方才判断<span lang="EN-US">, </span>保存下来的<span lang="EN-US">TMPQHeader2</span>结构的<span lang="EN-US">dwID</span>成员是否<span lang="EN-US">MPQ</span>文档的<span lang="EN-US">(</span>即</span><span lang="EN-US" style="FONT-SIZE: 12pt; mso-font-kerning: 0pt; mso-no-proof: yes; mso-fareast-font-family: 新宋体; mso-ascii-font-family: 新宋体"><font face="Times New Roman">&rdquo;</font></span><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">MPQ</span><span lang="EN-US" style="FONT-SIZE: 12pt; mso-font-kerning: 0pt; mso-no-proof: yes; mso-fareast-font-family: 新宋体; mso-ascii-font-family: 新宋体"><font face="Times New Roman">&rdquo;</font></span><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">1AH),</span><span style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">找到后<span lang="EN-US">,</span>将地址结构保存在<span lang="EN-US">ha</span>的<span lang="EN-US">MpqPos</span>成员变量中<span lang="EN-US">.<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">g.</span><span style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">然后再通过判断版本号和获得的文档头大小是否一致来验证获得的文档头是否有效<span lang="EN-US">.</span>无效就断开循环<span lang="EN-US">,</span>结束查找<span lang="EN-US">.</span>注释说明在某些情况下<span lang="EN-US">(</span>比如<span lang="EN-US">W<st1:chmetcnv w:st="on" tcsc="0" numbertype="1" negative="False" hasspace="False" sourcevalue="3" unitname="m">3M</st1:chmetcnv> Map Protectors</span>中<span lang="EN-US">),</span>暴雪可能会在文档头文件中加入一些无效的干扰数据<span lang="EN-US">,</span>而<span lang="EN-US">strom.dll</span>文件明显忽略了这些东西<span lang="EN-US">,</span>也就是我们没有办法去理解这些数据<span lang="EN-US">.</span>继续也是徒劳<span lang="EN-US">.</span>这时返回错误信息<span lang="EN-US">ERROR_NOT_SUPPORTED.</span>暴雪的加密和干扰手段一个接一个<span lang="EN-US">,</span>还不止这些<span lang="EN-US">...........<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><o:p>&nbsp;</o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">h.</span><span style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">在此次循环中<span lang="EN-US">,</span>假如<span lang="EN-US">ha</span>成员变量的<span lang="EN-US">pShunt</span>指针指向不为空<span lang="EN-US">,</span>即表示已经经过了一次<span lang="EN-US">shunt</span>的跳转<span lang="EN-US">,</span>而通过上面几步的判断<span lang="EN-US">,</span>此处还是不为文档头<span lang="EN-US">,</span>表示文档已经损坏<span lang="EN-US">.<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><o:p>&nbsp;</o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt 36pt; TEXT-INDENT: -36pt; mso-list: l2 level1 lfo5; tab-stops: list 36.0pt"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes; mso-bidi-font-family: 新宋体"><span style="mso-list: Ignore">i.<span style='FONT: 7pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span><span style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">指针跳转<span lang="EN-US">512</span>个字节<span lang="EN-US">,</span>开始下一轮的搜寻<span lang="EN-US">.<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt"><span lang="EN-US" style="FONT-SIZE: 12pt; COLOR: #003300; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">}<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt"><span lang="EN-US" style="FONT-SIZE: 12pt; COLOR: #003300; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><o:p>&nbsp;</o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt 18pt; TEXT-INDENT: -18pt; mso-list: l4 level1 lfo2; tab-stops: list 18.0pt"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes; mso-bidi-font-family: 新宋体"><span style="mso-list: Ignore">5.<span style='FONT: 7pt "Times New Roman"'>&nbsp;&nbsp;&nbsp; </span></span></span><span style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">经过上一步<span lang="EN-US">,</span>没有错误的话<span lang="EN-US">,</span>应该得到了文档头<span lang="EN-US">,</span>此步先判断文档头的版本号<span lang="EN-US">,</span>是原始版本就清空扩展数据部分<span lang="EN-US">.<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><o:p>&nbsp;</o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt 18pt; TEXT-INDENT: -18pt; mso-list: l4 level1 lfo2; tab-stops: list 18.0pt"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes; mso-bidi-font-family: 新宋体"><span style="mso-list: Ignore">6.<span style='FONT: 7pt "Times New Roman"'>&nbsp;&nbsp;&nbsp; </span></span></span><span style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">通过文档头的数据判断<span lang="EN-US">,</span>确定<span lang="EN-US">dwBlockSize,</span>即一个块的大小<span lang="EN-US">,</span>计算方法如<span lang="EN-US">MPQ</span>文档布局中指出的</span><font size="3"><span lang="EN-US"><font face="Times New Roman">512 * (2^</font></span><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">扇区偏移大小</span><span lang="EN-US"><font face="Times New Roman">).stromlib</font></span><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">源代码中通过位移来完成</span><span lang="EN-US"><font face="Times New Roman">,</font></span><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">效果一样</span><font face="Times New Roman"><span lang="EN-US">.</span><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><o:p></o:p></span></font></font></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><o:p>&nbsp;</o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt 18pt; TEXT-INDENT: -18pt; mso-list: l4 level1 lfo2; tab-stops: list 18.0pt"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes; mso-bidi-font-family: 新宋体"><span style="mso-list: Ignore">7.<span style='FONT: 7pt "Times New Roman"'>&nbsp;&nbsp;&nbsp; </span></span></span><span style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">通过<span lang="EN-US" style="COLOR: black">RelocateMpqTablePositions()</span><span style="COLOR: black">函数</span>得到正确的哈希表和块表的位置<span lang="EN-US">.</span>文档头指示的哈希表<span lang="EN-US">,</span>块表位置其实都是相对于<span lang="EN-US">MPQ</span>文档开始位置而言<span lang="EN-US">, </span>此步的含义在于将其全部转换为相对于整个文件的位置<span lang="EN-US">,</span>并保存<span lang="EN-US">ha</span>的变量中<span lang="EN-US">.</span>同时还得到了整个<span lang="EN-US">MPQ</span>文档的大小<span lang="EN-US">.<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><o:p>&nbsp;</o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><o:p>&nbsp;</o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt"><span lang="EN-US" style="FONT-SIZE: 12pt; COLOR: black; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">RelocateMpqTablePositions()</span><span style="FONT-SIZE: 12pt; COLOR: black; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">函数的具体实现步骤如下<span lang="EN-US">:</span></span><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt"><span lang="EN-US" style="FONT-SIZE: 12pt; COLOR: #003300; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">{<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt"><span lang="EN-US" style="FONT-SIZE: 12pt; COLOR: #003300; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><o:p>&nbsp;</o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt 21pt; TEXT-INDENT: -21pt; mso-list: l6 level1 lfo3; tab-stops: list 21.0pt"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes; mso-bidi-font-family: 新宋体"><span style="mso-list: Ignore">a)<span style='FONT: 7pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span><span style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">先通过<span lang="EN-US">GetFileSize()</span>这个<span lang="EN-US">windows API</span>函数得到整个文件的大小<span lang="EN-US">.<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><o:p>&nbsp;</o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt 21pt; TEXT-INDENT: -21pt; mso-list: l6 level1 lfo3; tab-stops: list 21.0pt"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes; mso-bidi-font-family: 新宋体"><span style="mso-list: Ignore">b)<span style='FONT: 7pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span><span style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">通过将文档头中的哈希表<span lang="EN-US">,</span>块表偏移量加上第<span lang="EN-US">4</span>步中保存的文档头开始的位置<span lang="EN-US">,</span>得到的就是哈希表<span lang="EN-US">,</span>块表相对于整个文件开始的偏移量了<span lang="EN-US">.<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><o:p>&nbsp;</o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt 21pt; TEXT-INDENT: -21pt; mso-list: l6 level1 lfo3; tab-stops: list 21.0pt"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes; mso-bidi-font-family: 新宋体"><span style="mso-list: Ignore">c)<span style='FONT: 7pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span><span style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">是扩展版本的话<span lang="EN-US">,</span>还通过同样的方法<span lang="EN-US">,</span>得出了扩展块表相对于整个文件的偏移量<span lang="EN-US">.</span>此两步最后都通过和第<span lang="EN-US">1</span>步得到的文件大小做比较<span lang="EN-US">,</span>确定数据有效<span lang="EN-US">.<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><o:p>&nbsp;</o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt 21pt; TEXT-INDENT: -21pt; mso-list: l6 level1 lfo3; tab-stops: list 21.0pt"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes; mso-bidi-font-family: 新宋体"><span style="mso-list: Ignore">d)<span style='FONT: 7pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span><span style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">通过得到块表<span lang="EN-US">,</span>哈希表<span lang="EN-US">,</span>扩展块表三个中表的最后位置的最大值<span lang="EN-US">,</span>来确定整个<span lang="EN-US">MPQ</span>文档的结尾<span lang="EN-US">(</span>都是利用上几步得到的相对于整个文件开始位置的偏移量来计算的<span lang="EN-US">),</span>用此值减去文档头的位置<span lang="EN-US">(</span>也是相对于整个文件开始位置的偏移量<span lang="EN-US">)</span>来得到整个<span lang="EN-US">MPQ</span>文档的大小<span lang="EN-US">.<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><o:p>&nbsp;</o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><o:p>&nbsp;</o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt 18pt"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">{<span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp; </span><o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt 17.95pt; TEXT-INDENT: 24pt; mso-para-margin-left: 1.71gd; mso-char-indent-count: 2.0"><span style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">从此步中可以看出的结论是<span lang="EN-US">,</span>在<span lang="EN-US">MPQ</span>文档结构中<span lang="EN-US">,</span>各个表的实际位置不一定会像<span lang="EN-US"> &lt;MPQ</span>文档布局分析<span lang="EN-US">&gt;</span>中提到的那样<span lang="EN-US">,</span>是哈希表<span lang="EN-US">,</span>块表<span lang="EN-US">,</span>扩展块表的顺序<span lang="EN-US">,</span>因为各个表的位置都由文档头精确定位<span lang="EN-US">,</span>的确也可以不按此顺序<span lang="EN-US">.</span>所以<span lang="EN-US">stromlib</span>源代码中通过这种比较复杂的方法来得到整个文档的大小<span lang="EN-US">.</span>并且从<span lang="EN-US">stromlib</span>的计算方式来看<span lang="EN-US">,</span>起码表数据都是放在文档的最后<span lang="EN-US">.<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt 17.95pt; TEXT-INDENT: 24pt; mso-para-margin-left: 1.71gd; mso-char-indent-count: 2.0"><span style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">可是个人认为太过于复杂<span lang="EN-US">,</span>就算三个表的先后顺序是不确定的<span lang="EN-US">,</span>但是三个表的所有入口都是一个接一个的<span lang="EN-US">,</span>意思就是<span lang="EN-US">,</span>不可能三个表混在一起<span lang="EN-US">,</span>那么<span lang="EN-US">,</span>要得到整个文档的大小<span lang="EN-US">,</span>只需要先判断三个表的偏移量哪个最大<span lang="EN-US">(</span>在未计算前<span lang="EN-US">,</span>文档头中指示的数据都是相对于<span lang="EN-US">MPQ</span>文档开始的偏移量<span lang="EN-US">),</span>再将最大偏移量的那个值加上其相对应的表大小<span lang="EN-US">,</span>得出的偏移量<span lang="EN-US">,</span>就是整个<span lang="EN-US">MPQ</span>文档的大小<span lang="EN-US">,</span>因为此偏移量也是相对与<span lang="EN-US">MPQ</span>文档开始的位置而言<span lang="EN-US">,</span>并且是文档的结尾<span lang="EN-US">.<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; TEXT-INDENT: 24pt; mso-char-indent-count: 2.0"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">}<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt"><span lang="EN-US" style="FONT-SIZE: 12pt; COLOR: #003300; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">}<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt"><span lang="EN-US" style="FONT-SIZE: 12pt; COLOR: #003300; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><o:p>&nbsp;</o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt 18pt; TEXT-INDENT: -18pt; mso-list: l4 level1 lfo2; tab-stops: list 18.0pt"><span lang="EN-US" style="FONT-SIZE: 12pt; COLOR: black; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes; mso-bidi-font-family: 新宋体"><span style="mso-list: Ignore">8.<span style='FONT: 7pt "Times New Roman"'>&nbsp;&nbsp;&nbsp; </span></span></span><span lang="EN-US" style="FONT-SIZE: 12pt; COLOR: #003300; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">stormlib</span><span style="FONT-SIZE: 12pt; COLOR: #003300; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">源代码中此时为哈希表<span lang="EN-US">,</span>块表<span lang="EN-US">,</span>扩展块表<span lang="EN-US">,</span>块分别分配了空间<span lang="EN-US">,</span>并将<span lang="EN-US">ha</span>的成员变量中</span><span lang="EN-US" style="FONT-SIZE: 12pt; COLOR: black; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">pHashTable</span><span lang="EN-US" style="FONT-SIZE: 12pt; COLOR: #003300; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">,</span><span lang="EN-US" style="FONT-SIZE: 12pt; COLOR: black; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"> pBlockTable</span><span lang="EN-US" style="FONT-SIZE: 12pt; COLOR: #003300; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">,</span><span lang="EN-US" style="FONT-SIZE: 12pt; COLOR: black; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"> pExtBlockTable</span><span lang="EN-US" style="FONT-SIZE: 12pt; COLOR: #003300; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">,</span><span lang="EN-US" style="FONT-SIZE: 12pt; COLOR: black; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"> pbBlockBuffer</span><span style="FONT-SIZE: 12pt; COLOR: #003300; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">指向相应地址<span lang="EN-US">.</span>假如分配失败<span lang="EN-US">,</span>返回</span><span lang="EN-US" style="FONT-SIZE: 12pt; COLOR: black; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">ERROR_NOT_ENOUGH_MEMORY.</span><span style="FONT-SIZE: 12pt; COLOR: black; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">这里<span lang="EN-US">stromlib</span>还指出<span lang="EN-US">,</span>为了以后文件的添加<span lang="EN-US">,</span>块表应该和哈希表一样大<span lang="EN-US">.</span>通过这样的方式来避免最后缓存的溢出<span lang="EN-US">.<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt"><span lang="EN-US" style="FONT-SIZE: 12pt; COLOR: black; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><o:p>&nbsp;</o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt 18pt; TEXT-INDENT: -18pt; mso-list: l4 level1 lfo2; tab-stops: list 18.0pt"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes; mso-bidi-font-family: 新宋体"><span style="mso-list: Ignore">9.<span style='FONT: 7pt "Times New Roman"'>&nbsp;&nbsp;&nbsp; </span></span></span><span style="FONT-SIZE: 12pt; COLOR: black; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">将整个哈希表都读入<span lang="EN-US">ha</span>的<span lang="EN-US">pHashTalbe</span>指向的空间中<span lang="EN-US">.</span>因为已可以计算出哈希表大小<span lang="EN-US">,</span>假如读入的数据不对<span lang="EN-US">,</span>表示此文档已损坏<span lang="EN-US">,</span>返回<span lang="EN-US">ERROR_FILE_CORRUPT</span>错误<span lang="EN-US">.</span>此时还是加密数据<span lang="EN-US">.</span>以</span><span lang="EN-US" style="FONT-SIZE: 12pt; COLOR: black; mso-font-kerning: 0pt; mso-no-proof: yes; mso-fareast-font-family: 新宋体; mso-ascii-font-family: 新宋体"><font face="Times New Roman">&rdquo;</font></span><span lang="EN-US" style="FONT-SIZE: 12pt; COLOR: black; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">(hash table</span><span lang="EN-US" style="FONT-SIZE: 12pt; COLOR: black; mso-font-kerning: 0pt; mso-no-proof: yes; mso-fareast-font-family: 新宋体; mso-ascii-font-family: 新宋体"><font face="Times New Roman">&rdquo;</font></span><span style="FONT-SIZE: 12pt; COLOR: black; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">为<span lang="EN-US">key,</span></span><span style="FONT-SIZE: 12pt; COLOR: #003300; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">调用<span lang="EN-US">DecryptHashTable()</span>函数<span lang="EN-US">,</span>解密数据<span lang="EN-US">.</span>此时<span lang="EN-US">stromlib</span>注释中提到<span lang="EN-US">,</span></span><span lang="EN-US" style="FONT-SIZE: 12pt; COLOR: green; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"> </span><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">MPQ protectors</span><span style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">甚至可能通过重写一部分哈希表来干扰别人的读取<span lang="EN-US">,</span>而整个哈希表只要一开始有一个位不对<span lang="EN-US">,</span>后面的所有数据都是无效的<span lang="EN-US">........</span>暂时不知道怎么检查<span lang="EN-US">....<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><o:p>&nbsp;</o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt 18pt; TEXT-INDENT: -18pt; mso-list: l4 level1 lfo2; tab-stops: list 18.0pt"><span lang="EN-US" style="FONT-SIZE: 12pt; COLOR: black; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes; mso-bidi-font-family: 新宋体"><span style="mso-list: Ignore">10.</span></span><span style="FONT-SIZE: 12pt; COLOR: black; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">将整个块表都读入<span lang="EN-US">ha</span>的<span lang="EN-US">pBlockTalbe</span>指向的空间中<span lang="EN-US">,</span>因为当文件删除时<span lang="EN-US">,</span>似乎会出现文档头声明的块表入口数量多于实际块表入口数量的情况<span lang="EN-US">,</span>读入的数据少于文档头声明数量时<span lang="EN-US">,</span>要以实际读入的数据为准<span lang="EN-US">.</span>在解密的时候<span lang="EN-US">,</span>为了防止出现原块表头没有加密而重复解密导致错误的情况<span lang="EN-US">.stromlib</span>中首先判断了一下原块表是否被加密<span lang="EN-US">.(</span></span><font size="3"><span lang="EN-US"><font face="Times New Roman"> </font></span><span style="FONT-SIZE: 12pt; COLOR: black; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">通过块的位掩码标志位低<span lang="EN-US">8</span>位总为零的情况来判断<span lang="EN-US">,</span>详见<span lang="EN-US">&lt;MPQ</span>文档布局分析<span lang="EN-US">&gt;,</span>不为<span lang="EN-US">0</span>即加密过的数据</span><span lang="EN-US"><font face="Times New Roman">)</font></span></font><span style="FONT-SIZE: 12pt; COLOR: black; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">加密的话<span lang="EN-US">,</span>以</span><span lang="EN-US" style="FONT-SIZE: 12pt; COLOR: black; mso-font-kerning: 0pt; mso-no-proof: yes; mso-fareast-font-family: 新宋体; mso-ascii-font-family: 新宋体"><font face="Times New Roman">&rdquo;</font></span><span lang="EN-US" style="FONT-SIZE: 12pt; COLOR: black; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">(block table)</span><span lang="EN-US" style="FONT-SIZE: 12pt; COLOR: black; mso-font-kerning: 0pt; mso-no-proof: yes; mso-fareast-font-family: 新宋体; mso-ascii-font-family: 新宋体"><font face="Times New Roman">&rdquo;</font></span><span style="FONT-SIZE: 12pt; COLOR: black; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">为<span lang="EN-US">key</span>调用<span lang="EN-US">DecryptBlockTable()</span>函数解密<span lang="EN-US">.<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt"><span lang="EN-US" style="FONT-SIZE: 12pt; COLOR: black; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><o:p>&nbsp;</o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt 18pt; TEXT-INDENT: -18pt; mso-list: l4 level1 lfo2; tab-stops: list 18.0pt"><span lang="EN-US" style="FONT-SIZE: 12pt; COLOR: black; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes; mso-bidi-font-family: 新宋体"><span style="mso-list: Ignore">11.</span></span><span style="FONT-SIZE: 12pt; COLOR: black; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">将整个扩展块表都读入<span lang="EN-US">ha</span>的<span lang="EN-US">pExtBlockTalbe</span>指向的空间中<span lang="EN-US">,</span>原始版本中即将此块清零<span lang="EN-US">,</span>燃烧远征版本就读入此数据<span lang="EN-US">.stromlib</span>中没有解密过程<span lang="EN-US">.</span>就我猜测可能此扩展部分为未加密的原始数据<span lang="EN-US">.</span>就暴雪的作风好像很难得<span lang="EN-US">,</span>要么就是还没有人分析出扩展块表的解密算法<span lang="EN-US">............<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt"><span lang="EN-US" style="FONT-SIZE: 12pt; COLOR: black; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><o:p>&nbsp;</o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt 18pt; TEXT-INDENT: -18pt; mso-list: l4 level1 lfo2; tab-stops: list 18.0pt"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes; mso-bidi-font-family: 新宋体"><span style="mso-list: Ignore">12.</span></span><span style="FONT-SIZE: 12pt; COLOR: black; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">此时<span lang="EN-US">stromlib</span>作者为了确定块表解密正确<span lang="EN-US">,</span>进行了一些判断<span lang="EN-US">.</span>具体方法就是判断各块表入口指向的地址和指向块的大小是否都在<span lang="EN-US">MPQ</span>文档大小以内<span lang="EN-US">.</span>不是<span lang="EN-US">,</span>自然解密出现了问题<span lang="EN-US">,</span>返回错误代码<span lang="EN-US">ERROR_BAD_FORMAT</span></span><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">.</span><span style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">另外<span lang="EN-US">,</span>不知道是否是我没有找到<span lang="EN-US">,stromlib</span>源代码中定义了<span lang="EN-US"> DWORD dwMaxBlockIndex = 0;</span>后就再也没有对其赋过其他值<span lang="EN-US">,</span>而直接通过这种方式<span lang="EN-US">TMPQBlock * pBlockEnd = ha-&gt;pBlockTable + dwMaxBlockIndex + 1;</span>得到块的结尾<span lang="EN-US">....</span>似乎有点问题<span lang="EN-US">.</span>个人觉得此处的<span lang="EN-US">dwMaxBlockIndex</span>应该等于第<span lang="EN-US">10</span>步中得到的实际块表入口数量<span lang="EN-US">.</span>不然源代码中相当于只验证了第一个块表入口<span lang="EN-US">.<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><o:p>&nbsp;</o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt 18pt; TEXT-INDENT: -18pt; mso-list: l4 level1 lfo2; tab-stops: list 18.0pt"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes; mso-bidi-font-family: 新宋体"><span style="mso-list: Ignore">13.</span></span><span style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">假如调用时没有在</span><font size="3"><span lang="EN-US"><font face="Times New Roman">SFileOpenArchive()</font></span><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">函数的第三参数指定不打开</span><span lang="EN-US"><font face="Times New Roman">listfile,</font></span><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">那么就将</span><span lang="EN-US"><font face="Times New Roman">listfile</font></span><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">文件读入</span><span lang="EN-US"><font face="Times New Roman">ha,listfile</font></span><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">的具体含义和结构</span><span lang="EN-US"><font face="Times New Roman">,</font></span><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">参看</span></font><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><a href="http://writeblog.csdn.net/Editor/FCKeditor/editor/MPQ文档布局分析.doc">MPQ<span lang="EN-US"><span lang="EN-US">文档布局分析</span></span></a></span><span style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">相关部分<span lang="EN-US">.<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><o:p>&nbsp;</o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><o:p>&nbsp;</o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">{<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt 18pt; TEXT-INDENT: -18pt; mso-list: l0 level1 lfo4; tab-stops: list 18.0pt"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes; mso-bidi-font-family: 新宋体"><span style="mso-list: Ignore">a.<span style='FONT: 7pt "Times New Roman"'>&nbsp;&nbsp;&nbsp; </span></span></span><span style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">此步首先利用<span lang="EN-US" style="COLOR: black">SListFileCreateListFile()</span><span style="COLOR: black">函数在<span lang="EN-US">ha</span>中为<span lang="EN-US">listfile</span>的相关成员变量分配空间<span lang="EN-US">.<o:p></o:p></span></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt 18pt; TEXT-INDENT: -18pt; mso-list: l0 level1 lfo4; tab-stops: list 18.0pt"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes; mso-bidi-font-family: 新宋体"><span style="mso-list: Ignore">b.<span style='FONT: 7pt "Times New Roman"'>&nbsp;&nbsp;&nbsp; </span></span></span><span style="FONT-SIZE: 12pt; COLOR: black; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">然后调用<span lang="EN-US">SFileAddListFile()</span>函数实际的添加数据<span lang="EN-US">.</span>此一步函数相当于整个一个从<span lang="EN-US">MPQ</span>文档中读取文件的过程<span lang="EN-US">,</span>只不过文件名为</span><span lang="EN-US" style="FONT-SIZE: 12pt; COLOR: black; mso-font-kerning: 0pt; mso-no-proof: yes; mso-fareast-font-family: 新宋体; mso-ascii-font-family: 新宋体"><font face="Times New Roman">&rdquo;</font></span><span lang="EN-US" style="FONT-SIZE: 12pt; COLOR: black; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">(listfile)</span><span lang="EN-US" style="FONT-SIZE: 12pt; COLOR: black; mso-font-kerning: 0pt; mso-no-proof: yes; mso-fareast-font-family: 新宋体; mso-ascii-font-family: 新宋体"><font face="Times New Roman">&rdquo;</font></span><span lang="EN-US" style="FONT-SIZE: 12pt; COLOR: black; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">.</span><span style="FONT-SIZE: 12pt; COLOR: black; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">然后通过<span lang="EN-US">GetLine()</span>函数每次读取一行并添加到相关链表中而已<span lang="EN-US">.</span></span><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">}<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><o:p>&nbsp;</o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt 18pt; TEXT-INDENT: -18pt; mso-list: l4 level1 lfo2; tab-stops: list 18.0pt"><span lang="EN-US" style="FONT-SIZE: 12pt; COLOR: black; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes; mso-bidi-font-family: 新宋体"><span style="mso-list: Ignore">14.</span></span><span style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">假如调用时没有在</span><font size="3"><span lang="EN-US"><font face="Times New Roman">SFileOpenArchive()</font></span><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">函数的第三参数指定不读入属性</span><span lang="EN-US"><font face="Times New Roman">,</font></span><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">就调用</span><span lang="EN-US"><font face="Times New Roman">SAttrFileLoad()</font></span><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">函数读入属性数据</span><span lang="EN-US"><font face="Times New Roman">.</font></span><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">此步的实际过程与上面读入</span><span lang="EN-US"><font face="Times New Roman">listfile</font></span><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">很类似</span><span lang="EN-US"><font face="Times New Roman">,</font></span><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">也是一个完整的</span></font><span style="FONT-SIZE: 12pt; COLOR: black; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">一个从<span lang="EN-US">MPQ</span>文档中读取文件的过程<span lang="EN-US">,</span>只不过文件名为</span><span lang="EN-US" style="FONT-SIZE: 12pt; COLOR: black; mso-font-kerning: 0pt; mso-no-proof: yes; mso-fareast-font-family: 新宋体; mso-ascii-font-family: 新宋体"><font face="Times New Roman">&rdquo;</font></span><span lang="EN-US" style="FONT-SIZE: 12pt; COLOR: maroon; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"> (attributes)</span><span lang="EN-US" style="FONT-SIZE: 12pt; COLOR: black; mso-font-kerning: 0pt; mso-no-proof: yes; mso-fareast-font-family: 新宋体; mso-ascii-font-family: 新宋体"><font face="Times New Roman">&rdquo;</font></span><span lang="EN-US" style="FONT-SIZE: 12pt; COLOR: black; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">.<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt"><span lang="EN-US" style="FONT-SIZE: 12pt; COLOR: black; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><o:p>&nbsp;</o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt 18pt; TEXT-INDENT: -18pt; mso-list: l4 level1 lfo2; tab-stops: list 18.0pt"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes; mso-bidi-font-family: 新宋体"><span style="mso-list: Ignore">15.</span></span><span style="FONT-SIZE: 12pt; COLOR: black; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">最后<span lang="EN-US">,</span>假如中途出现错误<span lang="EN-US">,</span>先利用<span lang="EN-US">FreeMPQArchive()</span>函数释放<span lang="EN-US">ha</span>的空间<span lang="EN-US">,</span>再关闭文件句柄<span lang="EN-US">,</span>设定错误代码为上述步骤中设定的错误代码值<span lang="EN-US">.</span></span><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><o:p>&nbsp;</o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt 18pt; TEXT-INDENT: -18pt; mso-list: l4 level1 lfo2; tab-stops: list 18.0pt"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes; mso-bidi-font-family: 新宋体"><span style="mso-list: Ignore">16.</span></span><span style="FONT-SIZE: 12pt; COLOR: black; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">一切正确的时候<span lang="EN-US">, </span>且全局变量<span lang="EN-US">pFirstOpen</span>为空<span lang="EN-US">,</span>即将打开文件的句柄赋值给<span lang="EN-US">pFileOpen,</span>再赋值给</span><font size="3"><span lang="EN-US"><font face="Times New Roman">SFileOpenArchive()</font></span><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">函数的第四参数</span><span lang="EN-US"><font face="Times New Roman">,</font></span><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">作为一个输出</span><span lang="EN-US"><font face="Times New Roman">,</font></span><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">同时返回</span><span lang="EN-US" style="FONT-SIZE: 12pt; COLOR: black; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">ERROR_SUCCESS</span></font><span style="FONT-SIZE: 12pt; COLOR: black; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">表示此函数调用成功<span lang="EN-US">.</span></span><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt"><span lang="EN-US" style="FONT-SIZE: 12pt; COLOR: black; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><o:p>&nbsp;</o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt"><span style="FONT-SIZE: 12pt; COLOR: black; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">至此<span lang="EN-US">, </span></span><font size="3"><span lang="EN-US"><font face="Times New Roman">SFileOpenArchive()</font></span><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">函数的全过程理解完毕</span><span lang="EN-US"><font face="Times New Roman">.</font></span><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">因为此步的意义在于将一个纯粹二进制的文件的文档头</span><span lang="EN-US"><font face="Times New Roman">,</font></span><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">哈希表</span><span lang="EN-US"><font face="Times New Roman">,</font></span><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">块表</span><span lang="EN-US"><font face="Times New Roman">,</font></span><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">扩展块表</span><span lang="EN-US"><font face="Times New Roman">,</font></span><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">尽量正确的分别读出</span><span lang="EN-US"><font face="Times New Roman">,</font></span><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">解释</span><span lang="EN-US"><font face="Times New Roman">,</font></span><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">保存在一个指向</span><span lang="EN-US" style="FONT-SIZE: 12pt; COLOR: black; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">TMPQArchive</span></font><span style="FONT-SIZE: 12pt; COLOR: black; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">结构的指针变量<span lang="EN-US">ha</span>中<span lang="EN-US">.</span>每一步都需要非常正确<span lang="EN-US">,</span>容不得一点错误<span lang="EN-US">,</span>所以<span lang="EN-US">stromlib</span>作者每一步都加入了足够多的错误验证<span lang="EN-US">.</span>每一步也都要预防暴雪对文件的加密<span lang="EN-US">,</span>所以代码相当的琐碎<span lang="EN-US">.</span>理解起来也的确花了过多的时间<span lang="EN-US">.<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt"><span lang="EN-US" style="FONT-SIZE: 12pt; COLOR: black; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><o:p>&nbsp;</o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt"><span lang="EN-US" style="FONT-SIZE: 12pt; COLOR: black; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><o:p>&nbsp;</o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt"><span lang="EN-US"><font face="Times New Roman" size="3">SFileOpenFileEx()</font></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt 39pt; TEXT-INDENT: -18pt; mso-list: l0 level2 lfo4; tab-stops: list 39.0pt"><span lang="EN-US" style="mso-fareast-font-family: 'Times New Roman'"><span style="mso-list: Ignore"><font face="Times New Roman"><font size="3">1.</font><span style='FONT: 7pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></font></span></span><font size="3"><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">首先验证参数是否都有意义</span><span lang="EN-US"><font face="Times New Roman">.</font></span></font></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt 21pt"><span lang="EN-US"><o:p><font face="Times New Roman" size="3">&nbsp;</font></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt 39pt; TEXT-INDENT: -18pt; mso-list: l0 level2 lfo4; tab-stops: list 39.0pt"><span lang="EN-US" style="FONT-SIZE: 12pt; COLOR: black; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes; mso-bidi-font-family: 新宋体"><span style="mso-list: Ignore">2.<span style='FONT: 7pt "Times New Roman"'>&nbsp;&nbsp;&nbsp; </span></span></span><font size="3"><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">当</span><span lang="EN-US" style="FONT-SIZE: 12pt; COLOR: black; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">SFileOpenFileEx()</span></font><span style="FONT-SIZE: 12pt; COLOR: black; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">函数第三个参数为<span lang="EN-US">SFILE_OPEN_BY_INDEX</span>时<span lang="EN-US">,</span>即通过文件索引来定位文件<span lang="EN-US">,</span>此索引实际就是块表入口的索引<span lang="EN-US">,</span>这里需要特别注意的是<span lang="EN-US">,</span>此处是索引<span lang="EN-US">,</span>就像数组的索引一样<span lang="EN-US">,</span>而不是偏移量<span lang="EN-US">.</span>就如在<span lang="EN-US">&lt;MPQ</span>文档布局分析<span lang="EN-US">&gt;</span>中根据哈希表数据猜测的一样<span lang="EN-US">,</span>哈希表最后一个值实际也是记录对应块表的索引<span lang="EN-US">,</span>而不是偏移量<span lang="EN-US">.</span>所以<span lang="EN-US">,</span>此步就是遍历整个哈希表<span lang="EN-US">,</span>判断此哈希表入口的最后一个值<span lang="EN-US">(</span>即对应块表的索引<span lang="EN-US">)</span>是否等于此索引<span lang="EN-US">,</span>等于即表示找到对应的哈希表入口<span lang="EN-US">.</span>但是在测试程序中<span lang="EN-US">,</span>我用索引调用此函数一直没有成功<span lang="EN-US">,</span>原因不明<span lang="EN-US">.<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt"><span lang="EN-US" style="FONT-SIZE: 12pt; COLOR: black; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><o:p>&nbsp;</o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt 39pt; TEXT-INDENT: -18pt; mso-list: l0 level2 lfo4; tab-stops: list 39.0pt"><span lang="EN-US" style="FONT-SIZE: 12pt; COLOR: black; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes; mso-bidi-font-family: 新宋体"><span style="mso-list: Ignore">3.<span style='FONT: 7pt "Times New Roman"'>&nbsp;&nbsp;&nbsp; </span></span></span><font size="3"><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">当</span><span lang="EN-US" style="FONT-SIZE: 12pt; COLOR: black; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">SFileOpenFileEx()</span></font><span style="FONT-SIZE: 12pt; COLOR: black; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">函数第三个参数为<span lang="EN-US">SFILE_OPEN_LOCAL_FILE</span>时<span lang="EN-US">,</span>调用<span lang="EN-US">OpenLocalFile()</span>函数打开本地磁盘的文件<span lang="EN-US">.<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt"><span lang="EN-US" style="FONT-SIZE: 12pt; COLOR: black; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><o:p>&nbsp;</o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt 39pt; TEXT-INDENT: -18pt; mso-list: l0 level2 lfo4; tab-stops: list 39.0pt"><span lang="EN-US" style="FONT-SIZE: 12pt; COLOR: black; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes; mso-bidi-font-family: 新宋体"><span style="mso-list: Ignore">4.<span style='FONT: 7pt "Times New Roman"'>&nbsp;&nbsp;&nbsp; </span></span></span><font size="3"><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">当</span><span lang="EN-US" style="FONT-SIZE: 12pt; COLOR: black; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">SFileOpenFileEx()</span><span style="FONT-SIZE: 12pt; COLOR: black; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">函数第三个参数为<span lang="EN-US">0</span>或者说是<span lang="EN-US">SFILE_OPEN_FROM_MPQ</span>时<span lang="EN-US">,</span>才是最常用的调用方式<span lang="EN-US">,</span>即以完整路径的文件名为第二参数<span lang="EN-US">,</span>确定要打开的文件<span lang="EN-US">.</span></span><span lang="EN-US"><font face="Times New Roman"> </font></span><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">此步较为重要</span><span lang="EN-US"><font face="Times New Roman">,</font></span><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">最主要的步骤即调用</span><span lang="EN-US"><font face="Times New Roman">GetHashEntryEx()</font></span><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">函数得到相应的语言版本的此文件名对应的哈希表入口</span><font face="Times New Roman"><span lang="EN-US">.</span><span lang="EN-US" style="FONT-SIZE: 12pt; COLOR: black; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><o:p></o:p></span></font></font></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt"><span lang="EN-US" style="FONT-SIZE: 12pt; COLOR: black; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><o:p>&nbsp;</o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt 21pt"><span lang="EN-US" style="FONT-SIZE: 12pt; COLOR: black; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><o:p>&nbsp;</o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt 21pt"><span lang="EN-US"><font face="Times New Roman" size="3">{</font></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt 21pt; TEXT-INDENT: 21pt; mso-para-margin-left: 2.0gd; mso-char-indent-count: 2.0"><font size="3"><span lang="EN-US"><font face="Times New Roman">GetHashEntryEx()</font></span><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">函数的具体实现又调用了</span><span lang="EN-US"><font face="Times New Roman">GetHashEntry()</font></span><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">函数来得到此任何语言的此文件名确定的哈希表入口</span><span lang="EN-US"><font face="Times New Roman">.</font></span></font></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt 21pt; TEXT-INDENT: 21pt; mso-para-margin-left: 2.0gd; mso-char-indent-count: 2.0"><font size="3"><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">首先看</span><span lang="EN-US"><font face="Times New Roman">GetHashEntry()</font></span><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">函数的实现</span><span lang="EN-US"><font face="Times New Roman">:</font></span></font></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt 21pt; TEXT-INDENT: 21pt; mso-para-margin-left: 2.0gd; mso-char-indent-count: 2.0"><span lang="EN-US"><o:p><font face="Times New Roman" size="3">&nbsp;</font></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt 21pt; TEXT-INDENT: 21pt; mso-para-margin-left: 2.0gd; mso-char-indent-count: 2.0"><span lang="EN-US"><font face="Times New Roman" size="3">{</font></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt 42pt; TEXT-INDENT: -21pt; mso-list: l2 level2 lfo5; tab-stops: list 42.0pt"><span lang="EN-US" style="mso-fareast-font-family: 'Times New Roman'"><span style="mso-list: Ignore"><font face="Times New Roman"><font size="3">a)</font><span style='FONT: 7pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></font></span></span><font size="3"><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">首先</span><span lang="EN-US"><font face="Times New Roman">stromlib</font></span><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">在此函数中也判断了一下第二参数的文件名是否是作为一个索引给出的</span><span lang="EN-US"><font face="Times New Roman">.</font></span><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">这里作者通过判断此值是否小于块表的数量来判断</span><span lang="EN-US"><font face="Times New Roman">,</font></span><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">当的确小于块表的数量时</span><span lang="EN-US"><font face="Times New Roman">,</font></span><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">作者认为此数值为一个索引</span><span lang="EN-US"><font face="Times New Roman">,</font></span><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">得到哈希表的入口的方法与</span><span lang="EN-US"><font face="Times New Roman">SFileOpenFileEx()</font></span><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">函数第</span><span lang="EN-US"><font face="Times New Roman">2</font></span><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">步一样</span><span lang="EN-US"><font face="Times New Roman">.</font></span></font></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt 21pt"><span lang="EN-US"><o:p><font face="Times New Roman" size="3">&nbsp;</font></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt 42pt; TEXT-INDENT: -21pt; mso-list: l2 level2 lfo5; tab-stops: list 42.0pt"><span lang="EN-US" style="mso-fareast-font-family: 'Times New Roman'"><span style="mso-list: Ignore"><font face="Times New Roman"><font size="3">b)</font><span style='FONT: 7pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></font></span></span><font size="3"><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">当经过判断不是以索引来搜索哈希表入口的时候</span><span lang="EN-US"><font face="Times New Roman">,</font></span><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">即表示第二参数的确是以完整路径文件名给出的</span><span lang="EN-US"><font face="Times New Roman">.stromlib</font></span><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">作者首先将此参数用</span><span lang="EN-US" style="FONT-SIZE: 12pt; COLOR: black; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">DecryptHashIndex()</span><span style="FONT-SIZE: 12pt; COLOR: black; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">得到<span lang="EN-US">home</span>入口<span lang="EN-US">,</span>此入口是一个<span lang="EN-US">DWORD</span>值的索引值<span lang="EN-US">.</span>用<span lang="EN-US">DecryptName1(),DecryptName2()</span></span><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">进行了</span><span lang="EN-US"><font face="Times New Roman">2</font></span><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">次哈希运算得到两个用来验证的值</span><span lang="EN-US"><font face="Times New Roman">.</font></span><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">大概理论方法在</span><span lang="EN-US"><font face="Times New Roman">&lt;MPQ</font></span><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">文档布局分析</span><span lang="EN-US"><font face="Times New Roman">&gt;</font></span><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">哈希表一节有所描述</span><span lang="EN-US"><font face="Times New Roman">.</font></span></font></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt"><span lang="EN-US"><o:p><font face="Times New Roman" size="3">&nbsp;</font></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt 21pt"><span lang="EN-US"><o:p><font face="Times New Roman" size="3">&nbsp;</font></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt 42pt; TEXT-INDENT: -21pt; mso-list: l2 level2 lfo5; tab-stops: list 42.0pt"><span lang="EN-US" style="mso-fareast-font-family: 'Times New Roman'"><span style="mso-list: Ignore"><font face="Times New Roman"><font size="3">c)</font><span style='FONT: 7pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></font></span></span><font size="3"><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">此时循环查找两个验证值都符合且此哈希表入口的文件块索引</span><span lang="EN-US"><font face="Times New Roman">(BlockIndex)</font></span><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">不为</span><span lang="EN-US" style="FONT-SIZE: 12pt; COLOR: black; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">HASH_ENTRY_DELETED(</span><span lang="EN-US"><font face="Times New Roman">FF FF FF FEH</font></span><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">表示此文件已被删除</span><span lang="EN-US"><font face="Times New Roman">)</font></span><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">的哈希表入口</span><span lang="EN-US"><font face="Times New Roman">,</font></span><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">此时此入口即为正确入口</span><span lang="EN-US"><font face="Times New Roman">,</font></span><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">返回</span><span lang="EN-US"><font face="Times New Roman">.</font></span><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">不然循环查找</span><span lang="EN-US"><font face="Times New Roman">,</font></span><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">直到某哈希表入口的文件块索引</span><span lang="EN-US"><font face="Times New Roman">(BlockIndex)</font></span><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">为</span><span lang="EN-US" style="FONT-SIZE: 12pt; COLOR: black; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">HASH_ENTRY_FREE(FF FF FF FFH)</span></font><span style="FONT-SIZE: 12pt; COLOR: black; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">或已经遍历整个哈希表时<span lang="EN-US">,</span>循环结束<span lang="EN-US">.</span>这里要说的是<span lang="EN-US">,</span>当查找到此哈希表的结尾还没有找到结果时<span lang="EN-US">,</span>将从此哈希表的开始继续查找<span lang="EN-US">,</span>直到碰上前述的返回或结束条件<span lang="EN-US">.</span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt 21pt; TEXT-INDENT: 18pt"><span lang="EN-US" style="FONT-SIZE: 12pt; COLOR: black; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">}<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt 21pt; TEXT-INDENT: 18pt"><span lang="EN-US"><o:p><font face="Times New Roman" size="3">&nbsp;</font></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt 21pt"><font size="3"><span lang="EN-US"><font face="Times New Roman">GetHashEntryEx()</font></span><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">函数的实现</span></font></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt 21pt; TEXT-INDENT: 21pt"><span lang="EN-US"><font face="Times New Roman" size="3">{</font></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt 42pt; TEXT-INDENT: -21pt; mso-list: l3 level1 lfo6; tab-stops: list 42.0pt"><span lang="EN-US" style="mso-fareast-font-family: 'Times New Roman'"><span style="mso-list: Ignore"><font face="Times New Roman"><font size="3">a)</font><span style='FONT: 7pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></font></span></span><font size="3"><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">首先调用</span><span lang="EN-US"><font face="Times New Roman">GetHashEntry()</font></span><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">函数</span><span lang="EN-US"><font face="Times New Roman">,</font></span><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">返回了一个此文件的任意语言版本的哈希表的入口</span><span lang="EN-US"><font face="Times New Roman">.</font></span></font></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt 21pt"><span lang="EN-US"><o:p><font face="Times New Roman" size="3">&nbsp;</font></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt 42pt; TEXT-INDENT: -21pt; mso-list: l3 level1 lfo6; tab-stops: list 42.0pt"><span lang="EN-US" style="mso-fareast-font-family: 'Times New Roman'"><span style="mso-list: Ignore"><font face="Times New Roman"><font size="3">b)</font><span style='FONT: 7pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></font></span></span><font size="3"><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">此时再开始一个类似于</span><span lang="EN-US"><font face="Times New Roman">GetHashEntry()</font></span><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">函数实现第</span><span lang="EN-US"><font face="Times New Roman">C</font></span><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">步似的遍历循环查找过程</span><span lang="EN-US"><font face="Times New Roman">,</font></span><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">此时的返回条件为此哈希表入口的语言为要查找的语言</span><span lang="EN-US"><font face="Times New Roman">.</font></span><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">并且</span><span lang="EN-US"><font face="Times New Roman">,</font></span><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">在碰到语言为</span><span lang="EN-US" style="FONT-SIZE: 12pt; COLOR: black; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">LANG_NEUTRAL</span></font><span style="FONT-SIZE: 12pt; COLOR: black; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">的文件时进行保存<span lang="EN-US">,</span>当没有查找到确定需要语言版本的哈希表入口<span lang="EN-US">,</span>就返回这个语言版本的哈希表入口偏移值<span lang="EN-US">.</span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt 21pt; TEXT-INDENT: 21pt"><span lang="EN-US"><font face="Times New Roman" size="3">}</font></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt 39pt; TEXT-INDENT: -18pt; mso-list: l0 level2 lfo4; tab-stops: list 39.0pt"><span lang="EN-US" style="mso-fareast-font-family: 'Times New Roman'"><span style="mso-list: Ignore"><font face="Times New Roman"><font size="3">5.</font><span style='FONT: 7pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></font></span></span><font size="3"><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">通过比较获得的块索引和块表大小</span><span lang="EN-US"><font face="Times New Roman">,</font></span><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">验证一下获得的块索引值</span><span lang="EN-US"><font face="Times New Roman">.</font></span></font></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt 21pt"><span lang="EN-US"><o:p><font face="Times New Roman" size="3">&nbsp;</font></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt 39pt; TEXT-INDENT: -18pt; mso-list: l0 level2 lfo4; tab-stops: list 39.0pt"><span lang="EN-US" style="mso-fareast-font-family: 'Times New Roman'"><span style="mso-list: Ignore"><font face="Times New Roman"><font size="3">6.</font><span style='FONT: 7pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></font></span></span><font size="3"><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">通过获得的块索引得到块的偏移地址</span><span lang="EN-US"><font face="Times New Roman">,</font></span><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">验证此块表入口指向的文件地址</span><span lang="EN-US"><font face="Times New Roman">(</font></span><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">此时为相对于</span><span lang="EN-US"><font face="Times New Roman">MPQ</font></span><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">文档的偏移值</span><span lang="EN-US"><font face="Times New Roman">)</font></span><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">是否正确</span><span lang="EN-US"><font face="Times New Roman">(</font></span><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">通过比较文件地址和</span><span lang="EN-US"><font face="Times New Roman">MPQ</font></span><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">文档的大小</span><span lang="EN-US"><font face="Times New Roman">,</font></span><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">还比较了此块表入口指向的块的大小值和文件的大小</span><span lang="EN-US"><font face="Times New Roman">.</font></span><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">验证此块表入口的文件标志位</span><span lang="EN-US"><font face="Times New Roman">.(</font></span><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">是否有</span><span lang="EN-US" style="FONT-SIZE: 12pt; COLOR: black; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">MPQ_FILE_EXISTS(</span></font><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">0x80 00 00 00H)</span><span style="FONT-SIZE: 12pt; COLOR: black; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">位<span lang="EN-US">,</span>是否有除了已知有效标志以外的位<span lang="EN-US">)</span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt"><span lang="EN-US"><o:p><font face="Times New Roman" size="3">&nbsp;</font></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt 21pt"><font size="3"><span lang="EN-US"><font face="Times New Roman">7..</font></span><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">以上验证全部通过后</span><span lang="EN-US"><font face="Times New Roman">,</font></span><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">动态分配一个</span><span lang="EN-US" style="FONT-SIZE: 12pt; COLOR: black; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">TMPQFile</span></font><span style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">格式空间<span lang="EN-US">,</span>由一个名叫<span lang="EN-US">hf</span>指针指向这个空间<span lang="EN-US">..</span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt"><span lang="EN-US"><span style="mso-tab-count: 1"><font face="Times New Roman" size="3">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt 21pt"><font size="3"><span lang="EN-US"><font face="Times New Roman">8.</font></span><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">利用已经得到的哈希表入口和块表入口等初始化</span><span lang="EN-US"><font face="Times New Roman">hf</font></span><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">指向的新创建的空间</span><span lang="EN-US"><font face="Times New Roman">.</font></span></font></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt"><span lang="EN-US"><o:p><font face="Times New Roman" size="3">&nbsp;</font></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt"><span lang="EN-US"><font size="3"><font face="Times New Roman"><span style="mso-tab-count: 1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>9.</font></font></span><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"> <span style="COLOR: red">hf-&gt;nBlocks<span style="mso-spacerun: yes">&nbsp; </span>= (hf-&gt;pBlock-&gt;dwFSize + ha-&gt;dwBlockSize - 1) / ha-&gt;dwBlockSize;(?)</span></span><span style="FONT-SIZE: 12pt; COLOR: red; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">块的数量<span lang="EN-US"> = (</span>块中未压缩的文件数据<span lang="EN-US"> + </span>文档的块大小 </span><span lang="EN-US" style="FONT-SIZE: 12pt; COLOR: red; mso-font-kerning: 0pt; mso-no-proof: yes; mso-fareast-font-family: 新宋体; mso-ascii-font-family: 新宋体"><font face="Times New Roman">&ndash;</font></span><span lang="EN-US" style="FONT-SIZE: 12pt; COLOR: red; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"> 1) / </span><span style="FONT-SIZE: 12pt; COLOR: red; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">文档的块大小<span lang="EN-US">;(?)<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt"><span lang="EN-US" style="FONT-SIZE: 12pt; COLOR: red; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp; </span><o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt"><span lang="EN-US" style="FONT-SIZE: 12pt; COLOR: red; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><span style="mso-tab-count: 1">&nbsp;&nbsp;&nbsp; </span></span><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">10.</span><span style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">假如块入口显示此块为压缩的话<span lang="EN-US">,</span>分配空间用来解压<span lang="EN-US">,stormlib</span>源码注释提到因为每个文件开始位置都存储了一个<span lang="EN-US">DWORD</span>来保存文档中每个块相对文件开始位置的偏移值<span lang="EN-US">.</span>在我写<span lang="EN-US">&lt;<span style="COLOR: red">MPQ</span></span><span style="COLOR: red">文档布局分析<span lang="EN-US">&gt;</span>时<span lang="EN-US">,</span>此处好像是一个表<span lang="EN-US">,</span>这一部分在写<span lang="EN-US">&lt;MPQ</span>文档布局分析<span lang="EN-US">&gt;</span>时就没有太明白<span lang="EN-US">.</span>即</span></span><font size="3"><span style="COLOR: red; FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">文件数据的具体结构这一块还不是太清除</span><span lang="EN-US" style="COLOR: red"><font face="Times New Roman">.</font></span><span style="COLOR: red; FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">最后分配了</span><span lang="EN-US" style="COLOR: red"><font face="Times New Roman">(</font></span><span lang="EN-US" style="FONT-SIZE: 12pt; COLOR: black; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">nBlocks</span></font><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"> + 2)</span><span style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">个<span lang="EN-US">DWORD</span>空间<span lang="EN-US">.<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><o:p>&nbsp;</o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><span style="mso-tab-count: 1">&nbsp;&nbsp;&nbsp; </span>11.</span><span style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">假如文件由索引来打开调用<span lang="EN-US" style="COLOR: blue">SFileGetFileName()</span><span style="COLOR: blue">函数</span><span lang="EN-US">(</span>以后再看此函数<span lang="EN-US">)</span>暂时先看以文件名为索引的情况<span lang="EN-US">.<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">{<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; TEXT-INDENT: 24pt"><span style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">首先得到不带路径的文件名<span lang="EN-US">,</span>如在<span lang="EN-US">&lt;MPQ</span>文档布局文件<span lang="EN-US">&gt;</span>数据这一部分分析的那样<span lang="EN-US">,</span>这就是加密的文件的<span lang="EN-US">key.</span>利用此<span lang="EN-US">key</span>调用<span lang="EN-US">DecryptFileSeed()</span>函数解密<span lang="EN-US">.<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt"><span style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">假如在块入口的标志中有<span lang="EN-US" style="COLOR: black">MPQ_FILE_FIXSEED(</span></span><font size="3"><span lang="EN-US"><font face="Times New Roman">00 02 00 00H),</font></span><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">表示文件的密钥经过块偏移和文件大小调整</span><span lang="EN-US"><font face="Times New Roman">.</font></span><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">此时将得到的</span><span lang="EN-US"><font face="Times New Roman"> (</font></span><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">解密数据</span><span lang="EN-US"><font face="Times New Roman"> + </font></span><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">此块的相对文档头的偏移量</span><span lang="EN-US"><font face="Times New Roman">)^</font></span><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">文件数据解压后的大小</span><span lang="EN-US"><font face="Times New Roman">,</font></span><span style="FONT-FAMILY: 宋体; mso-hansi-font-family: 'Times New Roman'; mso-ascii-font-family: 'Times New Roman'">即</span><span lang="EN-US"><font face="Times New Roman">:</font></span></font></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt"><span lang="EN-US" style="FONT-SIZE: 12pt; COLOR: black; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">hf</span><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">-&gt;<span style="COLOR: black">dwSeed1</span> = (<span style="COLOR: black">hf</span>-&gt;<span style="COLOR: black">dwSeed1</span> + <span style="COLOR: black">hf</span>-&gt;<span style="COLOR: black">pBlock</span>-&gt;<span style="COLOR: black">dwFilePos</span>) ^ <span style="COLOR: black">hf</span>-&gt;<span style="COLOR: black">pBlock</span>-&gt;<span style="COLOR: black">dwFSize</span>;<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt"><span style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">在<span lang="EN-US">&lt;MPQ</span>文档布局分析<span lang="EN-US">&gt;</span>中的描述为<span lang="EN-US">:<o:p></o:p></span></span></p>
<p class="MsoPlainText" style="MARGIN: 0cm 0cm 0pt"><span style="COLOR: green; mso-hansi-font-family: 宋体; mso-bidi-font-family: 宋体"><font size="3"><font face="宋体">基本的文件<span lang="EN-US">key(base key)</span>是不带路径的文件名<span lang="EN-US">,</span>假如这个<span lang="EN-US">key</span>是修改过的<span lang="EN-US">(</span>就像在文件标志中指示的那样<span lang="EN-US">),</span>最后的<span lang="EN-US">key</span>通过<span lang="EN-US">((base key + </span>块偏移值 <span lang="EN-US">&ndash; </span>文档偏移值<span lang="EN-US">)XOR </span>文件大小<span lang="EN-US">)</span>计算得到<span lang="EN-US">.</span>每个扇区都是使用这个<span lang="EN-US">key + </span>在文件中以零为基础的扇区为索引<span lang="EN-US">.<o:p></o:p></span></font></font></span></p>
<p class="MsoPlainText" style="MARGIN: 0cm 0cm 0pt"><span lang="EN-US" style="COLOR: green; mso-hansi-font-family: 宋体; mso-bidi-font-family: 宋体"><o:p><font face="宋体" size="3">&nbsp;</font></o:p></span></p>
<p class="MsoPlainText" style="MARGIN: 0cm 0cm 0pt"><span style="mso-hansi-font-family: 宋体; mso-bidi-font-family: 宋体"><font size="3"><font face="宋体">目前此函数中还看不到此值的作用<span lang="EN-US">,</span>但是返回的时候保存了下来<span lang="EN-US">,</span>估计以后调用<span lang="EN-US">SFileRead</span>的时候要作为索引值用到<span lang="EN-US">.<o:p></o:p></span></font></font></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">}<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><span style="mso-tab-count: 1">&nbsp;&nbsp;&nbsp; </span><o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><span style="mso-tab-count: 1">&nbsp;&nbsp;&nbsp; </span>12.</span><span style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">通过块的索引<span lang="EN-US">,</span>读入每个文件相应的<span lang="EN-US">CRC32,FILETIME,MD5</span>值<span lang="EN-US">,</span>之所以可以通过块的索引来索引<span lang="EN-US">attribute,</span>因为<span lang="EN-US">attribute</span>和块是一一对应的<span lang="EN-US">.<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><o:p>&nbsp;</o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><span style="mso-tab-count: 1">&nbsp;&nbsp;&nbsp; </span>13.</span><span style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">假如前面有错误<span lang="EN-US">,</span>就释放<span lang="EN-US">hf</span>的空间<span lang="EN-US">,</span>并设置相应的错误代码<span lang="EN-US">.</span>将<span lang="EN-US">hf</span>作为文件句柄赋给第四参数作为输出<span lang="EN-US">,</span>并返回<span lang="EN-US" style="COLOR: black">ERROR_SUCCESS</span><span style="COLOR: black">表示成功<span lang="EN-US">.</span></span><span lang="EN-US"><o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt"><span lang="EN-US" style="FONT-SIZE: 12pt; COLOR: red; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><o:p>&nbsp;</o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt"><span lang="EN-US"><font face="Times New Roman" size="3">}</font></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt"><span lang="EN-US"><o:p><font face="Times New Roman" size="3">&nbsp;</font></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt"><span lang="EN-US"><o:p><font face="Times New Roman" size="3">&nbsp;</font></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt"><span lang="EN-US" style="FONT-SIZE: 12pt; COLOR: black; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">FindFreeHashEntry()</span><span style="FONT-SIZE: 12pt; COLOR: black; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">函数实现<span lang="EN-US">:<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt 60pt; TEXT-INDENT: -18pt; mso-list: l3 level2 lfo6; tab-stops: list 60.0pt"><span lang="EN-US" style="FONT-SIZE: 12pt; COLOR: black; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes; mso-bidi-font-family: 新宋体"><span style="mso-list: Ignore">1.<span style='FONT: 7pt "Times New Roman"'>&nbsp;&nbsp;&nbsp; </span></span></span><span style="FONT-SIZE: 12pt; COLOR: black; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">先得到完整文件名的<span lang="EN-US">3</span>个哈希值<span lang="EN-US">.<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt 60pt; TEXT-INDENT: -18pt; mso-list: l3 level2 lfo6; tab-stops: list 60.0pt"><span lang="EN-US" style="FONT-SIZE: 12pt; COLOR: black; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes; mso-bidi-font-family: 新宋体"><span style="mso-list: Ignore">2.<span style='FONT: 7pt "Times New Roman"'>&nbsp;&nbsp;&nbsp; </span></span></span><span style="FONT-SIZE: 12pt; COLOR: black; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">如开始所知<span lang="EN-US">,</span>第一个为<span lang="EN-US">home</span>入口<span lang="EN-US">,</span>寻找即从<span lang="EN-US">home</span>入口开始顺序查找<span lang="EN-US">,</span>直到找到一个空闲<span lang="EN-US">/</span>删除的哈希表入口为止<span lang="EN-US">,</span>没有找到即返回<span lang="EN-US">NULL,</span>表示没有找到<span lang="EN-US">.<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt 60pt; TEXT-INDENT: -18pt; mso-list: l3 level2 lfo6; tab-stops: list 60.0pt"><span lang="EN-US" style="FONT-SIZE: 12pt; COLOR: black; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes; mso-bidi-font-family: 新宋体"><span style="mso-list: Ignore">3.<span style='FONT: 7pt "Times New Roman"'>&nbsp;&nbsp;&nbsp; </span></span></span><span style="FONT-SIZE: 12pt; COLOR: black; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">假如找到了空闲哈希表入口即将其值置为相关值<span lang="EN-US">.<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt 60pt; TEXT-INDENT: -18pt; mso-list: l3 level2 lfo6; tab-stops: list 60.0pt"><span lang="EN-US" style="FONT-SIZE: 12pt; COLOR: black; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes; mso-bidi-font-family: 新宋体"><span style="mso-list: Ignore">4.<span style='FONT: 7pt "Times New Roman"'>&nbsp;&nbsp;&nbsp; </span></span></span><span style="FONT-SIZE: 12pt; COLOR: black; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">然后开始寻找空闲的块表入口<span lang="EN-US">,</span>方法是从索引为零开始<span lang="EN-US">,</span>顺序检查每个块表的文件标志位是否为有文件<span lang="EN-US">,</span>标志为没有时<span lang="EN-US">,</span>表示找到空闲块表入口<span lang="EN-US">.<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt 60pt; TEXT-INDENT: -18pt; mso-list: l3 level2 lfo6; tab-stops: list 60.0pt"><span lang="EN-US" style="FONT-SIZE: 12pt; COLOR: black; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes; mso-bidi-font-family: 新宋体"><span style="mso-list: Ignore">5.<span style='FONT: 7pt "Times New Roman"'>&nbsp;&nbsp;&nbsp; </span></span></span><span style="FONT-SIZE: 12pt; COLOR: black; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">当没有找到空闲块表入口时<span lang="EN-US">,</span>在块表的最后添加一个块表入口<span lang="EN-US">,</span>并赋给该哈希表入口的第四个<span lang="EN-US">DWROD</span>值<span lang="EN-US">(</span>即其对应的块表索引<span lang="EN-US">).<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt 60pt; TEXT-INDENT: -18pt; mso-list: l3 level2 lfo6; tab-stops: list 60.0pt"><span lang="EN-US" style="FONT-SIZE: 12pt; COLOR: black; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes; mso-bidi-font-family: 新宋体"><span style="mso-list: Ignore">6.<span style='FONT: 7pt "Times New Roman"'>&nbsp;&nbsp;&nbsp; </span></span></span><span style="FONT-SIZE: 12pt; COLOR: black; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">一切成功以后<span lang="EN-US">,</span>返回此哈希表入口的指针<span lang="EN-US">.<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><o:p>&nbsp;</o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><o:p>&nbsp;</o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt"><span lang="EN-US" style="FONT-SIZE: 12pt; COLOR: black; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">AddFileToArchive()</span><span style="FONT-SIZE: 12pt; COLOR: black; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">函数实现<span lang="EN-US">:<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt 18pt; TEXT-INDENT: -18pt; mso-list: l5 level1 lfo7; tab-stops: list 18.0pt"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes; mso-bidi-font-family: 新宋体"><span style="mso-list: Ignore">1.<span style='FONT: 7pt "Times New Roman"'>&nbsp;&nbsp;&nbsp; </span></span></span><span style="FONT-SIZE: 12pt; COLOR: black; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">得到需要加入的文件的大小<span lang="EN-US">,</span>当其小于<span lang="EN-US">0x04H</span>时<span lang="EN-US">,</span>不进行加密和文件<span lang="EN-US">key</span>的修正<span lang="EN-US">,</span>当其小于<span lang="EN-US">0x20H</span>时不进行压缩<span lang="EN-US">.</span>当文件大于<span lang="EN-US">4GB</span>时<span lang="EN-US">,</span>报错<span lang="EN-US">,</span>据<span lang="EN-US">stormlib</span>注释说明<span lang="EN-US">,</span>在<span lang="EN-US">MPQ</span>中的当个文件大小不能大于<span lang="EN-US">4GB.<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt 18pt; TEXT-INDENT: -18pt; mso-list: l5 level1 lfo7; tab-stops: list 18.0pt"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes; mso-bidi-font-family: 新宋体"><span style="mso-list: Ignore">2.<span style='FONT: 7pt "Times New Roman"'>&nbsp;&nbsp;&nbsp; </span></span></span><span style="FONT-SIZE: 12pt; COLOR: black; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">为此文件的入口动态分配一个<span lang="EN-US">TMPQFile</span>结构的空间<span lang="EN-US">,</span>由指针<span lang="EN-US">hf</span>指向<span lang="EN-US">.</span>初始化此结构<span lang="EN-US">.<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt 18pt; TEXT-INDENT: -18pt; mso-list: l5 level1 lfo7; tab-stops: list 18.0pt"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes; mso-bidi-font-family: 新宋体"><span style="mso-list: Ignore">3.<span style='FONT: 7pt "Times New Roman"'>&nbsp;&nbsp;&nbsp; </span></span></span><span style="FONT-SIZE: 12pt; COLOR: black; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">利用<span lang="EN-US">GetHashEntryEx()</span>函数<span lang="EN-US">,</span>检测是否已经有完全一样的文件<span lang="EN-US">(</span>包括文件名<span lang="EN-US">,</span>语言和平台<span lang="EN-US">,</span>此函数实现在前面已经说明<span lang="EN-US">).</span>当已经存在时<span lang="EN-US">,</span>检测添加文件的标志位是否有<span lang="EN-US">MPQ_FILE_REPLACEEXISTING,</span>没有此标志位即报错<span lang="EN-US">ERROR_ALREADY_EXISTS,</span>有的话设定标志位表示已经覆盖<span lang="EN-US">,</span>正确设置块的位置<span lang="EN-US">,</span></span><span style="FONT-SIZE: 12pt; COLOR: red; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">但是不做任何实际覆盖工作<span lang="EN-US">?</span>要写入一个修改过的新的同名的文件怎么办<span lang="EN-US">? (?)</span></span><span lang="EN-US" style="FONT-SIZE: 12pt; COLOR: black; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; TEXT-ALIGN: left; mso-layout-grid-align: none" align="left"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><span style="mso-spacerun: yes">&nbsp;</span><span style="COLOR: black">hf</span>-&gt;<span style="COLOR: black">pBlockEx</span> = <span style="COLOR: black">ha</span>-&gt;<span style="COLOR: black">pExtBlockTable</span> + <span style="COLOR: black">hf</span>-&gt;<span style="COLOR: black">pHash</span>-&gt;<span style="COLOR: black">dwBlockIndex</span>;<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; TEXT-ALIGN: left; mso-layout-grid-align: none" align="left"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><span style="mso-spacerun: yes">&nbsp;</span><span style="COLOR: black">hf</span>-&gt;<span style="COLOR: black">pBlock</span> = <span style="COLOR: black">ha</span>-&gt;<span style="COLOR: black">pBlockTable</span> + <span style="COLOR: black">hf</span>-&gt;<span style="COLOR: black">pHash</span>-&gt;<span style="COLOR: black">dwBlockIndex</span>;<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><span style="mso-spacerun: yes">&nbsp;</span><span style="COLOR: black">bReplaced</span> = <span style="COLOR: black">TRUE</span>;<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt 18pt; TEXT-INDENT: -18pt; mso-list: l5 level1 lfo7; tab-stops: list 18.0pt"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes; mso-bidi-font-family: 新宋体"><span style="mso-list: Ignore">4.<span style='FONT: 7pt "Times New Roman"'>&nbsp;&nbsp;&nbsp; </span></span></span><span style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">当没有找到完全一致的入口时<span lang="EN-US">,</span>用<span lang="EN-US">FindFreeHashEntry()</span>函数找到一个空闲的哈希表入口<span lang="EN-US">.</span>此函数实现在前面已经解释<span lang="EN-US">.</span>并计算出此哈希表入口的索引值<span lang="EN-US">.<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt 18pt; TEXT-INDENT: -18pt; mso-list: l5 level1 lfo7; tab-stops: list 18.0pt"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes; mso-bidi-font-family: 新宋体"><span style="mso-list: Ignore">5.<span style='FONT: 7pt "Times New Roman"'>&nbsp;&nbsp;&nbsp; </span></span></span><span style="FONT-SIZE: 12pt; COLOR: black; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">此时先得到第一个文件块的偏移量<span lang="EN-US">(</span>相对于文档开始处<span lang="EN-US">,</span>得到方法即是跳过文档头<span lang="EN-US">.</span>从第一个块表入口开始<span lang="EN-US">,</span>同时不断验证此块表入口是否空闲<span lang="EN-US">.</span>不空闲<span lang="EN-US">,</span>就同时将文件块偏移量跳过这个入口指定的块大小<span lang="EN-US">,</span>顺序查找方式与</span><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">FindFreeHashEntry()</span><span style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">函数一致<span lang="EN-US">,</span><span style="COLOR: black">当其找到一个空闲的块表入口时<span lang="EN-US">,</span>此块表入口即通过</span><span lang="EN-US">FindFreeHashEntry()</span>函数找到的块表入口<span lang="EN-US">,</span>且文件块偏移量正好跳过了前面所有块表入口指定块大小的总和<span lang="EN-US">.</span>此时<span lang="EN-US">,</span>认为找到了一个空闲的块空间<span lang="EN-US">.</span>当找到块表入口末尾也没有找到空闲空间时<span lang="EN-US">,</span>此时文件块偏移量也正好跳过了全部占用的文件块<span lang="EN-US">,</span>到达文件数据块的末尾<span lang="EN-US">,</span>此时认为这里即空闲空间<span lang="EN-US">.stormlib</span>源代码中<span lang="EN-US">,</span>个人认为<span lang="EN-US">.</span>此两种情况实际可以合为一处<span lang="EN-US">,</span>即少一个比较赋值操作<span lang="EN-US">.</span><span style="COLOR: red">但是疑问在于<span lang="EN-US">,</span>此处没有判断在文件块中找到的空闲块是否大于需要写入的文件<span lang="EN-US">,</span>留待看以后有没有判断<span lang="EN-US">.(?)<o:p></o:p></span></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt 18pt; TEXT-INDENT: -18pt; mso-list: l5 level1 lfo7; tab-stops: list 18.0pt"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes; mso-bidi-font-family: 新宋体"><span style="mso-list: Ignore">6.<span style='FONT: 7pt "Times New Roman"'>&nbsp;&nbsp;&nbsp; </span></span></span><span style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">当此文档是原始版本时<span lang="EN-US">,</span>确定添加此文件后的大小也不能大于<span lang="EN-US">4GB</span>．方法是，首先将得到的文件偏移量（相对于整个文件而言）加上要加上的文件大小，再加上哈希表大小，块表入口，当此偏移量超过<span lang="EN-US">32</span>位可以表示的时候<span lang="EN-US">,</span>即表示添加文件后超过<span lang="EN-US">4GB</span>．返回错误<span lang="EN-US" style="COLOR: black">ERROR_DISK_FULL.</span>这种方法实际是检测当添加文件处于文件数据块的尾部时的情况<span lang="EN-US">.</span>当时我本以为<span lang="EN-US">,</span>当新添加的文件处于文件块中时<span lang="EN-US">,</span>这种方法不能保证文件大小不超过<span lang="EN-US">4GB,</span>因为此时添加的文件和哈希表中还可能有数据<span lang="EN-US">.</span>但是实际效果是<span lang="EN-US">,</span>只要保证此空闲空间大于新添加的文件<span lang="EN-US">,</span>那么只要原文件保证了小于<span lang="EN-US">4GB,</span>那么此文件实际没有增加体积<span lang="EN-US">,</span>自然也小于<span lang="EN-US">4GB.<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt 18pt; TEXT-INDENT: -18pt; mso-list: l5 level1 lfo7; tab-stops: list 18.0pt"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes; mso-bidi-font-family: 新宋体"><span style="mso-list: Ignore">7.<span style='FONT: 7pt "Times New Roman"'>&nbsp;&nbsp;&nbsp; </span></span></span><span style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">当块偏移值大于哈希表入口时<span lang="EN-US">,</span>返回错误<span lang="EN-US" style="COLOR: black">ERROR_HANDLE_DISK_FULL.</span><span lang="EN-US"><o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt"><span style="FONT-SIZE: 12pt; COLOR: black; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">当文件是加密的时候得到<span lang="EN-US">seed(</span>即附加的偏移值<span lang="EN-US">),</span>当文件的加密<span lang="EN-US">key</span>是修正过的<span lang="EN-US">,</span>进一步计算修正过的<span lang="EN-US">seed,</span>方法和读取的时候一致<span lang="EN-US">.</span>见上面的</span><span lang="EN-US"><font face="Times New Roman" size="3">SFileOpenFileEx()</font></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt"><span style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">函数<span lang="EN-US">11</span>步<span lang="EN-US">.<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt 18pt; TEXT-INDENT: -18pt; mso-list: l5 level1 lfo7; tab-stops: list 18.0pt"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes; mso-bidi-font-family: 新宋体"><span style="mso-list: Ignore">8.<span style='FONT: 7pt "Times New Roman"'>&nbsp;&nbsp;&nbsp; </span></span></span><span style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">假如<span lang="EN-US">MPQ</span>文档的属性中指定了需要<span lang="EN-US">CRC32,FILETIME,MD5</span>时<span lang="EN-US">,</span>将<span lang="EN-US">hf</span>的相关值指针指向<span lang="EN-US">ha</span>的相关位置<span lang="EN-US">.</span>即将文档中相关位置和目前文件中的相关指针关联在一起<span lang="EN-US">,</span>以后改变<span lang="EN-US">hf</span>的指针值就直接修改了文档中的相关值<span lang="EN-US">,</span>为以后的修改提供方便<span lang="EN-US">.<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt 18pt; TEXT-INDENT: -18pt; mso-list: l5 level1 lfo7; tab-stops: list 18.0pt"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes; mso-bidi-font-family: 新宋体"><span style="mso-list: Ignore">9.<span style='FONT: 7pt "Times New Roman"'>&nbsp;&nbsp;&nbsp; </span></span></span><span style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">为压缩的数据分配<span lang="EN-US">buffer,</span>首先计算了一个文件需要的块数量<span lang="EN-US">(</span>文件的总大小<span lang="EN-US"> / </span>文档的块大小<span lang="EN-US"> + 1),</span>假如文件大小正好是文档的块大小的整数倍<span lang="EN-US">,</span>就将此数量再加一<span lang="EN-US">,</span>目的是确保块数量充裕<span lang="EN-US">(</span>需要在最后一个块尾保存额外数据<span lang="EN-US">).</span>实际分配缓存大小仅仅一次分配了一个块的大小<span lang="EN-US">.<span style="COLOR: red"><o:p></o:p></span></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt 18pt; TEXT-INDENT: -18pt; mso-list: l5 level1 lfo7; tab-stops: list 18.0pt"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes; mso-bidi-font-family: 新宋体"><span style="mso-list: Ignore">10.</span></span><span style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">为此文件的扇区偏移表分配空间<span lang="EN-US">,</span>为压缩的文件数据分配块大小<span lang="EN-US">*2</span>大小的控件<span lang="EN-US">.<span style="COLOR: red"><o:p></o:p></span></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt 18pt; TEXT-INDENT: -18pt; mso-list: l5 level1 lfo7; tab-stops: list 18.0pt"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes; mso-bidi-font-family: 新宋体"><span style="mso-list: Ignore">11.</span></span><span style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">设定文件指针到新添加文件需要写入的地方<span lang="EN-US">,</span>并将此文件的哈希表和块表赋相关值<span lang="EN-US">.</span><span style="COLOR: red">这里很奇怪<span lang="EN-US">,</span>没有写入前就将块表的标志位修改成<span lang="EN-US">MPQ_FILE_EXISTS,</span>了<span lang="EN-US">,</span>按道理应该先写入后再修改<span lang="EN-US">...</span>不然写入的时候失败了怎么办<span lang="EN-US">?<o:p></o:p></span></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt 18pt; TEXT-INDENT: -18pt; mso-list: l5 level1 lfo7; tab-stops: list 18.0pt"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes; mso-bidi-font-family: 新宋体"><span style="mso-list: Ignore">12.</span></span><span style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">假如文件是压缩的<span lang="EN-US">,</span>计算出块偏移值表的大小<span lang="EN-US">.</span>并用此值来初始化先前分配的块偏移表<span lang="EN-US">,</span>并将此块偏移表的第一个值设为此值<span lang="EN-US">.<span style="COLOR: red"><o:p></o:p></span></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt 18pt; TEXT-INDENT: -18pt; mso-list: l5 level1 lfo7; tab-stops: list 18.0pt"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes; mso-bidi-font-family: 新宋体"><span style="mso-list: Ignore">13.</span></span><span style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">接下来将块偏移表先写入文件<span lang="EN-US">.</span>此时标志此<span lang="EN-US">MPQ</span>文件已被改变<span lang="EN-US">.</span>并将块表的第二个表示文件大小的值修正<span lang="EN-US">,</span>即加上块表大小<span lang="EN-US">.<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt 18pt; TEXT-INDENT: -18pt; mso-list: l5 level1 lfo7; tab-stops: list 18.0pt"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes; mso-bidi-font-family: 新宋体"><span style="mso-list: Ignore">14.</span></span><span style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">最关键的一部分来了<span lang="EN-US">,</span>实际写入文件数据的部分<span lang="EN-US">:<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; TEXT-INDENT: 24pt; mso-char-indent-count: 2.0"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">{<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt 47.95pt; TEXT-INDENT: -24pt; mso-para-margin-left: 2.28gd; mso-char-indent-count: -2.0"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp; </span>a)</span><span style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">首先初始化<span lang="EN-US">CRC32</span>和<span lang="EN-US">MD5<span style="COLOR: red">(</span></span><span style="COLOR: red">没有判断需不需要<span lang="EN-US">?</span>不需要的话<span lang="EN-US">,</span>每次计算简直是极大的浪费<span lang="EN-US">(?))<o:p></o:p></span></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; TEXT-INDENT: 24pt; mso-char-indent-count: 2.0"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp; </span>b)</span><span style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">从文件开始读取数据<span lang="EN-US">,</span>一次一个块的大小<span lang="EN-US">.<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; TEXT-INDENT: 24pt; mso-char-indent-count: 2.0"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp; </span>c)</span><span style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">计算<span lang="EN-US">CRC32,MD5.<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt 59.95pt; TEXT-INDENT: -36pt; mso-para-margin-left: 2.28gd; mso-char-indent-count: -3.0"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp; </span>d)</span><span style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">判断是否需要压缩<span lang="EN-US">,</span>需要就压缩读入缓存的文件数据<span lang="EN-US">,</span>假如压缩后文件数据没有变小<span lang="EN-US">,</span>就保存原始数据<span lang="EN-US">.<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt 59.9pt; TEXT-INDENT: -12pt; mso-para-margin-left: 4.56gd; mso-char-indent-count: -1.0"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">e)</span><span style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">将块偏移值表修改成正确的值<span lang="EN-US">, </span>理解上<span lang="EN-US">...</span>因为上一个值表示目前写入数据的开始位置<span lang="EN-US">,</span>那么将下一个值赋值成上个值<span lang="EN-US">+</span>写入的大小<span lang="EN-US">.<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt 59.9pt; TEXT-INDENT: -12pt; mso-para-margin-left: 4.56gd; mso-char-indent-count: -1.0"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">f)</span><span style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">假如需要加密<span lang="EN-US">,</span>加密数据<span lang="EN-US">.</span>加密的时候利用了前面计算的<span lang="EN-US">seed,</span>目前可以确定的是<span lang="EN-US">,</span>以前的理解有问题<span lang="EN-US">,seed</span>是利用来加密数据的一个<span lang="EN-US">key,</span>而不仅仅是附加的偏移值<span lang="EN-US">.<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt 59.9pt; TEXT-INDENT: -12pt; mso-para-margin-left: 4.56gd; mso-char-indent-count: -1.0"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">g)</span><span style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">将数据写入<span lang="EN-US">MPQ</span>文档<span lang="EN-US">.</span>假如写入的大小不一致<span lang="EN-US">,</span>又报<span lang="EN-US" style="COLOR: black">ERROR_DISK_FULL</span><span style="COLOR: black">错误<span lang="EN-US">.</span></span><span lang="EN-US"><o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt 59.9pt; TEXT-INDENT: -12pt; mso-para-margin-left: 4.56gd; mso-char-indent-count: -1.0"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">h)</span><span style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">将压缩后的大小继续加上此块的大小<span lang="EN-US">.<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt 59.9pt; TEXT-INDENT: -12pt; mso-para-margin-left: 4.56gd; mso-char-indent-count: -1.0"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">i)</span><span style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">当所有的文件块都写入后<span lang="EN-US">,</span>将计算得到的<span lang="EN-US">CRC,MD5</span>写入<span lang="EN-US">hf.<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt; TEXT-INDENT: 24pt; mso-char-indent-count: 2.0"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">}<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt 18pt; TEXT-INDENT: -18pt; mso-list: l5 level1 lfo7; tab-stops: list 18.0pt"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes; mso-bidi-font-family: 新宋体"><span style="mso-list: Ignore">15.</span></span><span style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">通过以上的循环<span lang="EN-US">,</span>一次一次写入了一个文件的所有块并完成了此文件的块偏移值表<span lang="EN-US">.<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt 18pt; TEXT-INDENT: -18pt; mso-list: l5 level1 lfo7; tab-stops: list 18.0pt"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes; mso-bidi-font-family: 新宋体"><span style="mso-list: Ignore">16.</span></span><span style="FONT-SIZE: 12pt; COLOR: red; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">当文件标志位有<span lang="EN-US">MPQ_FILE_HAS_EXTRA</span>时<span lang="EN-US">,</span>将最后一个块偏移值表的值赋值为前一个值<span lang="EN-US">.</span>本来此值应该是此文件的结尾<span lang="EN-US">,</span>但是此值现在变成了此文件最后一个块的开始位置<span lang="EN-US">.(?)</span>因为对<span lang="EN-US">MPQ_FILE_HAS_EXTRA</span>标志不理解<span lang="EN-US">,</span>所以不明白此步的作用<span lang="EN-US">.<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt 18pt; TEXT-INDENT: -18pt; mso-list: l5 level1 lfo7; tab-stops: list 18.0pt"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes; mso-bidi-font-family: 新宋体"><span style="mso-list: Ignore">17.</span></span><span style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">假如文件是加密的<span lang="EN-US">,</span>此时将此文件的块偏移值表也加密<span lang="EN-US">.</span>重新将指针调到此文件的应该在<span lang="EN-US">MPQ</span>文档中写入的开始位置<span lang="EN-US">,</span>写入文件<span lang="EN-US">.</span>无语了<span lang="EN-US">.<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt 18pt; TEXT-INDENT: -18pt; mso-list: l5 level1 lfo7; tab-stops: list 18.0pt"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes; mso-bidi-font-family: 新宋体"><span style="mso-list: Ignore">18.</span></span><span style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">假如整个写入过程都成功<span lang="EN-US">,</span>就升级哈希表和块表及文档头<span lang="EN-US">,</span>失败就清空哈希表<span lang="EN-US">,</span>从前面来看<span lang="EN-US">,</span><span style="COLOR: red">假如写入失败的话<span lang="EN-US">,</span>块表没有被清空<span lang="EN-US">(?)</span></span><span lang="EN-US"><o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt 18pt"><span style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">升级哈希表和块表过程如下<span lang="EN-US">:<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt 18pt"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">{ <o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt 35.95pt; TEXT-INDENT: -18pt; mso-para-margin-left: 1.71gd; mso-char-indent-count: -1.5"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><span style="mso-spacerun: yes">&nbsp;&nbsp; </span>a)</span><span style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">假如此文件是在块表最后添加的<span lang="EN-US">(</span>即此块表的索引大于文档头的块表大小时<span lang="EN-US">),</span>块表的大小加<span lang="EN-US">1.<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt 35.95pt; TEXT-INDENT: -18pt; mso-para-margin-left: 1.71gd; mso-char-indent-count: -1.5"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><span style="mso-tab-count: 1">&nbsp;&nbsp; </span>b)</span><span style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">哈希表<span lang="EN-US">,</span>块表的整体位置向后移动此文件实际写入的大小<span lang="EN-US">.</span>并将相对于文档开始位置的偏移量写入文档头<span lang="EN-US">.<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt 35.95pt; TEXT-INDENT: -18pt; mso-para-margin-left: 1.71gd; mso-char-indent-count: -1.5"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><span style="mso-tab-count: 1">&nbsp;&nbsp; </span>c)</span><span style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">假如在文件添加后<span lang="EN-US">,</span>文档大于<st1:chmetcnv w:st="on" tcsc="0" numbertype="1" negative="False" hasspace="False" sourcevalue="4" unitname="g"><span lang="EN-US">4G</span></st1:chmetcnv><span lang="EN-US">,</span>将相关高<span lang="EN-US">16</span>位的值修改成正确偏移地址<span lang="EN-US">.</span>通过判断以前文档头的块表偏移值高<span lang="EN-US">16</span>位是否存在来辨别是否是新版本的文档<span lang="EN-US">.</span>因为前面已经判断过了<span lang="EN-US">,</span>不是新版本此时文档不会超过<st1:chmetcnv w:st="on" tcsc="0" numbertype="1" negative="False" hasspace="False" sourcevalue="4" unitname="g"><span lang="EN-US">4G</span></st1:chmetcnv><span lang="EN-US">,</span>所以此时的判断是安全的<span lang="EN-US">.<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt 18pt"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><span style="mso-spacerun: yes">&nbsp;&nbsp; </span><o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt 18pt"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">}<o:p></o:p></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt 18pt; TEXT-INDENT: -18pt; mso-list: l5 level1 lfo7; tab-stops: list 18.0pt"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes; mso-bidi-font-family: 新宋体"><span style="mso-list: Ignore">19.</span></span><span style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes">释放写入文件时为文件分配的缓存<span lang="EN-US">.<o:p></o:p></span></span></p>
<p class="MsoNormal" style="MARGIN: 0cm 0cm 0pt"><span lang="EN-US" style="FONT-SIZE: 12pt; FONT-FAMILY: 新宋体; mso-font-kerning: 0pt; mso-hansi-font-family: 'Times New Roman'; mso-no-proof: yes"><o:p>&nbsp;</o:p></span></p>
