---
layout: post
title: "通过全局变量和自擦除代码来防Dump(2)"
categories:
- "未分类"
tags:
- "防Dump"
status: publish
type: post
published: true
meta:
  ratings_users: '0'
  ratings_score: '0'
  ratings_average: '0'
  views: '10'
author:
  login: jtianling
  email: jtianling@gmail.com
  display_name: jtianling
  first_name: ''
  last_name: ''
---
<br />
<h1 style="margin: 24pt 0cm 0pt;"><span style="color: #365f91;"><span style="font-family: 宋体; mso-ascii-font-family: Cambria; mso-ascii-theme-font: major-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: major-fareast; mso-hansi-font-family: Cambria; mso-hansi-theme-font: major-latin;">通过全局变量和自擦除代码来防</span><span lang="EN-US"><span style="font-family: Cambria;">Dump(2)</span></span></span></h1>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt; text-align: right;" align="right"><span lang="EN-US"><a href="http://www.jtianling.com"><span style="font-size: small;"><span style="color: #800080;"><strong><span style="letter-spacing: 0.25pt; font-variant: small-caps;"><span style="font-family: Calibri;">write by </span></span></strong><strong><span style="font-family: 宋体; letter-spacing: 0.25pt; font-variant: small-caps;">九天雁翎</span><span style="letter-spacing: 0.25pt; font-variant: small-caps;"><span style="font-family: Calibri;">(JTianLing) -- www.jtianling.com</span></span></strong></span></span></a></span><strong><span style="text-decoration: underline;"><span style="color: #c0504d; letter-spacing: 0.25pt; font-variant: small-caps; mso-themecolor: accent2; mso-fareast-language: ZH-CN;" lang="EN-US"></span></span></strong></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt; text-align: right;" align="right"><span lang="EN-US"><a href="ttp://groups.google.com/group/jiutianfile/"><strong><span style="font-family: 宋体; letter-spacing: 0.25pt; font-variant: small-caps; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin; mso-fareast-language: ZH-CN;" lang="EN-US"><span lang="EN-US"><span style="font-size: small;">讨论新闻组及文件</span></span></span></strong></a></span><span style="mso-fareast-language: ZH-CN;" lang="EN-US"></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt;"><span style="font-size: small;"><span class="title"><span style="font-family: 宋体; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin; mso-fareast-language: ZH-CN;">《</span><span lang="EN-US"><a href="http://www.jtianling.com/archive/2009/02/08/3869243.aspx" target="_blank"><span style="font-family: 宋体; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin; mso-fareast-language: ZH-CN;" lang="EN-US"><span lang="EN-US">通过全局变量和自擦除代码来防</span></span><span style="mso-fareast-language: ZH-CN;"><span style="font-family: Calibri;">Dump </span></span></a></span></span><span class="title"><span style="font-family: 宋体; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin; mso-fareast-language: ZH-CN;">》中我提到了用</span></span><span class="title"><span style="mso-fareast-language: ZH-CN;" lang="EN-US"><span style="font-family: Calibri;">WriteProcessMemory</span></span></span><span class="title"><span style="font-family: 宋体; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin; mso-fareast-language: ZH-CN;">来完成代码段的自擦除，其实这并不是什么好的手段，因为使用了</span></span><span class="title"><span style="mso-fareast-language: ZH-CN;" lang="EN-US"><span style="font-family: Calibri;">Win32 API</span></span></span><span class="title"><span style="font-family: 宋体; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin; mso-fareast-language: ZH-CN;">，对于分析你代码的人来说，这是明摆着告诉对方你要干什么，破解手段在原文中也提到了不少。其实，当时我去搜寻</span></span><span class="title"><span style="mso-fareast-language: ZH-CN;" lang="EN-US"><span style="font-family: Calibri;">WriteMemroy API</span></span></span><span class="title"><span style="font-family: 宋体; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin; mso-fareast-language: ZH-CN;">但是并不存在的时候，我就在想，为什么微软不提供，并且，同样的，有</span></span><span class="title"><span style="mso-fareast-language: ZH-CN;" lang="EN-US"><span style="font-family: Calibri;">ReadProcessMemory</span></span></span><span class="title"><span style="font-family: 宋体; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin; mso-fareast-language: ZH-CN;">但是有</span></span><span class="title"><span style="mso-fareast-language: ZH-CN;" lang="EN-US"><span style="font-family: Calibri;">ReadMemory</span></span></span><span class="title"><span style="font-family: 宋体; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin; mso-fareast-language: ZH-CN;">，为什么要使用的时候都需要通过</span></span><span class="title"><span style="mso-fareast-language: ZH-CN;" lang="EN-US"><span style="font-family: Calibri;">GetCurrentProcess</span></span></span><span class="title"><span style="font-family: 宋体; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin; mso-fareast-language: ZH-CN;">（）作为第一参数这样奇怪的形式，这个</span></span><span class="title"><span style="mso-fareast-language: ZH-CN;" lang="EN-US"><span style="font-family: Calibri;">MS</span></span></span><span class="title"><span style="font-family: 宋体; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin; mso-fareast-language: ZH-CN;">一贯的作风不符。这两个函数只在</span></span><span class="title"><span style="mso-fareast-language: ZH-CN;" lang="EN-US"><span style="font-family: Calibri;">WinCE</span></span></span><span class="title"><span style="font-family: 宋体; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin; mso-fareast-language: ZH-CN;">中有提供，普通</span></span><span class="title"><span style="mso-fareast-language: ZH-CN;" lang="EN-US"><span style="font-family: Calibri;">Windows</span></span></span><span class="title"><span style="font-family: 宋体; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin; mso-fareast-language: ZH-CN;">并没有，其实后来仔细想想就想通了，因为读写另外的进程的内存你必须要通过额外</span></span><span class="title"><span style="mso-fareast-language: ZH-CN;" lang="EN-US"><span style="font-family: Calibri;">API</span></span></span><span class="title"><span style="font-family: 宋体; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin; mso-fareast-language: ZH-CN;">，所以有这样的</span></span><span class="title"><span style="mso-fareast-language: ZH-CN;" lang="EN-US"><span style="font-family: Calibri;">API</span></span></span><span class="title"><span style="font-family: 宋体; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin; mso-fareast-language: ZH-CN;">给你来使用，但是读写自己的内存根本就不需要别的特殊的</span></span><span class="title"><span style="mso-fareast-language: ZH-CN;" lang="EN-US"><span style="font-family: Calibri;">API</span></span></span><span class="title"><span style="font-family: 宋体; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin; mso-fareast-language: ZH-CN;">，自己进程访问和改写自己进程中的数据是没有限制的。因此，需要做自擦除的操作仅仅需要</span></span><span class="title"><span style="mso-fareast-language: ZH-CN;" lang="EN-US"><span style="font-family: Calibri;">memcpy</span></span></span><span class="title"><span style="font-family: 宋体; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin; mso-fareast-language: ZH-CN;">或者</span></span><span class="title"><span style="mso-fareast-language: ZH-CN;" lang="EN-US"><span style="font-family: Calibri;">memset</span></span></span><span class="title"><span style="font-family: 宋体; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin; mso-fareast-language: ZH-CN;">就可以了！</span></span><span class="title"><span style="mso-fareast-language: ZH-CN;" lang="EN-US"></span></span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt;"><span style="font-size: small;"><span class="title"><span style="font-family: 宋体; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin; mso-fareast-language: ZH-CN;">下面是改进的示例：</span></span><span class="title"><span style="mso-fareast-language: ZH-CN;" lang="EN-US"></span></span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt;"><span style="font-size: small;"><span style='color: #804040; font-family: "Courier New";' lang="EN-US">&nbsp;1 </span><span style='color: blue; font-family: "Courier New";' lang="EN-US">#include "windows.h"</span></span><span style='font-family: "Courier New";' lang="EN-US"><br /><span style="font-size: small;"><span style="color: #804040;">&nbsp;2 </span><span style="color: blue;">#include "tchar.h"</span><br /><span style="color: #804040;">&nbsp;3 </span><br /><span style="color: #804040;">&nbsp;4 </span>void Run()<br /><span style="color: #804040;">&nbsp;5 </span>{<br /><span style="color: #804040;">&nbsp;6 </span>&nbsp;&nbsp;&nbsp;&nbsp;// begin of the func<br /><span style="color: #804040;">&nbsp;7 </span>&nbsp;&nbsp;&nbsp;&nbsp;DWORD ldwBegin = 0;<br /><span style="color: #804040;">&nbsp;8 </span>&nbsp;&nbsp;&nbsp;&nbsp;__asm<br /><span style="color: #804040;">&nbsp;9 </span>&nbsp;&nbsp;&nbsp;&nbsp;{<br /><span style="color: #804040;">10 </span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;call $+5<br /><span style="color: #804040;">11 </span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pop eax<br /><span style="color: #804040;">12 </span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov ldwBegin, eax<br /><span style="color: #804040;">13 </span>&nbsp;&nbsp;&nbsp;&nbsp;}<br /><span style="color: #804040;">14 </span>&nbsp;&nbsp;&nbsp;&nbsp;DWORD ldwOldPro = 0;<br /><span style="color: #804040;">15 </span>&nbsp;&nbsp;&nbsp;&nbsp;// Must have this step<br /><span style="color: #804040;">16 </span>&nbsp;&nbsp;&nbsp;&nbsp;if(!VirtualProtect((void*)ldwBegin, 1000, PAGE_EXECUTE_READWRITE, &amp;ldwOldPro))<br /><span style="color: #804040;">17 </span>&nbsp;&nbsp;&nbsp;&nbsp;{<br /><span style="color: #804040;">18 </span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf( <span style="color: fuchsia;">"VirtualProtectEx failed (%d)./n"</span>, GetLastError() );<br /><span style="color: #804040;">19 </span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return;<br /><span style="color: #804040;">20 </span>&nbsp;&nbsp;&nbsp;&nbsp;}<br /><span style="color: #804040;">21 </span><br /><span style="color: #804040;">22 </span>&nbsp;&nbsp;&nbsp;&nbsp;MessageBox(NULL, _T(<span style="color: fuchsia;">"Right"</span>), _T(<span style="color: fuchsia;">"Hello World"</span>), MB_OK);<br /><span style="color: #804040;">23 </span><br /><span style="color: #804040;">24 </span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// begin of the func<br /><span style="color: #804040;">25 </span>&nbsp;&nbsp;&nbsp;&nbsp;DWORD ldwEnd = 0;<br /><span style="color: #804040;">26 </span>&nbsp;&nbsp;&nbsp;&nbsp;__asm<br /><span style="color: #804040;">27 </span>&nbsp;&nbsp;&nbsp;&nbsp;{<br /><span style="color: #804040;">28 </span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;call $+5<br /><span style="color: #804040;">29 </span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pop eax<br /><span style="color: #804040;">30 </span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov ldwEnd, eax<br /><span style="color: #804040;">31 </span>&nbsp;&nbsp;&nbsp;&nbsp;}<br /><span style="color: #804040;">32 </span><br /><span style="color: #804040;">33 </span>&nbsp;&nbsp;&nbsp;&nbsp;DWORD ldwFuncLen = ldwEnd - ldwBegin;<br /><span style="color: #804040;">34 </span>&nbsp;&nbsp;&nbsp;&nbsp;BYTE *lpbyRand = new BYTE[ldwFuncLen];<br /><span style="color: #804040;">35 </span><br /><span style="color: #804040;">36 </span>&nbsp;&nbsp;&nbsp;&nbsp;DWORD ldwWritten = 0;<br /><span style="color: #804040;">37 </span>&nbsp;&nbsp;&nbsp;&nbsp;memcpy((void*)ldwBegin, lpbyRand, ldwFuncLen);<br /><span style="color: #804040;">38 </span><br /><span style="color: #804040;">39 </span>&nbsp;&nbsp;&nbsp;&nbsp;delete[] lpbyRand;<br /><span style="color: #804040;">40 </span>}<br /><span style="color: #804040;">41 </span><br /><span style="color: #804040;">42 </span>int main(int argc, char* argv[])<br /><span style="color: #804040;">43 </span>{<br /><span style="color: #804040;">44 </span>&nbsp;&nbsp;&nbsp;&nbsp;Run();<br /><span style="color: #804040;">45 </span>&nbsp;&nbsp;&nbsp;&nbsp;MessageBox(NULL, _T(<span style="color: fuchsia;">"OK"</span>), _T(<span style="color: fuchsia;">"OK"</span>), MB_OK);<br /><span style="color: #804040;">46 </span><br /><span style="color: #804040;">47 </span>&nbsp;&nbsp;&nbsp;&nbsp;return 0;<br /><span style="color: #804040;">48 </span>}<br /><span style="color: #804040;">49 </span><br /><span style="color: #804040;">50</span></span></span><span style='color: #804040; font-family: "Courier New"; mso-fareast-language: ZH-CN;' lang="EN-US"></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt;"><span style='color: #804040; font-family: "Courier New"; mso-fareast-language: ZH-CN;' lang="EN-US"><span style="font-size: small;">&nbsp;</span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt;"><span style="font-size: small;"><span style="font-family: 宋体; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin; mso-fareast-language: ZH-CN;">这样做后，就没有办法简单的将</span><span style="mso-fareast-language: ZH-CN;" lang="EN-US"><span style="font-family: Calibri;">memcpy</span></span><span style="font-family: 宋体; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin; mso-fareast-language: ZH-CN;">挂上使其无效化来使得擦除无效，而且，从发现你的目的的难度上来讲也更加大一些，毕竟</span><span style="mso-fareast-language: ZH-CN;" lang="EN-US"><span style="font-family: Calibri;">memcpy</span></span><span style="font-family: 宋体; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin; mso-fareast-language: ZH-CN;">这种函数使用的频率太高了，你可能因为各种原因使用它，而不仅仅是反</span><span style="mso-fareast-language: ZH-CN;" lang="EN-US"><span style="font-family: Calibri;">Dump</span></span><span style="font-family: 宋体; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin; mso-fareast-language: ZH-CN;">的目的。这也加大了分析的难度：）</span><span style="mso-fareast-language: ZH-CN;" lang="EN-US"></span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt;"><span style="mso-fareast-language: ZH-CN;" lang="EN-US"><span style="font-size: small; font-family: Calibri;">&nbsp;</span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt;"><span style="mso-fareast-language: ZH-CN;" lang="EN-US"><span style="font-size: small; font-family: Calibri;">&nbsp;</span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt;"><span style="mso-fareast-language: ZH-CN;" lang="EN-US"><span style="font-size: small; font-family: Calibri;">&nbsp;</span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt;"><span style="mso-fareast-language: ZH-CN;" lang="EN-US"><span style="font-size: small; font-family: Calibri;">&nbsp;</span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt;"><span style='color: #a020f0; font-family: "Courier New"; mso-fareast-language: ZH-CN;' lang="EN-US"><span style="font-size: small;">&nbsp;</span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt; text-align: right;" align="right"><span lang="EN-US"><a href="http://www.jtianling.com"><span style="font-size: small;"><span style="color: #800080;"><strong><span style="letter-spacing: 0.25pt; font-variant: small-caps; mso-fareast-language: ZH-CN;"><span style="font-family: Calibri;">write by </span></span></strong><strong><span style="font-family: 宋体; letter-spacing: 0.25pt; font-variant: small-caps; mso-fareast-language: ZH-CN;" lang="EN-US"><span lang="EN-US">九天雁翎</span></span></strong><strong><span style="letter-spacing: 0.25pt; font-variant: small-caps; mso-fareast-language: ZH-CN;"><span style="font-family: Calibri;">(JTianLing) -- www.jtianling.com</span></span></strong></span></span></a></span><span style="mso-fareast-language: ZH-CN;" lang="EN-US"></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt;"><span style="mso-fareast-language: ZH-CN;" lang="EN-US"><span style="font-size: small; font-family: Calibri;">&nbsp;</span></span></p>
