---
layout: post
title: "服务器Select模型的实现"
categories:
- "网络技术"
tags:
- Select模型
status: publish
type: post
published: true
meta:
  ratings_users: '0'
  ratings_score: '0'
  ratings_average: '0'
  views: '21'
author:
  login: jtianling
  email: jtianling@gmail.com
  display_name: jtianling
  first_name: ''
  last_name: ''
---
<br />
<h1 style="margin: 24pt 0cm 0pt;"><span style="color: #365f91;"><span style="font-size: x-large;"><span style="font-family: 宋体; mso-ascii-font-family: Cambria; mso-ascii-theme-font: major-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: major-fareast; mso-hansi-font-family: Cambria; mso-hansi-theme-font: major-latin;">服务器</span><span lang="EN-US"><span style="font-family: Cambria;">Select</span></span><span style="font-family: 宋体; mso-ascii-font-family: Cambria; mso-ascii-theme-font: major-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: major-fareast; mso-hansi-font-family: Cambria; mso-hansi-theme-font: major-latin;">模型的实现</span></span></span></h1>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt; text-align: right;" align="right"><span lang="EN-US"><a href="http://www.jtianling.com"><span style="font-size: small;"><span style="color: #800080;"><strong><span style="letter-spacing: 0.25pt; font-variant: small-caps;"><span style="font-family: Calibri;">write by </span></span></strong><strong><span style="font-family: 宋体; letter-spacing: 0.25pt; font-variant: small-caps;">九天雁翎</span><span style="letter-spacing: 0.25pt; font-variant: small-caps;"><span style="font-family: Calibri;">(JTianLing) -- www.jtianling.com</span></span></strong></span></span></a></span><strong><span style="text-decoration: underline;"></span></strong></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt; text-align: right;" align="right"><span lang="EN-US"><a href="http://groups.google.com/group/jiutianfile/"><strong><span style="font-family: 宋体; letter-spacing: 0.25pt; font-variant: small-caps; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin; mso-fareast-language: ZH-CN;" lang="EN-US"><span lang="EN-US"><span style="font-size: small;">讨论新闻组及文件</span></span></span></strong></a></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt; text-indent: 21pt;"><span style="font-size: large;"><span style="mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA;" lang="EN-US"><span style="font-family: Calibri;">select</span></span><span style="font-family: 宋体; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA;">模型属于网络的</span><span style="mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA;" lang="EN-US"><span style="font-family: Calibri;">I/O</span></span><span style="font-family: 宋体; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA;">复用模型，比纯粹的阻塞</span><span style="mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA;" lang="EN-US"><span style="font-family: Calibri;">I/O</span></span><span style="font-family: 宋体; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA;">模型更具有实用性，因为可以同时等待多个描述字的就绪。</span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt; text-indent: 21pt;"><span style="font-size: large;"><span style="font-family: 宋体; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA;">当年学习</span><span style="mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA;" lang="EN-US"><span style="font-family: Calibri;">C/C++</span></span><span style="font-family: 宋体; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA;">的时候，很少碰到底层以数字标示的描述字，只在写文件系统的去尝试各种情况，以获得最佳效率的时候实际尝试使用过一次，一直觉得那种</span><span style="mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA;" lang="EN-US"><span style="font-family: Calibri;">open,write,read</span></span><span style="font-family: 宋体; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA;">的文件操作方式，实在是比</span><span style="mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA;" lang="EN-US"><span style="font-family: Calibri;">fopen</span></span><span style="font-family: 宋体; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA;">一族函数还要低级的方式</span><span style="mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA;" lang="EN-US"><span style="font-family: Calibri;">-_-!</span></span><span style="font-family: 宋体; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA;">平时没有必要使用。但是等到网络编程的时候，才发现。。。。原来这么底层的东西，竟然也有一定的通用性，文件的描述字和网络的描述字竟然是一致的</span><span style="mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA;" lang="EN-US"><span style="font-family: Calibri;">-_-!</span></span><span style="font-family: 宋体; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA;">不管是谁设计的，还是挺佩服的。。。。。。</span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt;"><span style="font-size: large;"><span style="mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA;" lang="EN-US"><span style="mso-tab-count: 1;"><span style="font-family: Calibri;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span><span style="font-family: 宋体; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA;">这里仅仅是为了学习</span><span style="mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA;" lang="EN-US"><span style="font-family: Calibri;">Select</span></span><span style="font-family: 宋体; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA;">模型而写的学习例子，作用是在服务器端输出连接上的客户端的</span><span style="mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA;" lang="EN-US"><span style="font-family: Calibri;">IP(</span></span><span style="font-family: 宋体; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA;">仅以数字形式</span><span style="mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA;" lang="EN-US"><span style="font-family: Calibri;">)</span></span><span style="font-family: 宋体; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA;">，然后将客户端的</span><span style="mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA;" lang="EN-US"><span style="font-family: Calibri;">IP</span></span><span style="font-family: 宋体; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA;">以字符串的形式返回，客户端连接服务器，并接受由服务器端返回的</span><span style="mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA;" lang="EN-US"><span style="font-family: Calibri;">IP</span></span><span style="font-family: 宋体; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA;">地址，然后输出转换为字符串形式的</span><span style="mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA;" lang="EN-US"><span style="font-family: Calibri;">IP</span></span><span style="font-family: 宋体; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA;">地址和数字形式的</span><span style="mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA;" lang="EN-US"><span style="font-family: Calibri;">IP</span></span><span style="font-family: 宋体; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA;">地址，为了区别</span><span style="mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA;" lang="EN-US"><span style="font-family: Calibri;">select</span></span><span style="font-family: 宋体; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA;">到正确的不同</span><span style="mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA;" lang="EN-US"><span style="font-family: Calibri;">listen</span></span><span style="font-family: 宋体; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA;">套接字，这里用了不同的端口，并且不同的两个套接字响应时以</span><span style="mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA;" lang="EN-US"><span style="font-family: Calibri;">echo 1,echo 2</span></span><span style="font-family: 宋体; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA;">区别。功能是很简单的，仅仅用于学习，所以其中很多地方本来可以抽出来称为函数的，都贪简单，直接复制了</span><span style="mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA;" lang="EN-US"><span style="font-family: Calibri;">(-_-!</span></span><span style="font-family: 宋体; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA;">这里本来习惯想说</span><span style="mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA;" lang="EN-US"><span style="font-family: Calibri;">Ctrl-C Ctrl-V</span></span><span style="font-family: 宋体; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA;">的。。。但是发现自己实在</span><span style="mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA;" lang="EN-US"><span style="font-family: Calibri;">Ubuntu</span></span><span style="font-family: 宋体; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA;">下用</span><span style="mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA;" lang="EN-US"><span style="font-family: Calibri;">vim</span></span><span style="font-family: 宋体; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA;">复制的，好像和实际情况不符。。。。</span><span style="mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA;" lang="EN-US"><span style="font-family: Calibri;">)</span></span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt;"><span style="font-size: large;"><span style="mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA;" lang="EN-US"><span style="mso-tab-count: 1;"><span style="font-family: Calibri;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span><span style="font-family: 宋体; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA;">另外。。。。由于用的是《</span><span style="mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA;" lang="EN-US"><span style="font-family: Calibri;">Unix Network Programming</span></span><span style="font-family: 宋体; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA;">》一书，所以编程风格都变得有点像书中了。。。。服务器端全是自己写的，客户端代码由书中的</span><span style="mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA;" lang="EN-US"><span style="font-family: Calibri;">daytime</span></span><span style="font-family: 宋体; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA;">客户端改过来的，并且发现书中客户端代码都不关闭套接字，都交由退出进程的时候由系统关闭，不知道这种风格好不好。由于学习。。。写的是</span><span style="mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA;" lang="EN-US"><span style="font-family: Calibri;">ANSI C</span></span><span style="font-family: 宋体; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA;">程序，用</span><span style="mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA;" lang="EN-US"><span style="font-family: Calibri;">gcc</span></span><span style="font-family: 宋体; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA;">编译</span><span style="mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA;" lang="EN-US"><span style="font-family: Calibri;">-_-!</span></span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt; text-indent: 21pt;"><span style="font-size: large;"><span style="mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA;" lang="EN-US"><span style="font-family: Calibri;">unp.h</span></span><span style="font-family: 宋体; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA;">是《</span><span style="mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA;" lang="EN-US"><span style="font-family: Calibri;">Unix Network Programming</span></span><span style="font-family: 宋体; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA;">》源代码中的公用头文件，</span><span style="mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA;" lang="EN-US"><span style="font-family: Calibri;">makefile</span></span><span style="font-family: 宋体; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA;">可能也得注意一下，为了图省事，我用了其源代码中的</span><span style="mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA;" lang="EN-US"><span style="font-family: Calibri;">Make.defines</span></span><span style="font-family: 宋体; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA;">，因为这样比自己写简单多了：），</span><span style="mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA;" lang="EN-US"><span style="font-family: Calibri;">makefile</span></span><span style="font-family: 宋体; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA;">就不贴了，没有什么学习意义。</span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt;"><span style="mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA;" lang="EN-US"><span style="font-family: Calibri;"><span style="font-size: large;">&nbsp;</span></span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt;"><span style="font-size: large;"><span style="font-family: 宋体; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin; mso-fareast-language: ZH-CN;">运行效果如下：</span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt;"><span style="font-size: large;"><span style="font-family: 宋体; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin; mso-fareast-language: ZH-CN;">客户端运行：</span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt;"><span style="mso-fareast-language: ZH-CN;" lang="EN-US"><span style="font-size: small;"><span style="font-family: Calibri;"><span style="font-size: large;">./TestSelectCli 127.0.0.1 1000</span></span></span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt;"><span style="mso-fareast-language: ZH-CN;" lang="EN-US"><span style="font-size: small;"><span style="font-family: Calibri;"><span style="font-size: large;">Conncet OK</span></span></span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt;"><span style="mso-fareast-language: ZH-CN;" lang="EN-US"><span style="font-size: small;"><span style="font-family: Calibri;"><span style="font-size: large;">127.0.0.1:16777343 Echo 1.</span></span></span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt;"><span style="mso-fareast-language: ZH-CN;" lang="EN-US"><span style="font-size: small;"><span style="font-family: Calibri;"><span style="font-size: large;">laptop:~/unpv1/unpv13e/MyTest$ ./TestSelectCli 127.0.0.1 1001</span></span></span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt;"><span style="mso-fareast-language: ZH-CN;" lang="EN-US"><span style="font-size: small;"><span style="font-family: Calibri;"><span style="font-size: large;">Conncet OK</span></span></span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt;"><span style="mso-fareast-language: ZH-CN;" lang="EN-US"><span style="font-size: small;"><span style="font-family: Calibri;"><span style="font-size: large;">127.0.0.1:16777343 Echo 2.</span></span></span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt;"><span style="mso-fareast-language: ZH-CN;" lang="EN-US"><span style="font-size: small;"><span style="font-family: Calibri;"><span style="font-size: large;">laptop:~/unpv1/unpv13e/MyTest$ ./TestSelectCli 192.168.0.138 1000</span></span></span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt;"><span style="mso-fareast-language: ZH-CN;" lang="EN-US"><span style="font-size: small;"><span style="font-family: Calibri;"><span style="font-size: large;">Conncet OK</span></span></span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt;"><span style="mso-fareast-language: ZH-CN;" lang="EN-US"><span style="font-size: small;"><span style="font-family: Calibri;"><span style="font-size: large;">192.168.0.138:2315299008 Echo 1.</span></span></span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt;"><span style="mso-fareast-language: ZH-CN;" lang="EN-US"><span style="font-size: small;"><span style="font-family: Calibri;"><span style="font-size: large;">laptop:~/unpv1/unpv13e/MyTest$ ./TestSelectCli 192.168.0.138 1001</span></span></span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt;"><span style="mso-fareast-language: ZH-CN;" lang="EN-US"><span style="font-size: small;"><span style="font-family: Calibri;"><span style="font-size: large;">Conncet OK</span></span></span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt;"><span style="mso-fareast-language: ZH-CN;" lang="EN-US"><span style="font-size: small;"><span style="font-family: Calibri;"><span style="font-size: large;">192.168.0.138:2315299008 Echo 2.</span></span></span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt;"><span style="mso-fareast-language: ZH-CN;" lang="EN-US"><span style="font-family: Calibri;"><span style="font-size: large;">&nbsp;</span></span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt;"><span style="font-size: large;"><span style="font-family: 宋体; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin; mso-fareast-language: ZH-CN;">服务器端输出：</span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt;"><span style="mso-fareast-language: ZH-CN;" lang="EN-US"><span style="font-size: small;"><span style="font-family: Calibri;"><span style="font-size: large;">2315299008 Echo 1.</span></span></span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt;"><span style="mso-fareast-language: ZH-CN;" lang="EN-US"><span style="font-size: small;"><span style="font-family: Calibri;"><span style="font-size: large;">16777343 Echo 1.</span></span></span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt;"><span style="mso-fareast-language: ZH-CN;" lang="EN-US"><span style="font-size: small;"><span style="font-family: Calibri;"><span style="font-size: large;">16777343 Echo 2.</span></span></span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt;"><span style="mso-fareast-language: ZH-CN;" lang="EN-US"><span style="font-size: small;"><span style="font-family: Calibri;"><span style="font-size: large;">2315299008 Echo 1.</span></span></span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt;"><span style="mso-fareast-language: ZH-CN;" lang="EN-US"><span style="font-size: small;"><span style="font-family: Calibri;"><span style="font-size: large;">2315299008 Echo 2.</span></span></span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt;"><span style="mso-fareast-language: ZH-CN;" lang="EN-US"><span style="font-family: Calibri;"><span style="font-size: large;">&nbsp;</span></span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt;"><span style="mso-fareast-language: ZH-CN;" lang="EN-US"><span style="font-family: Calibri;"><span style="font-size: large;">&nbsp;</span></span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt;"><span style="font-size: large;"><span style="font-family: 宋体; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin; mso-fareast-language: ZH-CN;">服务器端源代码：</span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt;"><span style="mso-fareast-language: ZH-CN;" lang="EN-US"><span style="font-family: Calibri;"><span style="font-size: large;">&nbsp;</span></span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt;"><span style="font-size: large;"><span style='color: #804040; font-family: "Courier New";' lang="EN-US">&nbsp;&nbsp;1 </span><span style='color: #a020f0; font-family: "Courier New";' lang="EN-US">#include&nbsp;&nbsp;&nbsp;&nbsp;</span><span style='color: fuchsia; font-family: "Courier New";' lang="EN-US">"unp.h"</span></span><span style='font-family: "Courier New";' lang="EN-US"><br /><span style="font-size: large;"><span style="color: #804040;">&nbsp;&nbsp;2 </span><br /><span style="color: #804040;">&nbsp;&nbsp;3 </span><br /><span style="color: #804040;">&nbsp;&nbsp;4 </span><strong><span style="color: seagreen;">void</span></strong>&nbsp;str_echo1(<strong><span style="color: seagreen;">int</span></strong>&nbsp;connfd);<br /><span style="color: #804040;">&nbsp;&nbsp;5 </span><strong><span style="color: seagreen;">void</span></strong>&nbsp;str_echo2(<strong><span style="color: seagreen;">int</span></strong>&nbsp;connfd);<br /><span style="color: #804040;">&nbsp;&nbsp;6 </span><br /><span style="color: #804040;">&nbsp;&nbsp;7 </span><strong><span style="color: seagreen;">int</span></strong>&nbsp;main(<strong><span style="color: seagreen;">int</span></strong>&nbsp;argc, <strong><span style="color: seagreen;">char</span></strong>&nbsp;**argv)<br /><span style="color: #804040;">&nbsp;&nbsp;8 </span>{<br /><span style="color: #804040;">&nbsp;&nbsp;9 </span>&nbsp;&nbsp;&nbsp;&nbsp;<strong><span style="color: seagreen;">struct</span></strong>&nbsp;sockaddr_in cliaddr;<br /><span style="color: #804040;">&nbsp;10 </span>&nbsp;&nbsp;&nbsp;&nbsp;pid_t childpid;<br /><span style="color: #804040;">&nbsp;11 </span><br /><span style="color: #804040;">&nbsp;12 </span>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: blue;">/*&nbsp;&nbsp;Bind 1000 port to listen socket 1 */</span><br /><span style="color: #804040;">&nbsp;13 </span>&nbsp;&nbsp;&nbsp;&nbsp;<strong><span style="color: seagreen;">int</span></strong>&nbsp;listenfd1 = Socket(AF_INET, SOCK_STREAM, <span style="color: fuchsia;">0</span>);<br /><span style="color: #804040;">&nbsp;14 </span><br /><span style="color: #804040;">&nbsp;15 </span>&nbsp;&nbsp;&nbsp;&nbsp;<strong><span style="color: seagreen;">struct</span></strong>&nbsp;sockaddr_in servaddr;<br /><span style="color: #804040;">&nbsp;16 </span>&nbsp;&nbsp;&nbsp;&nbsp;bzero(&amp;servaddr, <strong><span style="color: #804040;">sizeof</span></strong>(servaddr));<br /><span style="color: #804040;">&nbsp;17 </span>&nbsp;&nbsp;&nbsp;&nbsp;servaddr.sin_family = AF_INET;<br /><span style="color: #804040;">&nbsp;18 </span>&nbsp;&nbsp;&nbsp;&nbsp;servaddr.sin_addr.s_addr = htonl(INADDR_ANY);<br /><span style="color: #804040;">&nbsp;19 </span>&nbsp;&nbsp;&nbsp;&nbsp;servaddr.sin_port = htons(<span style="color: fuchsia;">1000</span>);<br /><span style="color: #804040;">&nbsp;20 </span><br /><span style="color: #804040;">&nbsp;21 </span>&nbsp;&nbsp;&nbsp;&nbsp;Bind(listenfd1, (SA *)&amp;servaddr, <strong><span style="color: #804040;">sizeof</span></strong>(servaddr));<br /><span style="color: #804040;">&nbsp;22 </span><br /><span style="color: #804040;">&nbsp;23 </span>&nbsp;&nbsp;&nbsp;&nbsp;Listen(listenfd1, LISTENQ);<br /><span style="color: #804040;">&nbsp;24 </span><br /><span style="color: #804040;">&nbsp;25 </span>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: blue;">/*&nbsp;&nbsp;Bind 1001 port to listen socket 2*/</span><br /><span style="color: #804040;">&nbsp;26 </span>&nbsp;&nbsp;&nbsp;&nbsp;<strong><span style="color: seagreen;">int</span></strong>&nbsp;listenfd2 = Socket(AF_INET, SOCK_STREAM, <span style="color: fuchsia;">0</span>);<br /><span style="color: #804040;">&nbsp;27 </span><br /><span style="color: #804040;">&nbsp;28 </span>&nbsp;&nbsp;&nbsp;&nbsp;<strong><span style="color: seagreen;">struct</span></strong>&nbsp;sockaddr_in servaddr2;<br /><span style="color: #804040;">&nbsp;29 </span>&nbsp;&nbsp;&nbsp;&nbsp;bzero(&amp;servaddr2, <strong><span style="color: #804040;">sizeof</span></strong>(servaddr2));<br /><span style="color: #804040;">&nbsp;30 </span>&nbsp;&nbsp;&nbsp;&nbsp;servaddr2.sin_family = AF_INET;<br /><span style="color: #804040;">&nbsp;31 </span>&nbsp;&nbsp;&nbsp;&nbsp;servaddr2.sin_addr.s_addr = htonl(INADDR_ANY);<br /><span style="color: #804040;">&nbsp;32 </span>&nbsp;&nbsp;&nbsp;&nbsp;servaddr2.sin_port = htons(<span style="color: fuchsia;">1001</span>);<br /><span style="color: #804040;">&nbsp;33 </span><br /><span style="color: #804040;">&nbsp;34 </span>&nbsp;&nbsp;&nbsp;&nbsp;Bind(listenfd2, (SA *)&amp;servaddr2, <strong><span style="color: #804040;">sizeof</span></strong>(servaddr2));<br /><span style="color: #804040;">&nbsp;35 </span><br /><span style="color: #804040;">&nbsp;36 </span>&nbsp;&nbsp;&nbsp;&nbsp;Listen(listenfd2, LISTENQ);<br /><span style="color: #804040;">&nbsp;37 </span><br /><span style="color: #804040;">&nbsp;38 </span>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: blue;">/*&nbsp;Initialize fd_set struct */</span><br /><span style="color: #804040;">&nbsp;39 </span>&nbsp;&nbsp;&nbsp;&nbsp;<strong><span style="color: seagreen;">int</span></strong>&nbsp;maxfdp1 = max(listenfd1, listenfd2) + <span style="color: fuchsia;">1</span>;<br /><span style="color: #804040;">&nbsp;40 </span>&nbsp;&nbsp;&nbsp;&nbsp;fd_set rset;<br /><span style="color: #804040;">&nbsp;41 </span>&nbsp;&nbsp;&nbsp;&nbsp;FD_ZERO(&amp;rset);<br /><span style="color: #804040;">&nbsp;42 </span><br /><span style="color: #804040;">&nbsp;43 </span>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: blue;">/*&nbsp;&nbsp;Select from this two listen socket */</span><br /><span style="color: #804040;">&nbsp;44 </span>&nbsp;&nbsp;&nbsp;&nbsp;<strong><span style="color: #804040;">for</span></strong>( ; ; )<br /><span style="color: #804040;">&nbsp;45 </span>&nbsp;&nbsp;&nbsp;&nbsp;{<br /><span style="color: #804040;">&nbsp;46 </span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FD_SET(listenfd1, &amp;rset);<br /><span style="color: #804040;">&nbsp;47 </span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FD_SET(listenfd2, &amp;rset);<br /><span style="color: #804040;">&nbsp;48 </span><br /><span style="color: #804040;">&nbsp;49 </span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong><span style="color: seagreen;">int</span></strong>&nbsp;nready = -<span style="color: fuchsia;">1</span>;<br /><span style="color: #804040;">&nbsp;50 </span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong><span style="color: #804040;">if</span></strong>( (nready = select(maxfdp1, &amp;rset, <span style="color: fuchsia;">NULL</span>, <span style="color: fuchsia;">NULL</span>, <span style="color: fuchsia;">NULL</span>)) &lt; <span style="color: fuchsia;">0</span>)<br /><span style="color: #804040;">&nbsp;51 </span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br /><span style="color: #804040;">&nbsp;52 </span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong><span style="color: #804040;">if</span></strong>(<span style="color: fuchsia;">EINTR</span>&nbsp;== errno)<br /><span style="color: #804040;">&nbsp;53 </span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br /><span style="color: #804040;">&nbsp;54 </span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong><span style="color: #804040;">continue</span></strong>;<br /><span style="color: #804040;">&nbsp;55 </span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br /><span style="color: #804040;">&nbsp;56 </span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong><span style="color: #804040;">else</span></strong><br /><span style="color: #804040;">&nbsp;57 </span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br /><span style="color: #804040;">&nbsp;58 </span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;err_sys(<span style="color: fuchsia;">"Select error."</span>);<br /><span style="color: #804040;">&nbsp;59 </span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br /><span style="color: #804040;">&nbsp;60 </span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br /><span style="color: #804040;">&nbsp;61 </span><br /><span style="color: #804040;">&nbsp;62 </span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: blue;">/*&nbsp;&nbsp;some one listening socket is readable.*/</span><br /><span style="color: #804040;">&nbsp;63 </span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong><span style="color: #804040;">if</span></strong>(FD_ISSET(listenfd1, &amp;rset))<br /><span style="color: #804040;">&nbsp;64 </span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br /><span style="color: #804040;">&nbsp;65 </span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;socklen_t len = <strong><span style="color: #804040;">sizeof</span></strong>(cliaddr);<br /><span style="color: #804040;">&nbsp;66 </span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong><span style="color: seagreen;">int</span></strong>&nbsp;connfd = Accept(listenfd1, (SA *)&amp;cliaddr, &amp;len);<br /><span style="color: #804040;">&nbsp;67 </span><br /><span style="color: #804040;">&nbsp;68 </span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong><span style="color: #804040;">if</span></strong>( <span style="color: fuchsia;">0</span>&nbsp;== (childpid = Fork()) )<br /><span style="color: #804040;">&nbsp;69 </span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br /><span style="color: #804040;">&nbsp;70 </span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: blue;">/*&nbsp;child process */</span><br /><span style="color: #804040;">&nbsp;71 </span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Close(listenfd1);<br /><span style="color: #804040;">&nbsp;72 </span><br /><span style="color: #804040;">&nbsp;73 </span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;str_echo1(connfd);<br /><span style="color: #804040;">&nbsp;74 </span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exit(<span style="color: fuchsia;">0</span>);<br /><span style="color: #804040;">&nbsp;75 </span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br /><span style="color: #804040;">&nbsp;76 </span><br /><span style="color: #804040;">&nbsp;77 </span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: blue;">/*&nbsp;parent process&nbsp;&nbsp;*/</span><br /><span style="color: #804040;">&nbsp;78 </span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Close(connfd);<br /><span style="color: #804040;">&nbsp;79 </span><br /><span style="color: #804040;">&nbsp;80 </span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br /><span style="color: #804040;">&nbsp;81 </span><br /><span style="color: #804040;">&nbsp;82 </span><br /><span style="color: #804040;">&nbsp;83 </span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong><span style="color: #804040;">if</span></strong>(FD_ISSET(listenfd2, &amp;rset))<br /><span style="color: #804040;">&nbsp;84 </span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br /><span style="color: #804040;">&nbsp;85 </span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;socklen_t len = <strong><span style="color: #804040;">sizeof</span></strong>(cliaddr);<br /><span style="color: #804040;">&nbsp;86 </span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong><span style="color: seagreen;">int</span></strong>&nbsp;connfd = Accept(listenfd2, (SA *)&amp;cliaddr, &amp;len);<br /><span style="color: #804040;">&nbsp;87 </span><br /><span style="color: #804040;">&nbsp;88 </span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong><span style="color: #804040;">if</span></strong>( <span style="color: fuchsia;">0</span>&nbsp;== (childpid = Fork()) )<br /><span style="color: #804040;">&nbsp;89 </span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br /><span style="color: #804040;">&nbsp;90 </span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: blue;">/*&nbsp;child process */</span><br /><span style="color: #804040;">&nbsp;91 </span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Close(listenfd2);<br /><span style="color: #804040;">&nbsp;92 </span><br /><span style="color: #804040;">&nbsp;93 </span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;str_echo2(connfd);<br /><span style="color: #804040;">&nbsp;94 </span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exit(<span style="color: fuchsia;">0</span>);<br /><span style="color: #804040;">&nbsp;95 </span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br /><span style="color: #804040;">&nbsp;96 </span><br /><span style="color: #804040;">&nbsp;97 </span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: blue;">/*&nbsp;parent process&nbsp;&nbsp;*/</span><br /><span style="color: #804040;">&nbsp;98 </span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Close(connfd);<br /><span style="color: #804040;">&nbsp;99 </span><br /><span style="color: #804040;">100 </span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br /><span style="color: #804040;">101 </span><br /><span style="color: #804040;">102 </span>&nbsp;&nbsp;&nbsp;&nbsp;}<br /><span style="color: #804040;">103 </span><br /><span style="color: #804040;">104 </span>&nbsp;&nbsp;&nbsp;&nbsp;exit(<span style="color: fuchsia;">0</span>);<br /><span style="color: #804040;">105 </span>}<br /><span style="color: #804040;">106 </span><br /><span style="color: #804040;">107 </span><strong><span style="color: seagreen;">void</span></strong>&nbsp;str_echo1(<strong><span style="color: seagreen;">int</span></strong>&nbsp;connfd)<br /><span style="color: #804040;">108 </span>{<br /><span style="color: #804040;">109 </span>&nbsp;&nbsp;&nbsp;&nbsp;<strong><span style="color: seagreen;">struct</span></strong>&nbsp;sockaddr_in clientAddr;<br /><span style="color: #804040;">110 </span>&nbsp;&nbsp;&nbsp;&nbsp;socklen_t len = <strong><span style="color: #804040;">sizeof</span></strong>(clientAddr);<br /><span style="color: #804040;">111 </span><br /><span style="color: #804040;">112 </span>&nbsp;&nbsp;&nbsp;&nbsp;<strong><span style="color: #804040;">if</span></strong>(getpeername(connfd, (SA*) &amp;clientAddr, &amp;len) &lt; <span style="color: fuchsia;">0</span>)<br /><span style="color: #804040;">113 </span>&nbsp;&nbsp;&nbsp;&nbsp;{<br /><span style="color: #804040;">114 </span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong><span style="color: #804040;">return</span></strong>;<br /><span style="color: #804040;">115 </span>&nbsp;&nbsp;&nbsp;&nbsp;}<br /><span style="color: #804040;">116 </span><br /><span style="color: #804040;">117 </span>&nbsp;&nbsp;&nbsp;&nbsp;<strong><span style="color: seagreen;">char</span></strong>&nbsp;lcBuffer[MAXLINE] = {<span style="color: fuchsia;">0</span>};<br /><span style="color: #804040;">118 </span>&nbsp;&nbsp;&nbsp;&nbsp;sprintf(lcBuffer, <span style="color: fuchsia;">"</span><span style="color: slateblue;">%u</span><span style="color: fuchsia;">&nbsp;Echo 1."</span>, clientAddr.sin_addr.s_addr);<br /><span style="color: #804040;">119 </span><br /><span style="color: #804040;">120 </span>&nbsp;&nbsp;&nbsp;&nbsp;printf(<span style="color: fuchsia;">"</span><span style="color: slateblue;">%s/n</span><span style="color: fuchsia;">"</span>, lcBuffer);<br /><span style="color: #804040;">121 </span><br /><span style="color: #804040;">122 </span>&nbsp;&nbsp;&nbsp;&nbsp;Write(connfd, lcBuffer, MAXLINE);<br /><span style="color: #804040;">123 </span>}<br /><span style="color: #804040;">124 </span><br /><span style="color: #804040;">125 </span><br /><span style="color: #804040;">126 </span><strong><span style="color: seagreen;">void</span></strong>&nbsp;str_echo2(<strong><span style="color: seagreen;">int</span></strong>&nbsp;connfd)<br /><span style="color: #804040;">127 </span>{<br /><span style="color: #804040;">128 </span>&nbsp;&nbsp;&nbsp;&nbsp;<strong><span style="color: seagreen;">struct</span></strong>&nbsp;sockaddr_in clientAddr;<br /><span style="color: #804040;">129 </span>&nbsp;&nbsp;&nbsp;&nbsp;socklen_t len = <strong><span style="color: #804040;">sizeof</span></strong>(clientAddr);<br /><span style="color: #804040;">130 </span><br /><span style="color: #804040;">131 </span>&nbsp;&nbsp;&nbsp;&nbsp;<strong><span style="color: #804040;">if</span></strong>(getpeername(connfd, (SA*) &amp;clientAddr, &amp;len) &lt; <span style="color: fuchsia;">0</span>)<br /><span style="color: #804040;">132 </span>&nbsp;&nbsp;&nbsp;&nbsp;{<br /><span style="color: #804040;">133 </span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong><span style="color: #804040;">return</span></strong>;<br /><span style="color: #804040;">134 </span>&nbsp;&nbsp;&nbsp;&nbsp;}<br /><span style="color: #804040;">135 </span><br /><span style="color: #804040;">136 </span><br /><span style="color: #804040;">137 </span>&nbsp;&nbsp;&nbsp;&nbsp;<strong><span style="color: seagreen;">char</span></strong>&nbsp;lcBuffer[MAXLINE] = {<span style="color: fuchsia;">0</span>};<br /><span style="color: #804040;">138 </span>&nbsp;&nbsp;&nbsp;&nbsp;sprintf(lcBuffer, <span style="color: fuchsia;">"</span><span style="color: slateblue;">%u</span><span style="color: fuchsia;">&nbsp;Echo 2."</span>, clientAddr.sin_addr.s_addr);<br /><span style="color: #804040;">139 </span><br /><span style="color: #804040;">140 </span>&nbsp;&nbsp;&nbsp;&nbsp;printf(<span style="color: fuchsia;">"</span><span style="color: slateblue;">%s/n</span><span style="color: fuchsia;">"</span>, lcBuffer);<br /><span style="color: #804040;">141 </span><br /><span style="color: #804040;">142 </span>&nbsp;&nbsp;&nbsp;&nbsp;Write(connfd, lcBuffer, MAXLINE);<br /><span style="color: #804040;">143 </span>}<br /><span style="color: #804040;">144 </span><br /><span style="color: #804040;">145</span></span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt;"><span style='color: #804040; font-family: "Courier New"; mso-fareast-language: ZH-CN;' lang="EN-US"><span style="font-size: large;">&nbsp;</span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt;"><span style="font-size: large;"><span style="color: #804040; font-family: 宋体; mso-ascii-font-family: 'Courier New'; mso-fareast-font-family: 宋体; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: 'Courier New'; mso-fareast-language: ZH-CN; mso-bidi-font-family: 'Courier New';">客户端源代码：</span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt;"><span style="font-size: large;"><span style='color: #804040; font-family: "Courier New";' lang="EN-US">&nbsp;1 </span><span style='color: #a020f0; font-family: "Courier New";' lang="EN-US">#include&nbsp;&nbsp;&nbsp;&nbsp;</span><span style='color: fuchsia; font-family: "Courier New";' lang="EN-US">"unp.h"</span></span><span style='font-family: "Courier New";' lang="EN-US"><br /><span style="font-size: large;"><span style="color: #804040;">&nbsp;2 </span><br /><span style="color: #804040;">&nbsp;3 </span><strong><span style="color: seagreen;">int</span></strong>&nbsp;main(<strong><span style="color: seagreen;">int</span></strong>&nbsp;argc, <strong><span style="color: seagreen;">char</span></strong>&nbsp;**argv)<br /><span style="color: #804040;">&nbsp;4 </span>{<br /><span style="color: #804040;">&nbsp;5 </span>&nbsp;&nbsp;&nbsp;&nbsp;<strong><span style="color: seagreen;">int</span></strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sockfd, n;<br /><span style="color: #804040;">&nbsp;6 </span>&nbsp;&nbsp;&nbsp;&nbsp;<strong><span style="color: seagreen;">char</span></strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; recvline[MAXLINE + <span style="color: fuchsia;">1</span>];<br /><span style="color: #804040;">&nbsp;7 </span>&nbsp;&nbsp;&nbsp;&nbsp;<strong><span style="color: seagreen;">struct</span></strong>&nbsp;sockaddr_in servaddr;<br /><span style="color: #804040;">&nbsp;8 </span><br /><span style="color: #804040;">&nbsp;9 </span>&nbsp;&nbsp;&nbsp;&nbsp;<strong><span style="color: #804040;">if</span></strong>&nbsp;(argc != <span style="color: fuchsia;">3</span>)<br /><span style="color: #804040;">10 </span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;err_quit(<span style="color: fuchsia;">"usage: a.out &lt;IPaddress&gt; &lt;IPPort&gt;"</span>);<br /><span style="color: #804040;">11 </span><br /><span style="color: #804040;">12 </span>&nbsp;&nbsp;&nbsp;&nbsp;<strong><span style="color: seagreen;">int</span></strong>&nbsp;port = atoi(argv[<span style="color: fuchsia;">2</span>]);<br /><span style="color: #804040;">13 </span><br /><span style="color: #804040;">14 </span>&nbsp;&nbsp;&nbsp;&nbsp;<strong><span style="color: #804040;">if</span></strong>&nbsp;( (sockfd = socket(AF_INET, SOCK_STREAM, <span style="color: fuchsia;">0</span>)) &lt; <span style="color: fuchsia;">0</span>)<br /><span style="color: #804040;">15 </span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;err_sys(<span style="color: fuchsia;">"socket error"</span>);<br /><span style="color: #804040;">16 </span><br /><span style="color: #804040;">17 </span>&nbsp;&nbsp;&nbsp;&nbsp;bzero(&amp;servaddr, <strong><span style="color: #804040;">sizeof</span></strong>(servaddr));<br /><span style="color: #804040;">18 </span>&nbsp;&nbsp;&nbsp;&nbsp;servaddr.sin_family = AF_INET;<br /><span style="color: #804040;">19 </span>&nbsp;&nbsp;&nbsp;&nbsp;servaddr.sin_port&nbsp;&nbsp; = htons(port);<br /><span style="color: #804040;">20 </span>&nbsp;&nbsp;&nbsp;&nbsp;<strong><span style="color: #804040;">if</span></strong>&nbsp;(inet_pton(AF_INET, argv[<span style="color: fuchsia;">1</span>], &amp;servaddr.sin_addr) &lt;= <span style="color: fuchsia;">0</span>)<br /><span style="color: #804040;">21 </span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;err_quit(<span style="color: fuchsia;">"inet_pton error for </span><span style="color: slateblue;">%s</span><span style="color: fuchsia;">"</span>, argv[<span style="color: fuchsia;">1</span>]);<br /><span style="color: #804040;">22 </span><br /><span style="color: #804040;">23 </span>&nbsp;&nbsp;&nbsp;&nbsp;<strong><span style="color: #804040;">if</span></strong>&nbsp;(connect(sockfd, (SA *) &amp;servaddr, <strong><span style="color: #804040;">sizeof</span></strong>(servaddr)) &lt; <span style="color: fuchsia;">0</span>)<br /><span style="color: #804040;">24 </span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;err_sys(<span style="color: fuchsia;">"connect error"</span>);<br /><span style="color: #804040;">25 </span><br /><span style="color: #804040;">26 </span>&nbsp;&nbsp;&nbsp;&nbsp;printf(<span style="color: fuchsia;">"Conncet OK</span><span style="color: slateblue;">/n</span><span style="color: fuchsia;">"</span>);<br /><span style="color: #804040;">27 </span><br /><span style="color: #804040;">28 </span>&nbsp;&nbsp;&nbsp;&nbsp;<strong><span style="color: #804040;">while</span></strong>&nbsp;( (n = read(sockfd, recvline, MAXLINE)) &gt; <span style="color: fuchsia;">0</span>) {<br /><span style="color: #804040;">29 </span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;recvline[n] = <span style="color: fuchsia;">0</span>;&nbsp;&nbsp;<span style="color: blue;">/*&nbsp;null terminate */</span><br /><span style="color: #804040;">30 </span><br /><span style="color: #804040;">31 </span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: blue;">/*&nbsp;&nbsp;change number string to number and to ip string */</span><br /><span style="color: #804040;">32 </span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong><span style="color: seagreen;">struct</span></strong>&nbsp;in_addr svraddr;<br /><span style="color: #804040;">33 </span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;svraddr.s_addr = strtoul(recvline, <span style="color: fuchsia;">NULL</span>, <span style="color: fuchsia;">10</span>);<br /><span style="color: #804040;">34 </span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong><span style="color: seagreen;">char</span></strong>&nbsp;*pszsvraddr = inet_ntoa(svraddr);<br /><span style="color: #804040;">35 </span><br /><span style="color: #804040;">36 </span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf(<span style="color: fuchsia;">"</span><span style="color: slateblue;">%s</span><span style="color: fuchsia;">:</span><span style="color: slateblue;">%s/n</span><span style="color: fuchsia;">"</span>, pszsvraddr, recvline);<br /><span style="color: #804040;">37 </span>&nbsp;&nbsp;&nbsp;&nbsp;}<br /><span style="color: #804040;">38 </span>&nbsp;&nbsp;&nbsp;&nbsp;<strong><span style="color: #804040;">if</span></strong>&nbsp;(n &lt; <span style="color: fuchsia;">0</span>)<br /><span style="color: #804040;">39 </span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;err_sys(<span style="color: fuchsia;">"read error"</span>);<br /><span style="color: #804040;">40 </span><br /><span style="color: #804040;">41 </span>&nbsp;&nbsp;&nbsp;&nbsp;exit(<span style="color: fuchsia;">0</span>);<br /><span style="color: #804040;">42 </span>}</span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt;"><span style='color: #a020f0; font-family: "Courier New"; mso-fareast-language: ZH-CN;' lang="EN-US"><span style="font-size: small;">&nbsp;</span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt; text-align: right;" align="right"><span lang="EN-US"><a href="http://www.jtianling.com"><span style="font-size: small;"><span style="color: #800080;"><strong><span style="letter-spacing: 0.25pt; font-variant: small-caps; mso-fareast-language: ZH-CN;"><span style="font-family: Calibri;">write by </span></span></strong><strong><span style="font-family: 宋体; letter-spacing: 0.25pt; font-variant: small-caps; mso-fareast-language: ZH-CN;" lang="EN-US"><span lang="EN-US">九天雁翎</span></span></strong><strong><span style="letter-spacing: 0.25pt; font-variant: small-caps; mso-fareast-language: ZH-CN;"><span style="font-family: Calibri;">(JTianLing) -- www.jtianling.com</span></span></strong></span></span></a></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt;"><span style="mso-fareast-language: ZH-CN;" lang="EN-US"><span style="font-size: small; font-family: Calibri;">&nbsp;</span></span></p>
