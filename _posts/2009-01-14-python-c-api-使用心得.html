---
layout: post
title: Python C API 使用心得
categories:
- Python
tags:
- C++
- Python
status: publish
type: post
published: true
meta:
  ratings_users: '0'
  ratings_score: '0'
  ratings_average: '0'
  views: '18'
author:
  login: jtianling
  email: jtianling@gmail.com
  display_name: jtianling
  first_name: ''
  last_name: ''
---

<p class="MsoTitle" style="margin: 12pt 0cm 3pt;"><strong><span style="font-size: large;"><span style="mso-font-kerning: 18.0pt; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA;" lang="EN-US"><span style="font-family: Cambria;">Python C API </span></span><span style="font-family: 宋体; mso-font-kerning: 18.0pt; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-ascii-font-family: Cambria; mso-ascii-theme-font: major-latin; mso-hansi-font-family: Cambria; mso-hansi-theme-font: major-latin;">使用心得</span><span style="mso-font-kerning: 18.0pt; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA;" lang="EN-US"></span></span></strong></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt; line-height: normal; text-align: right; mso-margin-top-alt: auto; mso-margin-bottom-alt: auto;" align="right"><span style="font-size: small;"><span style="text-decoration: underline;"><strong><span style="color: #c0504d; font-family: 宋体; letter-spacing: 0.25pt; font-variant: small-caps; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US">write by </span><span style="color: #c0504d; font-family: 宋体; letter-spacing: 0.25pt; font-variant: small-caps; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;">九天雁翎<span lang="EN-US">(JTianLing) -- www.jtianling.com</span></span></strong></span><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US"></span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt; line-height: normal; mso-margin-top-alt: auto; mso-margin-bottom-alt: auto;"><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US"><span style="font-size: small;">&nbsp;</span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt; line-height: normal; mso-margin-top-alt: auto; mso-margin-bottom-alt: auto;"><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;"><span style="font-size: small;">工作的变化简直和人生变化一样不可预知<span lang="EN-US">.</span>就在反外挂刚开始的时候，天天看的都是汇编和一大堆只有<span lang="EN-US">cracker(</span>或想称为<span lang="EN-US">cracker)</span>的人才会看的破解相关书籍，但是才过了几天，准备做被动的反外挂系统后，工作基本上就转到了用<span lang="EN-US">Python C API</span>来写扩展模块和用<span lang="EN-US">Python</span>来写<span lang="EN-US">Check</span>程序了，真是突然。<span lang="EN-US"></span></span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt; line-height: normal; mso-margin-top-alt: auto; mso-margin-bottom-alt: auto;"><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;"><span style="font-size: small;">想<span lang="EN-US">8</span>月份看完《<span lang="EN-US">Programming in LUA</span>》以后，对脚本语言重拾兴趣，后来断断续续也算把《<span lang="EN-US">Python</span>核心编程》，这本来是非常纯粹的<span lang="EN-US">Just for fun</span>的事情，最后确还是免不了染上工作的性质，呵呵，这样说好像很奇怪，应该是说，凭借着一点兴趣，花了很多业余时间去学习的<span lang="EN-US">Python</span>， 想不到竟然能这么快就在工作中有所应用与发挥，实话说，做老板的，肯定希望有这样的员工。。。。。何况，在老板心中我还算是新员工呢。我要是老板，我也希望做一个新东西前，本来说要调研调研的。。。。结果已经有员工用业余时间已经做过了，然后可以直接开工，唉。。。。我不知道碰到这样的情况我为什么会叹 气。。。。。。。<span lang="EN-US"></span></span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt; line-height: normal; mso-margin-top-alt: auto; mso-margin-bottom-alt: auto;"><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US"><span style="font-size: small;">&nbsp;</span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt; line-height: normal; mso-margin-top-alt: auto; mso-margin-bottom-alt: auto;"><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;"><span style="font-size: small;">其实以前学的主要是<span lang="EN-US">Python</span>语言的语法，用<span lang="EN-US">Python C API</span>来写扩展模块还真没有写过，要是用<span lang="EN-US">LUA</span>的话，虽然特别复杂，但是可能好歹还有个底。最后几乎是纯粹靠文档来解决了一切，（还有老总提供的一些没头没尾的例子）不要问我为什么不上网查，资料太少，而且在公司上网并不方便。<span lang="EN-US"></span></span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt; line-height: normal; mso-margin-top-alt: auto; mso-margin-bottom-alt: auto;"><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;"><span style="font-size: small;">这里总结一下，以防忘记（我并不准备详细记录下每个步骤，仅仅记要点，假如需要详细步骤的，请参看<span lang="EN-US">Python document</span>中的例子）<span lang="EN-US"></span></span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt; line-height: normal; mso-margin-top-alt: auto; mso-margin-bottom-alt: auto;"><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;"><span style="font-size: small;">一：用<span lang="EN-US">C API</span>为<span lang="EN-US">Python</span>写<span lang="EN-US">C</span>语言函数，以方便<span lang="EN-US">Python</span>中调用，这种方法还是很简单的，和<span lang="EN-US">LUA C API</span>的方法基本一样。（参看文档的<span lang="EN-US">Extending Python with C or C++</span>部分）<span lang="EN-US"></span></span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 0pt 18pt; text-indent: -18pt; line-height: normal; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;"><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US"><span style="font-size: small;">1.</span></span><span style='font-size: 7pt; font-family: "Times New Roman","serif"; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-fareast-font-family: 宋体;' lang="EN-US">&nbsp; </span><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;"><span style="font-size: small;">首先实现一个特定原型的函数，用<span lang="EN-US">Python C API</span>来实现的话，所有函数必须是这种原型。必须是类似这样的<span lang="EN-US"></span></span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 0pt; line-height: normal; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;"><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US"><span style="font-size: small;">PyObject *Fun(PyObject *self, PyObject *args)</span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt; line-height: normal; mso-margin-top-alt: auto; mso-margin-bottom-alt: auto;"><span style="font-size: small;"><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US">self</span><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;">应该是在用类的时候才会用到（我没有用到），<span lang="EN-US">args</span>就是函数的参数。因为<span lang="EN-US">args</span>是一个<span lang="EN-US">PyObject*</span>类型（可以代表<span lang="EN-US">Python</span>语言中的任何类型）<span lang="EN-US"></span></span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt 18pt; text-indent: -18pt; line-height: normal; mso-margin-top-alt: auto; mso-margin-bottom-alt: auto;"><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US"><span style="font-size: small;">2.</span></span><span style='font-size: 7pt; font-family: "Times New Roman","serif"; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 11.0pt; mso-fareast-font-family: 宋体;' lang="EN-US">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;"><span style="font-size: small;">将参数转换成<span lang="EN-US">C </span>语言表示的内容，用<span lang="EN-US">PyArg_ParseTuple</span>函数。<span lang="EN-US"></span></span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt 18pt; text-indent: -18pt; line-height: normal; mso-margin-top-alt: auto; mso-margin-bottom-alt: auto;"><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US"><span style="font-size: small;">3.</span></span><span style='font-size: 7pt; font-family: "Times New Roman","serif"; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 11.0pt; mso-fareast-font-family: 宋体;' lang="EN-US">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;"><span style="font-size: small;">执行完需要的操作后，也必须返回一个<span lang="EN-US">PyObject*</span>类型的值。通过<span lang="EN-US">Py_BuildValue</span>函数来构建。<span lang="EN-US"></span></span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt 18pt; line-height: normal; mso-margin-top-alt: auto; mso-margin-bottom-alt: auto;"><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;"><span style="font-size: small;">这里要说的是，假如希望返回一个<span lang="EN-US">Tuple</span>类型的值，可以先用<span lang="EN-US"></span></span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 0pt; line-height: normal; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;"><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US"><span style="font-size: small;">PyObject *tuple = Py_BuildValue("(iis)", 1, 2, "three");</span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 0pt; line-height: normal; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;"><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;"><span style="font-size: small;">形式来构建，假如很多的话，可以用下面的方式来构建<span lang="EN-US"></span></span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 0pt; line-height: normal; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;"><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US"><span style="font-size: small;">PyObject *t;</span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 0pt; line-height: normal; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;"><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US"><span style="font-size: small;">&nbsp;</span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 0pt; line-height: normal; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;"><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US"><span style="font-size: small;">t = PyTuple_New(3);</span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 0pt; line-height: normal; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;"><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US"><span style="font-size: small;">PyTuple_SetItem(t, 0, PyLong_FromLong(1L));</span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 0pt; line-height: normal; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;"><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US"><span style="font-size: small;">PyTuple_SetItem(t, 1, PyLong_FromLong(2L));</span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 0pt; line-height: normal; tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;"><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US"><span style="font-size: small;">PyTuple_SetItem(t, 2, PyString_FromString("three"));</span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt; line-height: normal; mso-margin-top-alt: auto; mso-margin-bottom-alt: auto;"><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;"><span style="font-size: small;">这一点在刚开始开工的时候迷惑了很久。<span lang="EN-US"></span></span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt 18pt; text-indent: -18pt; line-height: normal; mso-margin-top-alt: auto; mso-margin-bottom-alt: auto;"><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US"><span style="font-size: small;">4.</span></span><span style='font-size: 7pt; font-family: "Times New Roman","serif"; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-fareast-font-family: 宋体;' lang="EN-US">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;"><span style="font-size: small;">将要输出的所有函数放入一个数组中，数组的结构是：<span lang="EN-US"></span></span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 0pt; line-height: normal; mso-margin-top-alt: auto;"><span style="font-size: small;"><span style="color: blue; font-family: 新宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US">struct</span><span style="font-family: 新宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US"> <span style="color: #010001;">PyMethodDef</span> {</span><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US"></span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 0pt; line-height: normal; mso-margin-top-alt: auto;"><span style="font-size: small;"><span style="font-family: 新宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US">&nbsp;&nbsp;&nbsp; <span style="color: blue;">const</span> <span style="color: blue;">char</span>&nbsp;&nbsp;&nbsp; *<span style="color: #010001;">ml_name</span>;&nbsp; <span style="color: green;">/* The name of the built-in function/method */</span></span><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US"></span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 0pt; line-height: normal; mso-margin-top-alt: auto;"><span style="font-size: small;"><span style="font-family: 新宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US">&nbsp;&nbsp;&nbsp; <span style="color: #010001;">PyCFunction</span>&nbsp; <span style="color: #010001;">ml_meth</span>;&nbsp;&nbsp; <span style="color: green;">/* The C function that implements it */</span></span><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US"></span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 0pt; line-height: normal; mso-margin-top-alt: auto;"><span style="font-size: small;"><span style="font-family: 新宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US">&nbsp;&nbsp;&nbsp; <span style="color: blue;">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #010001;">ml_flags</span>; <span style="color: green;">/* Combination of METH_xxx flags, which mostly</span></span><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US"></span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 0pt; line-height: normal; mso-margin-top-alt: auto;"><span style="font-size: small;"><span style="color: green; font-family: 新宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp; describe the args expected by the C func */</span><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US"></span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 0pt; line-height: normal; mso-margin-top-alt: auto;"><span style="font-size: small;"><span style="font-family: 新宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US">&nbsp;&nbsp;&nbsp; <span style="color: blue;">const</span> <span style="color: blue;">char</span>&nbsp;&nbsp;&nbsp; *<span style="color: #010001;">ml_doc</span>;&nbsp;&nbsp; <span style="color: green;">/* The __doc__ attribute, or NULL */</span></span><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US"></span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt 18pt; line-height: normal; mso-margin-top-alt: auto; mso-margin-bottom-alt: auto;"><span style="font-size: small;"><span style="font-family: 新宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US">};</span><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US"></span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt; line-height: normal; mso-margin-top-alt: auto; mso-margin-bottom-alt: auto;"><span style="font-size: small;"><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;">数组以</span><span style="font-family: 新宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US">{<span style="color: #010001;">NULL</span>, <span style="color: #010001;">NULL</span>}</span><span style="font-family: 新宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;">结束</span><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US"></span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt 18pt; text-indent: -18pt; line-height: normal; mso-margin-top-alt: auto; mso-margin-bottom-alt: auto;"><span style="font-family: 新宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US"><span style="font-size: small;">5.</span></span><span style='font-size: 7pt; font-family: "Times New Roman","serif"; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-fareast-font-family: 新宋体;' lang="EN-US">&nbsp; </span><span style="font-size: small;"><span style="font-family: 新宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;">构造一个<span lang="EN-US">Python import</span>时初始化的函数</span><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US"></span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 0pt; line-height: normal; mso-margin-top-alt: auto;"><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;"><span style="font-size: small;">类似<span lang="EN-US"></span></span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 0pt; line-height: normal; mso-margin-top-alt: auto;"><span style="font-size: small;"><span style="color: #010001; font-family: 新宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US">PyMODINIT_FUNC</span><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US"></span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 0pt; line-height: normal; mso-margin-top-alt: auto;"><span style="font-size: small;"><span style="color: #010001; font-family: 新宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US">initexample</span><span style="font-family: 新宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US">(<span style="color: blue;">void</span>)</span><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US"></span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 0pt; line-height: normal; mso-margin-top-alt: auto;"><span style="font-size: small;"><span style="font-family: 新宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US">{</span><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US"></span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 0pt; line-height: normal; mso-margin-top-alt: auto;"><span style="font-size: small;"><span style="font-family: 新宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US">&nbsp;&nbsp;&nbsp; <span style="color: #010001;">Py_InitModule</span>(<span style="color: #a31515;">"example"</span>, <span style="color: #010001;">example_methods</span>);</span><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US"></span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt; line-height: normal; mso-margin-top-alt: auto; mso-margin-bottom-alt: auto;"><span style="font-size: small;"><span style="font-family: 新宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US">}</span><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US"></span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt; line-height: normal; mso-margin-top-alt: auto; mso-margin-bottom-alt: auto;"><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;"><span style="font-size: small;">这里有个特别需要注意的是，初始化函数名字有严格要求，<span lang="EN-US">init</span>后面必须跟模块名，否则<span lang="EN-US">Python</span>找不到确定的函数会报没有初始化函数的错误<span lang="EN-US"></span></span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt; line-height: normal; mso-margin-top-alt: auto; mso-margin-bottom-alt: auto;"><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US"><span style="font-size: small;">&nbsp;</span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt; line-height: normal; mso-margin-top-alt: auto; mso-margin-bottom-alt: auto;"><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;"><span style="font-size: small;">总结一下，记得第一次学习<span lang="EN-US">LUA C API</span>接口的时候，碰到类似的扩展模块写法，还是感觉很奇怪，&ldquo;怎么搞这么复杂啊&rdquo;。。。。。当时为了实现一个简单的扩展都是折腾了很久，到了再一次碰到类似的问题，（<span lang="EN-US">Python C API</span>写扩展的时候几乎就是和<span lang="EN-US">LUA C API</span>一样），基本已经轻车熟路了。这里突然也想说一句，就算不是真的写非常底层的接口，但是用的接口多了，都是能有些感觉的。<span lang="EN-US"></span></span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt; line-height: normal; mso-margin-top-alt: auto; mso-margin-bottom-alt: auto;"><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US"><span style="font-size: small;">&nbsp;</span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt; line-height: normal; mso-margin-top-alt: auto; mso-margin-bottom-alt: auto;"><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;"><span style="font-size: small;">扩展模块写完后，编译成动态库（<span lang="EN-US">Python</span>要求此动态库名字为<span lang="EN-US">pyd,</span>实际就是改个后缀而已）。就可以直接在<span lang="EN-US">Python</span>脚本中用<span lang="EN-US">import</span>的方式加载了，对于使用来说，根本不需要知道此库是用<span lang="EN-US">C API</span>扩展写的还是直接用<span lang="EN-US">Python</span>语句写的（这点<span lang="EN-US">Lua</span>做的也是一样好）<span lang="EN-US"></span></span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt; line-height: normal; mso-margin-top-alt: auto; mso-margin-bottom-alt: auto;"><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;"><span style="font-size: small;">最后，<span lang="EN-US">python</span>的源代码中附带了一个叫做<span lang="EN-US">example_nt</span>的例子，可以参考一样，完整的扩展代码如下：<span lang="EN-US"></span></span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 0pt; line-height: normal; mso-margin-top-alt: auto;"><span style="font-size: small;"><span style="color: blue; font-family: 新宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US">#include</span><span style="font-family: 新宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US"> <span style="color: #a31515;">"Python.h"</span></span><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US"></span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 0pt; line-height: normal; mso-margin-top-alt: auto;"><span style="font-size: small;"><span style="color: #a31515; font-family: 新宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US">&nbsp;</span><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US"></span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 0pt; line-height: normal; mso-margin-top-alt: auto;"><span style="font-size: small;"><span style="color: blue; font-family: 新宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US">static</span><span style="font-family: 新宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US"> <span style="color: #010001;">PyObject</span> *</span><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US"></span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 0pt; line-height: normal; mso-margin-top-alt: auto;"><span style="font-size: small;"><span style="color: #010001; font-family: 新宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US">ex_foo</span><span style="font-family: 新宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US">(<span style="color: #010001;">PyObject</span> *<span style="color: #010001;">self</span>, <span style="color: #010001;">PyObject</span> *<span style="color: #010001;">args</span>)</span><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US"></span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 0pt; line-height: normal; mso-margin-top-alt: auto;"><span style="font-size: small;"><span style="font-family: 新宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US">{</span><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US"></span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 0pt; line-height: normal; mso-margin-top-alt: auto;"><span style="font-size: small;"><span style="font-family: 新宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US">&nbsp;&nbsp;&nbsp; <span style="color: #010001;">printf</span>(<span style="color: #a31515;">"Hello, world/n"</span>);</span><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US"></span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 0pt; line-height: normal; mso-margin-top-alt: auto;"><span style="font-size: small;"><span style="font-family: 新宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US">&nbsp;&nbsp;&nbsp; <span style="color: #010001;">Py_INCREF</span>(<span style="color: #010001;">Py_None</span>);</span><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US"></span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 0pt; line-height: normal; mso-margin-top-alt: auto;"><span style="font-size: small;"><span style="font-family: 新宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US">&nbsp;&nbsp;&nbsp; <span style="color: blue;">return</span> <span style="color: #010001;">Py_None</span>;</span><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US"></span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 0pt; line-height: normal; mso-margin-top-alt: auto;"><span style="font-size: small;"><span style="font-family: 新宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US">}</span><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US"></span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 0pt; line-height: normal; mso-margin-top-alt: auto;"><span style="font-size: small;"><span style="font-family: 新宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US">&nbsp;</span><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US"></span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 0pt; line-height: normal; mso-margin-top-alt: auto;"><span style="font-size: small;"><span style="color: blue; font-family: 新宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US">static</span><span style="font-family: 新宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US"> <span style="color: #010001;">PyMethodDef</span> <span style="color: #010001;">example_methods</span>[] = {</span><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US"></span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 0pt; line-height: normal; mso-margin-top-alt: auto;"><span style="font-size: small;"><span style="font-family: 新宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US">&nbsp;&nbsp;&nbsp; {<span style="color: #a31515;">"foo"</span>, <span style="color: #010001;">ex_foo</span>, <span style="color: #010001;">METH_VARARGS</span>, <span style="color: #a31515;">"foo() doc string"</span>},</span><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US"></span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 0pt; line-height: normal; mso-margin-top-alt: auto;"><span style="font-size: small;"><span style="font-family: 新宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US">&nbsp;&nbsp;&nbsp; {<span style="color: #010001;">NULL</span>, <span style="color: #010001;">NULL</span>}</span><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US"></span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 0pt; line-height: normal; mso-margin-top-alt: auto;"><span style="font-size: small;"><span style="font-family: 新宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US">};</span><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US"></span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 0pt; line-height: normal; mso-margin-top-alt: auto;"><span style="font-size: small;"><span style="font-family: 新宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US">&nbsp;</span><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US"></span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 0pt; line-height: normal; mso-margin-top-alt: auto;"><span style="font-size: small;"><span style="color: #010001; font-family: 新宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US">PyMODINIT_FUNC</span><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US"></span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 0pt; line-height: normal; mso-margin-top-alt: auto;"><span style="font-size: small;"><span style="color: #010001; font-family: 新宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US">initexample</span><span style="font-family: 新宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US">(<span style="color: blue;">void</span>)</span><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US"></span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 0pt; line-height: normal; mso-margin-top-alt: auto;"><span style="font-size: small;"><span style="font-family: 新宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US">{</span><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US"></span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 0pt; line-height: normal; mso-margin-top-alt: auto;"><span style="font-size: small;"><span style="font-family: 新宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US">&nbsp;&nbsp;&nbsp; <span style="color: #010001;">Py_InitModule</span>(<span style="color: #a31515;">"example"</span>, <span style="color: #010001;">example_methods</span>);</span><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US"></span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 0pt; line-height: normal; mso-margin-top-alt: auto;"><span style="font-size: small;"><span style="font-family: 新宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US">}</span><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US"></span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt; line-height: normal; mso-margin-top-alt: auto; mso-margin-bottom-alt: auto;"><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US"><span style="font-size: small;">&nbsp;</span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt; line-height: normal; mso-margin-top-alt: auto; mso-margin-bottom-alt: auto;"><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US"><span style="font-size: small;">&nbsp;</span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt; line-height: normal; mso-margin-top-alt: auto; mso-margin-bottom-alt: auto;"><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;"><span style="font-size: small;">二．<span lang="EN-US">C</span>语言中调用<span lang="EN-US">Python</span>语句<span lang="EN-US"></span></span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt; line-height: normal; mso-margin-top-alt: auto; mso-margin-bottom-alt: auto;"><span style="font-size: small;"><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;">首先，<span lang="EN-US">void </span></span><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-family: 宋体;" lang="EN-US">Py_Initialize</span><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US">()</span><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;">用来初始化，<span lang="EN-US">void </span></span><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-family: 宋体;" lang="EN-US">Py_Finalize</span><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US">()</span><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;">用来结束<span lang="EN-US">Python</span>的调用，这是必须要的。<span lang="EN-US"></span></span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt; line-height: normal; mso-margin-top-alt: auto; mso-margin-bottom-alt: auto;"><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;"><span style="font-size: small;">燃火分两种情况，假如仅仅是几条语句的话，那么以<span lang="EN-US">PyRun_</span>为前缀的一些函数都很好用，比如<span lang="EN-US"></span></span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt; line-height: normal; mso-margin-top-alt: auto; mso-margin-bottom-alt: auto;"><span style="font-size: small;"><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US">int </span><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-family: 宋体;" lang="EN-US">PyRun_SimpleString</span><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US">(const char</span><em><span style="mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-ascii-font-family: Calibri; mso-hansi-font-family: Calibri; mso-bidi-font-size: 12.0pt; mso-fareast-font-family: 宋体; mso-bidi-font-family: 宋体;" lang="EN-US"><span style="font-family: Calibri;"> *command</span></span></em><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US">)</span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt; line-height: normal; mso-margin-top-alt: auto; mso-margin-bottom-alt: auto;"><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;"><span style="font-size: small;">函数就可以直接执行一条<span lang="EN-US">char*</span>的<span lang="EN-US">Python</span>语句。<span lang="EN-US"></span></span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt; line-height: normal; mso-margin-top-alt: auto; mso-margin-bottom-alt: auto;"><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;"><span style="font-size: small;">需要获得返回值得话<span lang="EN-US"></span></span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt; line-height: normal; mso-margin-top-alt: auto; mso-margin-bottom-alt: auto;"><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US"><span style="font-size: small;">PyObject* PyRun_String(const char *str, int start, PyObject *globals, PyObject *locals)</span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt; line-height: normal; mso-margin-top-alt: auto; mso-margin-bottom-alt: auto;"><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;"><span style="font-size: small;">也很好用，以上两个函数用来处理<span lang="EN-US">Python</span>源代码已经读入内存的情况，在文件中的时候<span lang="EN-US"></span></span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt; line-height: normal; mso-margin-top-alt: auto; mso-margin-bottom-alt: auto;"><span style="font-size: small;"><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US">int </span><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-family: 宋体;" lang="EN-US">PyRun_SimpleFile</span><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US">(FILE</span><em><span style="mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-ascii-font-family: Calibri; mso-hansi-font-family: Calibri; mso-bidi-font-size: 12.0pt; mso-fareast-font-family: 宋体; mso-bidi-font-family: 宋体;" lang="EN-US"><span style="font-family: Calibri;"> *fp</span></span></em><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US">, const char</span><em><span style="mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-ascii-font-family: Calibri; mso-hansi-font-family: Calibri; mso-bidi-font-size: 12.0pt; mso-fareast-font-family: 宋体; mso-bidi-font-family: 宋体;" lang="EN-US"><span style="font-family: Calibri;"> *filename</span></span></em><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US">)</span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt; line-height: normal; mso-margin-top-alt: auto; mso-margin-bottom-alt: auto;"><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US"><span style="font-size: small;">PyObject* PyRun_File(FILE *fp, const char *filename, int start, PyObject *globals, PyObject *locals)</span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt; line-height: normal; mso-margin-top-alt: auto; mso-margin-bottom-alt: auto;"><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;"><span style="font-size: small;">使用类似。不多讲了。<span lang="EN-US"></span></span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt; line-height: normal; mso-margin-top-alt: auto; mso-margin-bottom-alt: auto;"><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;"><span style="font-size: small;">假如是个模块的话（比如一个函数），希望在<span lang="EN-US">C</span>语言中调用的话那么使用起来就稍微复杂了一点。这种情况的需要在于你可以从<span lang="EN-US">C</span>语言中向<span lang="EN-US">Python</span>函数中传入参数并且执行，然后获取结果。<span lang="EN-US"></span></span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt; line-height: normal; mso-margin-top-alt: auto; mso-margin-bottom-alt: auto;"><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;"><span style="font-size: small;">此处又分为几种情况：<span lang="EN-US"></span></span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt; line-height: normal; mso-margin-top-alt: auto; mso-margin-bottom-alt: auto;"><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;"><span style="font-size: small;">在文件中，在内存中，编译过的，源代码。<span lang="EN-US"></span></span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt; line-height: normal; mso-margin-top-alt: auto; mso-margin-bottom-alt: auto;"><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;"><span style="font-size: small;">在文件中都很好解决，和上面一样。这里主要讲在内存中的情况。（事实上我工作中需要并且耗费了很长时间才找到解决方法的就是这种情况）<span lang="EN-US"></span></span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt; line-height: normal; mso-margin-top-alt: auto; mso-margin-bottom-alt: auto;"><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;"><span style="font-size: small;">未编译时：（也就是源代码）<span lang="EN-US"></span></span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt; line-height: normal; mso-margin-top-alt: auto; mso-margin-bottom-alt: auto;"><span style="font-size: small;"><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US">1.</span><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;">通过<span lang="EN-US"></span></span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt; line-height: normal; mso-margin-top-alt: auto; mso-margin-bottom-alt: auto;"><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US"><span style="font-size: small;">PyObject* Py_CompileString(const char *str, const char *filename, int start)</span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt; line-height: normal; mso-margin-top-alt: auto; mso-margin-bottom-alt: auto;"><span style="font-size: small;"><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US">API</span><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;">首先编译一次。此<span lang="EN-US">API</span>的参数我说明一下，<span lang="EN-US">str</span>就是内存中的源代码，<span lang="EN-US">filename</span>主要是出错时报错误用的，事实测试证明，你随意给个字符串也没有关系，但给<span lang="EN-US">NULL</span>参数在运行时必然报错。<span lang="EN-US">start</span>我一般用的是</span><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-family: 宋体;" lang="EN-US">Py_file_input</span><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-family: 宋体;">，因为的确是从文件中读取过来的，相对的还有<span lang="EN-US">Py_single_input</span>用来表示一条语句，<span lang="EN-US">Py_eval_input</span>的用法我也不是太清楚。</span><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US"></span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt; line-height: normal; mso-margin-top-alt: auto; mso-margin-bottom-alt: auto;"><span style="font-size: small;"><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-family: 宋体;">源代码通过此函数调用后，获得编译后的<span lang="EN-US">PyObject*,</span>（其实假如跟进源代码中去看，是一个<span lang="EN-US">PyCodeObject</span>结构）假设命名为<span lang="EN-US">lpCode</span>。</span><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US"></span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt; line-height: normal; mso-margin-top-alt: auto; mso-margin-bottom-alt: auto;"><span style="font-size: small;"><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-family: 宋体;" lang="EN-US">2.</span><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-family: 宋体;">此时再调用<span lang="EN-US">API</span></span><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US"></span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt; line-height: normal; mso-margin-top-alt: auto; mso-margin-bottom-alt: auto;"><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US"><span style="font-size: small;">PyObject* PyImport_ExecCodeModule(char *name, PyObject *co)</span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt; line-height: normal; mso-margin-top-alt: auto; mso-margin-bottom-alt: auto;"><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;"><span style="font-size: small;">导入模块。参数也说明一下，<span lang="EN-US">name</span>为导入的模块名，<span lang="EN-US">co</span>就是前面编译过的代码对象（<span lang="EN-US">lpCode</span>）。返回的就是模块对象了，假设命名为<span lang="EN-US">lpMod</span>。<span lang="EN-US"></span></span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt; line-height: normal; mso-margin-top-alt: auto; mso-margin-bottom-alt: auto;"><span style="font-size: small;"><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US">3.</span><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;">再调用<span lang="EN-US">API</span></span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt; line-height: normal; mso-margin-top-alt: auto; mso-margin-bottom-alt: auto;"><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US"><span style="font-size: small;">PyObject* PyObject_GetAttrString(PyObject *o, const char *attr_name)</span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt; line-height: normal; mso-margin-top-alt: auto; mso-margin-bottom-alt: auto;"><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;"><span style="font-size: small;">获得函数对象。<span lang="EN-US">o</span>就是模块对象（<span lang="EN-US">lpMod</span>）<span lang="EN-US">,attr_name</span>就是你想要调用的函数名了，假设叫<span lang="EN-US">main</span>的函数，就是<span lang="EN-US">&rdquo;main&rdquo;</span>，然后返回的就是函数对象，假设命名为<span lang="EN-US">lpFun</span>。<span lang="EN-US"></span></span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt; line-height: normal; mso-margin-top-alt: auto; mso-margin-bottom-alt: auto;"><span style="font-size: small;"><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US">4.</span><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;">此时可以用<span lang="EN-US">API</span></span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt; line-height: normal; mso-margin-top-alt: auto; mso-margin-bottom-alt: auto;"><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US"><span style="font-size: small;">int PyCallable_Check(PyObject *o)</span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt; line-height: normal; mso-margin-top-alt: auto; mso-margin-bottom-alt: auto;"><span style="font-size: 13.5pt; font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-family: 宋体;">去检查一下是不是获得了一个函数。假如确定的话，就可以直接用</span><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US"></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt; line-height: normal; mso-margin-top-alt: auto; mso-margin-bottom-alt: auto;"><span style="font-size: small;"><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-family: 宋体;" lang="EN-US">PyObject_Call</span><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-family: 宋体;">开头的一族函数调用<span lang="EN-US">lpFun</span>了。这些函数包括很多，一般就是输入参数的不同，但是效果都是一样的，就是调用函数而已。参数一般可以通过前面说过的<span lang="EN-US">build</span>函数来获得，返回值也是获得一个<span lang="EN-US">PyObject*,</span>可以通过<span lang="EN-US">PyArg_</span>那个函数来获取，但是好像不太好，那是分析参数用的。推荐用确定类型（假设为<span lang="EN-US">type</span>）的类似<span lang="EN-US">Py[type]_As</span>的函数来获取。</span><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US"></span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt; line-height: normal; mso-margin-top-alt: auto; mso-margin-bottom-alt: auto;"><span style="font-size: small;"><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-family: 宋体;">比如：</span><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US"></span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt; line-height: normal; mso-margin-top-alt: auto; mso-margin-bottom-alt: auto;"><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US"><span style="font-size: small;">long PyLong_AsLong(</span><a title="PyObject" href="http://mk:@MSITStoreD:%5CPython30%5CDoc%5Cpython30.chm::"><span style="color: windowtext; text-decoration: none; text-underline: none;"><span style="font-size: small;">PyObject</span></span></a><span style="font-size: small;"> *pylong)</span></span><span style="font-size: 13.5pt; font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-family: 宋体;">获取<span lang="EN-US">long</span></span><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US"></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt; line-height: normal; mso-margin-top-alt: auto; mso-margin-bottom-alt: auto;"><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US"><span style="font-size: small;">double PyLong_AsDouble(</span><a title="PyObject" href="http://mk:@MSITStoreD:%5CPython30%5CDoc%5Cpython30.chm::"><span style="color: windowtext; text-decoration: none; text-underline: none;"><span style="font-size: small;">PyObject</span></span></a><span style="font-size: small;"> *pylong)</span></span><span style="font-size: 13.5pt; font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-family: 宋体;">获取<span lang="EN-US">double</span></span><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US"></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt; line-height: normal; mso-margin-top-alt: auto; mso-margin-bottom-alt: auto;"><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US"><span style="font-size: small;">&nbsp;</span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt; line-height: normal; mso-margin-top-alt: auto; mso-margin-bottom-alt: auto;"><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;"><span style="font-size: small;">这里想说的是，应该有直接从源代码中获取函数调用对象的方式，但是我本人没有试出来，有人知道请一定赐教！<span lang="EN-US"></span></span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt; line-height: normal; mso-margin-top-alt: auto; mso-margin-bottom-alt: auto;"><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US"><span style="font-size: small;">&nbsp;</span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt; line-height: normal; mso-margin-top-alt: auto; mso-margin-bottom-alt: auto;"><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;"><span style="font-size: small;">编译过的代码：<span lang="EN-US"></span></span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt; line-height: normal; mso-margin-top-alt: auto; mso-margin-bottom-alt: auto;"><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;"><span style="font-size: small;">对于编译过的代码和上面就是获得编译后的<span lang="EN-US">PyCodeObject</span>对象<span lang="EN-US">,</span>当然在源代码中表示还是<span lang="EN-US">PyObject*</span>的方法不同（上例中的<span lang="EN-US">lpCode</span>）。<span lang="EN-US"></span></span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt; line-height: normal; mso-margin-top-alt: auto; mso-margin-bottom-alt: auto;"><span style="font-size: 13.5pt; font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-family: 宋体;">当然要想以后获得一个编译后的<span lang="EN-US">lpCode,</span>自然要先编译一下啦。但是纯粹编译成<span lang="EN-US">pyc</span>结尾的文件后，直接读入内存，我没有找到将其转化为<span lang="EN-US">PyCodeObject</span>对象的方法（也希望有人知道能告诉我！）</span><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US"></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt; line-height: normal; mso-margin-top-alt: auto; mso-margin-bottom-alt: auto;"><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US"><span style="font-size: small;">&nbsp;</span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt; line-height: normal; mso-margin-top-alt: auto; mso-margin-bottom-alt: auto;"><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;"><span style="font-size: small;">我找到的方法是先用<span lang="EN-US"></span></span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt; line-height: normal; mso-margin-top-alt: auto; mso-margin-bottom-alt: auto;"><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US"><span style="font-size: small;">PyObject* PyMarshal_WriteObjectToString(PyObject *value, int version)</span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt; line-height: normal; mso-margin-top-alt: auto; mso-margin-bottom-alt: auto;"><span style="font-size: small;"><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US">void </span><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-family: 宋体;" lang="EN-US">PyMarshal_WriteLongToFile</span></span><span style="font-size: 13.5pt; font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-family: 宋体;" lang="EN-US">(</span><span style="font-size: small;"><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US">long</span><em><span style="mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-ascii-font-family: Calibri; mso-hansi-font-family: Calibri; mso-bidi-font-size: 12.0pt; mso-fareast-font-family: 宋体; mso-bidi-font-family: 宋体;" lang="EN-US"><span style="font-family: Calibri;"> value</span></span></em><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US">, FILE</span><em><span style="mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-ascii-font-family: Calibri; mso-hansi-font-family: Calibri; mso-bidi-font-size: 12.0pt; mso-fareast-font-family: 宋体; mso-bidi-font-family: 宋体;" lang="EN-US"><span style="font-family: Calibri;"> *file</span></span></em><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US">, int</span><em><span style="mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-ascii-font-family: Calibri; mso-hansi-font-family: Calibri; mso-bidi-font-size: 12.0pt; mso-fareast-font-family: 宋体; mso-bidi-font-family: 宋体;" lang="EN-US"><span style="font-family: Calibri;"> version</span></span></em></span><span style="font-size: 13.5pt; font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-family: 宋体;" lang="EN-US">)</span><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US"></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt; line-height: normal; mso-margin-top-alt: auto; mso-margin-bottom-alt: auto;"><span style="font-size: 13.5pt; font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-family: 宋体;">两个函数先把<span lang="EN-US">PyCodeObject</span>对象<span lang="EN-US">(lpCode)</span>序列化到文件或者内存中。</span><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US"></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt; line-height: normal; mso-margin-top-alt: auto; mso-margin-bottom-alt: auto;"><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;"><span style="font-size: small;">再在需要的时候用函数<span lang="EN-US"></span></span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt; line-height: normal; mso-margin-top-alt: auto; mso-margin-bottom-alt: auto;"><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US"><span style="font-size: small;">PyObject* PyMarshal_ReadObjectFromFile(FILE *file)</span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt; line-height: normal; mso-margin-top-alt: auto; mso-margin-bottom-alt: auto;"><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US"><span style="font-size: small;">PyObject* PyMarshal_ReadObjectFromString(char *string, Py_ssize_t len)</span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt; line-height: normal; mso-margin-top-alt: auto; mso-margin-bottom-alt: auto;"><span style="font-size: 13.5pt; font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-family: 宋体;">读出来，读出来的<span lang="EN-US">PyObject*</span>其实就是想要的<span lang="EN-US">PyCodeObject</span>对象了<span lang="EN-US">(lpCode)</span>。接下来的步骤与未编译时的步骤一样。</span><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US"></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt; line-height: normal; mso-margin-top-alt: auto; mso-margin-bottom-alt: auto;"><span style="font-size: 13.5pt; font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-family: 宋体;">光是这个扭曲的方法我还是参考老总给的半边资料反复研究出来的。而真正直接有效的方法我还是没有找到。</span><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US"></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt; line-height: normal; mso-margin-top-alt: auto; mso-margin-bottom-alt: auto;"><span style="font-size: 13.5pt; font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-family: 宋体;" lang="EN-US">&nbsp;</span><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US"></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt; line-height: normal; mso-margin-top-alt: auto; mso-margin-bottom-alt: auto;"><span style="font-size: 13.5pt; font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-family: 宋体;">我希望能解决的问题我总结一下，有<span lang="EN-US">2</span>个</span><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US"></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt 18pt; text-indent: -18pt; line-height: normal; mso-margin-top-alt: auto; mso-margin-bottom-alt: auto;"><span style="font-size: 13.5pt; font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-family: 宋体;" lang="EN-US">1.</span><span style='font-size: 7pt; font-family: "Times New Roman","serif"; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-fareast-font-family: 宋体;' lang="EN-US">&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size: 13.5pt; font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-family: 宋体;">直接从源代码中读入，转成模块对象（<span lang="EN-US">lpMod</span>），而不需要先通过</span><span style="font-size: small;"><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US">Py_CompileString</span><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;">的调用。<span lang="EN-US"></span></span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt 18pt; text-indent: -18pt; line-height: normal; mso-margin-top-alt: auto; mso-margin-bottom-alt: auto;"><span style="font-size: 13.5pt; font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-family: 宋体;" lang="EN-US">2.</span><span style='font-size: 7pt; font-family: "Times New Roman","serif"; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-fareast-font-family: 宋体;' lang="EN-US">&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;"><span style="font-size: small;">直接从<span lang="EN-US">pyc</span>文件（内存）中</span></span><span style="font-size: 13.5pt; font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-family: 宋体;">读入，转成代码对象<span lang="EN-US">(lpCode)</span>或者模块对象（<span lang="EN-US">lpMod</span>），扭曲的通过序列化<span lang="EN-US">PyCodeObject</span>对象再序列化出来的方式。</span><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US"></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt; line-height: normal; mso-margin-top-alt: auto; mso-margin-bottom-alt: auto;"><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US"><span style="font-size: small;">&nbsp;</span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt; line-height: normal; mso-margin-top-alt: auto; mso-margin-bottom-alt: auto;"><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;"><span style="font-size: small;">希望我从文档中摸索出来的东西对于有些同样需要的人有价值。这一些方法我在网上也找到，但是没有找到，最后还是靠自己摸索才找出了一些扭曲的方式来解决问题。<span lang="EN-US"></span></span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt; line-height: normal; mso-margin-top-alt: auto; mso-margin-bottom-alt: auto;"><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;"><span style="font-size: small;">这里想对那些动不动就说你想把文档都看看的，你先把什么都看仔细了的兄弟们说一下，并不是每个老板都允许员工干一件事情前去把一种新的语言全学精了，哪怕他明知道这就是一种你不知道的语言。有的时候，<span lang="EN-US">just for work</span>而 已。当然，在有时间的时候，自然我也是想把该学的都好好学了，只是，工作的时候，身不由己啊，何况，该学的东西是很多的，个人也可能有个人的学习计划，并不是工作中碰到一种问题，我的业余时间也得全部搭上去，把这件事情学通，所以请多给一些谅解，碰到有人问对你来说很初级的问题时，你好心的就给个回答，我 很感谢，不想回答的起码也不要说风凉话，我也很感谢了。其实我倒是也没有真发帖去问，因为等到有人回答估计一天的工作时间都耽误了，只是看到有类似的情况，所以随便说说，希望不要见怪。<span lang="EN-US"></span></span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt; line-height: normal; mso-margin-top-alt: auto; mso-margin-bottom-alt: auto;"><span style="font-size: small;"><span style='color: #a020f0; font-family: "Courier New"; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-fareast-font-family: 宋体;' lang="EN-US">&nbsp;</span><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US"></span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt; line-height: normal; mso-margin-top-alt: auto; mso-margin-bottom-alt: auto;"><span style="font-size: small;"><span style='color: #a020f0; font-family: "Courier New"; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-fareast-font-family: 宋体;' lang="EN-US">&nbsp;</span><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US"></span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt; line-height: normal; text-align: right; mso-margin-top-alt: auto; mso-margin-bottom-alt: auto;" align="right"><span style="font-size: small;"><strong><span style="text-decoration: underline;"><span style="color: #c0504d; font-family: 宋体; letter-spacing: 0.25pt; font-variant: small-caps; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US">write by </span></span></strong><strong><span style="text-decoration: underline;"><span style="color: #c0504d; font-family: 宋体; letter-spacing: 0.25pt; font-variant: small-caps; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;">九天雁翎<span lang="EN-US">(JTianLing) -- www.jtianling.com</span></span></span></strong><span style="font-family: 宋体; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA; mso-bidi-font-size: 12.0pt; mso-bidi-font-family: 宋体;" lang="EN-US"></span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 10pt;"><span style="mso-fareast-language: ZH-CN;" lang="EN-US"><span style="font-size: small; font-family: Calibri;">&nbsp;</span></span></p>
